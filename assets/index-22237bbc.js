var uo=Object.defineProperty;var fo=(r,e,t)=>e in r?uo(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var P=(r,e,t)=>(fo(r,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();function Ir(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function Zr(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function po(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Ir(r.outputLen),Ir(r.blockLen)}function rt(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function yo(r,e){Zr(r);const t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}const kt=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const Yr=r=>r instanceof Uint8Array,Rt=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),te=(r,e)=>r<<32-e|r>>>e,go=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!go)throw new Error("Non little-endian hardware is not supported");function mo(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Wt(r){if(typeof r=="string"&&(r=mo(r)),!Yr(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function bo(...r){const e=new Uint8Array(r.reduce((n,s)=>n+s.length,0));let t=0;return r.forEach(n=>{if(!Yr(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}let Xr=class{clone(){return this._cloneInto()}};function vo(r){const e=n=>r().update(Wt(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Qr(r=32){if(kt&&typeof kt.getRandomValues=="function")return kt.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function wo(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+l,a,n)}let Eo=class extends Xr{constructor(e,t,n,s){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Rt(this.buffer)}update(e){rt(this);const{view:t,buffer:n,blockLen:s}=this;e=Wt(e);const o=e.length;for(let i=0;i<o;){const a=Math.min(s-this.pos,o-i);if(a===s){const c=Rt(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){rt(this),yo(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:o}=this;let{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>s-i&&(this.process(n,0),i=0);for(let u=i;u<s;u++)t[u]=0;wo(n,s-8,BigInt(this.length*8),o),this.process(n,0);const a=Rt(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<l;u++)a.setUint32(4*u,h[u],o)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.length=s,e.pos=a,e.finished=o,e.destroyed=i,s%t&&e.buffer.set(n),e}};const So=(r,e,t)=>r&e^~r&t,xo=(r,e,t)=>r&e^r&t^e&t,ko=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),ye=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),ge=new Uint32Array(64);let Ro=class extends Eo{constructor(){super(64,32,8,!1),this.A=ye[0]|0,this.B=ye[1]|0,this.C=ye[2]|0,this.D=ye[3]|0,this.E=ye[4]|0,this.F=ye[5]|0,this.G=ye[6]|0,this.H=ye[7]|0}get(){const{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let u=0;u<16;u++,t+=4)ge[u]=e.getUint32(t,!1);for(let u=16;u<64;u++){const p=ge[u-15],b=ge[u-2],g=te(p,7)^te(p,18)^p>>>3,d=te(b,17)^te(b,19)^b>>>10;ge[u]=d+ge[u-7]+g+ge[u-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:l,H:h}=this;for(let u=0;u<64;u++){const p=te(a,6)^te(a,11)^te(a,25),b=h+p+So(a,c,l)+ko[u]+ge[u]|0,d=(te(n,2)^te(n,13)^te(n,22))+xo(n,s,o)|0;h=l,l=c,c=a,a=i+b|0,i=o,o=s,s=n,n=b+d|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,o,i,a,c,l,h)}roundClean(){ge.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};const Dt=vo(()=>new Ro);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const en=BigInt(0),ct=BigInt(1),Po=BigInt(2),lt=r=>r instanceof Uint8Array,No=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function Be(r){if(!lt(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=No[r[t]];return e}function tn(r){const e=r.toString(16);return e.length&1?`0${e}`:e}function Jt(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);return BigInt(r===""?"0":`0x${r}`)}function Ke(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);const e=r.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const t=new Uint8Array(e/2);for(let n=0;n<t.length;n++){const s=n*2,o=r.slice(s,s+2),i=Number.parseInt(o,16);if(Number.isNaN(i)||i<0)throw new Error("Invalid byte sequence");t[n]=i}return t}function W(r){return Jt(Be(r))}function Zt(r){if(!lt(r))throw new Error("Uint8Array expected");return Jt(Be(Uint8Array.from(r).reverse()))}function Se(r,e){return Ke(r.toString(16).padStart(e*2,"0"))}function Yt(r,e){return Se(r,e).reverse()}function To(r){return Ke(tn(r))}function j(r,e,t){let n;if(typeof e=="string")try{n=Ke(e)}catch(o){throw new Error(`${r} must be valid hex string, got "${e}". Cause: ${o}`)}else if(lt(e))n=Uint8Array.from(e);else throw new Error(`${r} must be hex string or Uint8Array`);const s=n.length;if(typeof t=="number"&&s!==t)throw new Error(`${r} expected ${t} bytes, got ${s}`);return n}function Ie(...r){const e=new Uint8Array(r.reduce((n,s)=>n+s.length,0));let t=0;return r.forEach(n=>{if(!lt(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}function Io(r,e){if(r.length!==e.length)return!1;for(let t=0;t<r.length;t++)if(r[t]!==e[t])return!1;return!0}function Mo(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Ao(r){let e;for(e=0;r>en;r>>=ct,e+=1);return e}function Co(r,e){return r>>BigInt(e)&ct}const Lo=(r,e,t)=>r|(t?ct:en)<<BigInt(e),Xt=r=>(Po<<BigInt(r-1))-ct,Pt=r=>new Uint8Array(r),Mr=r=>Uint8Array.from(r);function rn(r,e,t){if(typeof r!="number"||r<2)throw new Error("hashLen must be a number");if(typeof e!="number"||e<2)throw new Error("qByteLen must be a number");if(typeof t!="function")throw new Error("hmacFn must be a function");let n=Pt(r),s=Pt(r),o=0;const i=()=>{n.fill(1),s.fill(0),o=0},a=(...u)=>t(s,n,...u),c=(u=Pt())=>{s=a(Mr([0]),u),n=a(),u.length!==0&&(s=a(Mr([1]),u),n=a())},l=()=>{if(o++>=1e3)throw new Error("drbg: tried 1000 values");let u=0;const p=[];for(;u<e;){n=a();const b=n.slice();p.push(b),u+=n.length}return Ie(...p)};return(u,p)=>{i(),c(u);let b;for(;!(b=p(l()));)c();return i(),b}}const _o={bigint:r=>typeof r=="bigint",function:r=>typeof r=="function",boolean:r=>typeof r=="boolean",string:r=>typeof r=="string",stringOrUint8Array:r=>typeof r=="string"||r instanceof Uint8Array,isSafeInteger:r=>Number.isSafeInteger(r),array:r=>Array.isArray(r),field:(r,e)=>e.Fp.isValid(r),hash:r=>typeof r=="function"&&Number.isSafeInteger(r.outputLen)};function Ze(r,e,t={}){const n=(s,o,i)=>{const a=_o[o];if(typeof a!="function")throw new Error(`Invalid validator "${o}", expected function`);const c=r[s];if(!(i&&c===void 0)&&!a(c,r))throw new Error(`Invalid param ${String(s)}=${c} (${typeof c}), expected ${o}`)};for(const[s,o]of Object.entries(e))n(s,o,!1);for(const[s,o]of Object.entries(t))n(s,o,!0);return r}const $o=Object.freeze(Object.defineProperty({__proto__:null,bitGet:Co,bitLen:Ao,bitMask:Xt,bitSet:Lo,bytesToHex:Be,bytesToNumberBE:W,bytesToNumberLE:Zt,concatBytes:Ie,createHmacDrbg:rn,ensureBytes:j,equalBytes:Io,hexToBytes:Ke,hexToNumber:Jt,numberToBytesBE:Se,numberToBytesLE:Yt,numberToHexUnpadded:tn,numberToVarBytesBE:To,utf8ToBytes:Mo,validateObject:Ze},Symbol.toStringTag,{value:"Module"}));/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const q=BigInt(0),F=BigInt(1),Pe=BigInt(2),Do=BigInt(3),Bt=BigInt(4),Ar=BigInt(5),Cr=BigInt(8);BigInt(9);BigInt(16);function V(r,e){const t=r%e;return t>=q?t:e+t}function Bo(r,e,t){if(t<=q||e<q)throw new Error("Expected power/modulo > 0");if(t===F)return q;let n=F;for(;e>q;)e&F&&(n=n*r%t),r=r*r%t,e>>=F;return n}function Z(r,e,t){let n=r;for(;e-- >q;)n*=n,n%=t;return n}function Kt(r,e){if(r===q||e<=q)throw new Error(`invert: expected positive integers, got n=${r} mod=${e}`);let t=V(r,e),n=e,s=q,o=F;for(;t!==q;){const a=n/t,c=n%t,l=s-o*a;n=t,t=c,s=o,o=l}if(n!==F)throw new Error("invert: does not exist");return V(s,e)}function Ko(r){const e=(r-F)/Pe;let t,n,s;for(t=r-F,n=0;t%Pe===q;t/=Pe,n++);for(s=Pe;s<r&&Bo(s,e,r)!==r-F;s++);if(n===1){const i=(r+F)/Bt;return function(c,l){const h=c.pow(l,i);if(!c.eql(c.sqr(h),l))throw new Error("Cannot find square root");return h}}const o=(t+F)/Pe;return function(a,c){if(a.pow(c,e)===a.neg(a.ONE))throw new Error("Cannot find square root");let l=n,h=a.pow(a.mul(a.ONE,s),t),u=a.pow(c,o),p=a.pow(c,t);for(;!a.eql(p,a.ONE);){if(a.eql(p,a.ZERO))return a.ZERO;let b=1;for(let d=a.sqr(p);b<l&&!a.eql(d,a.ONE);b++)d=a.sqr(d);const g=a.pow(h,F<<BigInt(l-b-1));h=a.sqr(g),u=a.mul(u,g),p=a.mul(p,h),l=b}return u}}function Oo(r){if(r%Bt===Do){const e=(r+F)/Bt;return function(n,s){const o=n.pow(s,e);if(!n.eql(n.sqr(o),s))throw new Error("Cannot find square root");return o}}if(r%Cr===Ar){const e=(r-Ar)/Cr;return function(n,s){const o=n.mul(s,Pe),i=n.pow(o,e),a=n.mul(s,i),c=n.mul(n.mul(a,Pe),i),l=n.mul(a,n.sub(c,n.ONE));if(!n.eql(n.sqr(l),s))throw new Error("Cannot find square root");return l}}return Ko(r)}const Uo=["create","isValid","is0","neg","inv","sqrt","sqr","eql","add","sub","mul","pow","div","addN","subN","mulN","sqrN"];function Go(r){const e={ORDER:"bigint",MASK:"bigint",BYTES:"isSafeInteger",BITS:"isSafeInteger"},t=Uo.reduce((n,s)=>(n[s]="function",n),e);return Ze(r,t)}function Ho(r,e,t){if(t<q)throw new Error("Expected power > 0");if(t===q)return r.ONE;if(t===F)return e;let n=r.ONE,s=e;for(;t>q;)t&F&&(n=r.mul(n,s)),s=r.sqr(s),t>>=F;return n}function Fo(r,e){const t=new Array(e.length),n=e.reduce((o,i,a)=>r.is0(i)?o:(t[a]=o,r.mul(o,i)),r.ONE),s=r.inv(n);return e.reduceRight((o,i,a)=>r.is0(i)?o:(t[a]=r.mul(o,t[a]),r.mul(o,i)),s),t}function nn(r,e){const t=e!==void 0?e:r.toString(2).length,n=Math.ceil(t/8);return{nBitLength:t,nByteLength:n}}function qo(r,e,t=!1,n={}){if(r<=q)throw new Error(`Expected Field ORDER > 0, got ${r}`);const{nBitLength:s,nByteLength:o}=nn(r,e);if(o>2048)throw new Error("Field lengths over 2048 bytes are not supported");const i=Oo(r),a=Object.freeze({ORDER:r,BITS:s,BYTES:o,MASK:Xt(s),ZERO:q,ONE:F,create:c=>V(c,r),isValid:c=>{if(typeof c!="bigint")throw new Error(`Invalid field element: expected bigint, got ${typeof c}`);return q<=c&&c<r},is0:c=>c===q,isOdd:c=>(c&F)===F,neg:c=>V(-c,r),eql:(c,l)=>c===l,sqr:c=>V(c*c,r),add:(c,l)=>V(c+l,r),sub:(c,l)=>V(c-l,r),mul:(c,l)=>V(c*l,r),pow:(c,l)=>Ho(a,c,l),div:(c,l)=>V(c*Kt(l,r),r),sqrN:c=>c*c,addN:(c,l)=>c+l,subN:(c,l)=>c-l,mulN:(c,l)=>c*l,inv:c=>Kt(c,r),sqrt:n.sqrt||(c=>i(a,c)),invertBatch:c=>Fo(a,c),cmov:(c,l,h)=>h?l:c,toBytes:c=>t?Yt(c,o):Se(c,o),fromBytes:c=>{if(c.length!==o)throw new Error(`Fp.fromBytes: expected ${o}, got ${c.length}`);return t?Zt(c):W(c)}});return Object.freeze(a)}function sn(r){if(typeof r!="bigint")throw new Error("field order must be bigint");const e=r.toString(2).length;return Math.ceil(e/8)}function on(r){const e=sn(r);return e+Math.ceil(e/2)}function Vo(r,e,t=!1){const n=r.length,s=sn(e),o=on(e);if(n<16||n<o||n>1024)throw new Error(`expected ${o}-1024 bytes of input, got ${n}`);const i=t?W(r):Zt(r),a=V(i,e-F)+F;return t?Yt(a,s):Se(a,s)}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const jo=BigInt(0),Nt=BigInt(1);function zo(r,e){const t=(s,o)=>{const i=o.negate();return s?i:o},n=s=>{const o=Math.ceil(e/s)+1,i=2**(s-1);return{windows:o,windowSize:i}};return{constTimeNegate:t,unsafeLadder(s,o){let i=r.ZERO,a=s;for(;o>jo;)o&Nt&&(i=i.add(a)),a=a.double(),o>>=Nt;return i},precomputeWindow(s,o){const{windows:i,windowSize:a}=n(o),c=[];let l=s,h=l;for(let u=0;u<i;u++){h=l,c.push(h);for(let p=1;p<a;p++)h=h.add(l),c.push(h);l=h.double()}return c},wNAF(s,o,i){const{windows:a,windowSize:c}=n(s);let l=r.ZERO,h=r.BASE;const u=BigInt(2**s-1),p=2**s,b=BigInt(s);for(let g=0;g<a;g++){const d=g*c;let f=Number(i&u);i>>=b,f>c&&(f-=p,i+=Nt);const y=d,E=d+Math.abs(f)-1,R=g%2!==0,C=f<0;f===0?h=h.add(t(R,o[y])):l=l.add(t(C,o[E]))}return{p:l,f:h}},wNAFCached(s,o,i,a){const c=s._WINDOW_SIZE||1;let l=o.get(s);return l||(l=this.precomputeWindow(s,c),c!==1&&o.set(s,a(l))),this.wNAF(c,l,i)}}}function an(r){return Go(r.Fp),Ze(r,{n:"bigint",h:"bigint",Gx:"field",Gy:"field"},{nBitLength:"isSafeInteger",nByteLength:"isSafeInteger"}),Object.freeze({...nn(r.n,r.nBitLength),...r,p:r.Fp.ORDER})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function Wo(r){const e=an(r);Ze(e,{a:"field",b:"field"},{allowedPrivateKeyLengths:"array",wrapPrivateKey:"boolean",isTorsionFree:"function",clearCofactor:"function",allowInfinityPoint:"boolean",fromBytes:"function",toBytes:"function"});const{endo:t,Fp:n,a:s}=e;if(t){if(!n.eql(s,n.ZERO))throw new Error("Endomorphism can only be defined for Koblitz curves that have a=0");if(typeof t!="object"||typeof t.beta!="bigint"||typeof t.splitScalar!="function")throw new Error("Expected endomorphism with beta: bigint and splitScalar: function")}return Object.freeze({...e})}const{bytesToNumberBE:Jo,hexToBytes:Zo}=$o,Te={Err:class extends Error{constructor(e=""){super(e)}},_parseInt(r){const{Err:e}=Te;if(r.length<2||r[0]!==2)throw new e("Invalid signature integer tag");const t=r[1],n=r.subarray(2,t+2);if(!t||n.length!==t)throw new e("Invalid signature integer: wrong length");if(n[0]&128)throw new e("Invalid signature integer: negative");if(n[0]===0&&!(n[1]&128))throw new e("Invalid signature integer: unnecessary leading zero");return{d:Jo(n),l:r.subarray(t+2)}},toSig(r){const{Err:e}=Te,t=typeof r=="string"?Zo(r):r;if(!(t instanceof Uint8Array))throw new Error("ui8a expected");let n=t.length;if(n<2||t[0]!=48)throw new e("Invalid signature tag");if(t[1]!==n-2)throw new e("Invalid signature: incorrect length");const{d:s,l:o}=Te._parseInt(t.subarray(2)),{d:i,l:a}=Te._parseInt(o);if(a.length)throw new e("Invalid signature: left bytes after parsing");return{r:s,s:i}},hexFromSig(r){const e=l=>Number.parseInt(l[0],16)&8?"00"+l:l,t=l=>{const h=l.toString(16);return h.length&1?`0${h}`:h},n=e(t(r.s)),s=e(t(r.r)),o=n.length/2,i=s.length/2,a=t(o),c=t(i);return`30${t(i+o+4)}02${c}${s}02${a}${n}`}},ie=BigInt(0),Y=BigInt(1);BigInt(2);const Lr=BigInt(3);BigInt(4);function Yo(r){const e=Wo(r),{Fp:t}=e,n=e.toBytes||((g,d,f)=>{const y=d.toAffine();return Ie(Uint8Array.from([4]),t.toBytes(y.x),t.toBytes(y.y))}),s=e.fromBytes||(g=>{const d=g.subarray(1),f=t.fromBytes(d.subarray(0,t.BYTES)),y=t.fromBytes(d.subarray(t.BYTES,2*t.BYTES));return{x:f,y}});function o(g){const{a:d,b:f}=e,y=t.sqr(g),E=t.mul(y,g);return t.add(t.add(E,t.mul(g,d)),f)}if(!t.eql(t.sqr(e.Gy),o(e.Gx)))throw new Error("bad generator point: equation left != right");function i(g){return typeof g=="bigint"&&ie<g&&g<e.n}function a(g){if(!i(g))throw new Error("Expected valid bigint: 0 < bigint < curve.n")}function c(g){const{allowedPrivateKeyLengths:d,nByteLength:f,wrapPrivateKey:y,n:E}=e;if(d&&typeof g!="bigint"){if(g instanceof Uint8Array&&(g=Be(g)),typeof g!="string"||!d.includes(g.length))throw new Error("Invalid key");g=g.padStart(f*2,"0")}let R;try{R=typeof g=="bigint"?g:W(j("private key",g,f))}catch{throw new Error(`private key must be ${f} bytes, hex or bigint, not ${typeof g}`)}return y&&(R=V(R,E)),a(R),R}const l=new Map;function h(g){if(!(g instanceof u))throw new Error("ProjectivePoint expected")}class u{constructor(d,f,y){if(this.px=d,this.py=f,this.pz=y,d==null||!t.isValid(d))throw new Error("x required");if(f==null||!t.isValid(f))throw new Error("y required");if(y==null||!t.isValid(y))throw new Error("z required")}static fromAffine(d){const{x:f,y}=d||{};if(!d||!t.isValid(f)||!t.isValid(y))throw new Error("invalid affine point");if(d instanceof u)throw new Error("projective point not allowed");const E=R=>t.eql(R,t.ZERO);return E(f)&&E(y)?u.ZERO:new u(f,y,t.ONE)}get x(){return this.toAffine().x}get y(){return this.toAffine().y}static normalizeZ(d){const f=t.invertBatch(d.map(y=>y.pz));return d.map((y,E)=>y.toAffine(f[E])).map(u.fromAffine)}static fromHex(d){const f=u.fromAffine(s(j("pointHex",d)));return f.assertValidity(),f}static fromPrivateKey(d){return u.BASE.multiply(c(d))}_setWindowSize(d){this._WINDOW_SIZE=d,l.delete(this)}assertValidity(){if(this.is0()){if(e.allowInfinityPoint&&!t.is0(this.py))return;throw new Error("bad point: ZERO")}const{x:d,y:f}=this.toAffine();if(!t.isValid(d)||!t.isValid(f))throw new Error("bad point: x or y not FE");const y=t.sqr(f),E=o(d);if(!t.eql(y,E))throw new Error("bad point: equation left != right");if(!this.isTorsionFree())throw new Error("bad point: not in prime-order subgroup")}hasEvenY(){const{y:d}=this.toAffine();if(t.isOdd)return!t.isOdd(d);throw new Error("Field doesn't support isOdd")}equals(d){h(d);const{px:f,py:y,pz:E}=this,{px:R,py:C,pz:I}=d,w=t.eql(t.mul(f,I),t.mul(R,E)),S=t.eql(t.mul(y,I),t.mul(C,E));return w&&S}negate(){return new u(this.px,t.neg(this.py),this.pz)}double(){const{a:d,b:f}=e,y=t.mul(f,Lr),{px:E,py:R,pz:C}=this;let I=t.ZERO,w=t.ZERO,S=t.ZERO,x=t.mul(E,E),O=t.mul(R,R),A=t.mul(C,C),N=t.mul(E,R);return N=t.add(N,N),S=t.mul(E,C),S=t.add(S,S),I=t.mul(d,S),w=t.mul(y,A),w=t.add(I,w),I=t.sub(O,w),w=t.add(O,w),w=t.mul(I,w),I=t.mul(N,I),S=t.mul(y,S),A=t.mul(d,A),N=t.sub(x,A),N=t.mul(d,N),N=t.add(N,S),S=t.add(x,x),x=t.add(S,x),x=t.add(x,A),x=t.mul(x,N),w=t.add(w,x),A=t.mul(R,C),A=t.add(A,A),x=t.mul(A,N),I=t.sub(I,x),S=t.mul(A,O),S=t.add(S,S),S=t.add(S,S),new u(I,w,S)}add(d){h(d);const{px:f,py:y,pz:E}=this,{px:R,py:C,pz:I}=d;let w=t.ZERO,S=t.ZERO,x=t.ZERO;const O=e.a,A=t.mul(e.b,Lr);let N=t.mul(f,R),D=t.mul(y,C),B=t.mul(E,I),H=t.add(f,y),m=t.add(R,C);H=t.mul(H,m),m=t.add(N,D),H=t.sub(H,m),m=t.add(f,E);let v=t.add(R,I);return m=t.mul(m,v),v=t.add(N,B),m=t.sub(m,v),v=t.add(y,E),w=t.add(C,I),v=t.mul(v,w),w=t.add(D,B),v=t.sub(v,w),x=t.mul(O,m),w=t.mul(A,B),x=t.add(w,x),w=t.sub(D,x),x=t.add(D,x),S=t.mul(w,x),D=t.add(N,N),D=t.add(D,N),B=t.mul(O,B),m=t.mul(A,m),D=t.add(D,B),B=t.sub(N,B),B=t.mul(O,B),m=t.add(m,B),N=t.mul(D,m),S=t.add(S,N),N=t.mul(v,m),w=t.mul(H,w),w=t.sub(w,N),N=t.mul(H,D),x=t.mul(v,x),x=t.add(x,N),new u(w,S,x)}subtract(d){return this.add(d.negate())}is0(){return this.equals(u.ZERO)}wNAF(d){return b.wNAFCached(this,l,d,f=>{const y=t.invertBatch(f.map(E=>E.pz));return f.map((E,R)=>E.toAffine(y[R])).map(u.fromAffine)})}multiplyUnsafe(d){const f=u.ZERO;if(d===ie)return f;if(a(d),d===Y)return this;const{endo:y}=e;if(!y)return b.unsafeLadder(this,d);let{k1neg:E,k1:R,k2neg:C,k2:I}=y.splitScalar(d),w=f,S=f,x=this;for(;R>ie||I>ie;)R&Y&&(w=w.add(x)),I&Y&&(S=S.add(x)),x=x.double(),R>>=Y,I>>=Y;return E&&(w=w.negate()),C&&(S=S.negate()),S=new u(t.mul(S.px,y.beta),S.py,S.pz),w.add(S)}multiply(d){a(d);let f=d,y,E;const{endo:R}=e;if(R){const{k1neg:C,k1:I,k2neg:w,k2:S}=R.splitScalar(f);let{p:x,f:O}=this.wNAF(I),{p:A,f:N}=this.wNAF(S);x=b.constTimeNegate(C,x),A=b.constTimeNegate(w,A),A=new u(t.mul(A.px,R.beta),A.py,A.pz),y=x.add(A),E=O.add(N)}else{const{p:C,f:I}=this.wNAF(f);y=C,E=I}return u.normalizeZ([y,E])[0]}multiplyAndAddUnsafe(d,f,y){const E=u.BASE,R=(I,w)=>w===ie||w===Y||!I.equals(E)?I.multiplyUnsafe(w):I.multiply(w),C=R(this,f).add(R(d,y));return C.is0()?void 0:C}toAffine(d){const{px:f,py:y,pz:E}=this,R=this.is0();d==null&&(d=R?t.ONE:t.inv(E));const C=t.mul(f,d),I=t.mul(y,d),w=t.mul(E,d);if(R)return{x:t.ZERO,y:t.ZERO};if(!t.eql(w,t.ONE))throw new Error("invZ was invalid");return{x:C,y:I}}isTorsionFree(){const{h:d,isTorsionFree:f}=e;if(d===Y)return!0;if(f)return f(u,this);throw new Error("isTorsionFree() has not been declared for the elliptic curve")}clearCofactor(){const{h:d,clearCofactor:f}=e;return d===Y?this:f?f(u,this):this.multiplyUnsafe(e.h)}toRawBytes(d=!0){return this.assertValidity(),n(u,this,d)}toHex(d=!0){return Be(this.toRawBytes(d))}}u.BASE=new u(e.Gx,e.Gy,t.ONE),u.ZERO=new u(t.ZERO,t.ONE,t.ZERO);const p=e.nBitLength,b=zo(u,e.endo?Math.ceil(p/2):p);return{CURVE:e,ProjectivePoint:u,normPrivateKeyToScalar:c,weierstrassEquation:o,isWithinCurveOrder:i}}function Xo(r){const e=an(r);return Ze(e,{hash:"hash",hmac:"function",randomBytes:"function"},{bits2int:"function",bits2int_modN:"function",lowS:"boolean"}),Object.freeze({lowS:!0,...e})}function Qo(r){const e=Xo(r),{Fp:t,n}=e,s=t.BYTES+1,o=2*t.BYTES+1;function i(m){return ie<m&&m<t.ORDER}function a(m){return V(m,n)}function c(m){return Kt(m,n)}const{ProjectivePoint:l,normPrivateKeyToScalar:h,weierstrassEquation:u,isWithinCurveOrder:p}=Yo({...e,toBytes(m,v,k){const M=v.toAffine(),T=t.toBytes(M.x),L=Ie;return k?L(Uint8Array.from([v.hasEvenY()?2:3]),T):L(Uint8Array.from([4]),T,t.toBytes(M.y))},fromBytes(m){const v=m.length,k=m[0],M=m.subarray(1);if(v===s&&(k===2||k===3)){const T=W(M);if(!i(T))throw new Error("Point is not on curve");const L=u(T);let K=t.sqrt(L);const $=(K&Y)===Y;return(k&1)===1!==$&&(K=t.neg(K)),{x:T,y:K}}else if(v===o&&k===4){const T=t.fromBytes(M.subarray(0,t.BYTES)),L=t.fromBytes(M.subarray(t.BYTES,2*t.BYTES));return{x:T,y:L}}else throw new Error(`Point of length ${v} was invalid. Expected ${s} compressed bytes or ${o} uncompressed bytes`)}}),b=m=>Be(Se(m,e.nByteLength));function g(m){const v=n>>Y;return m>v}function d(m){return g(m)?a(-m):m}const f=(m,v,k)=>W(m.slice(v,k));class y{constructor(v,k,M){this.r=v,this.s=k,this.recovery=M,this.assertValidity()}static fromCompact(v){const k=e.nByteLength;return v=j("compactSignature",v,k*2),new y(f(v,0,k),f(v,k,2*k))}static fromDER(v){const{r:k,s:M}=Te.toSig(j("DER",v));return new y(k,M)}assertValidity(){if(!p(this.r))throw new Error("r must be 0 < r < CURVE.n");if(!p(this.s))throw new Error("s must be 0 < s < CURVE.n")}addRecoveryBit(v){return new y(this.r,this.s,v)}recoverPublicKey(v){const{r:k,s:M,recovery:T}=this,L=S(j("msgHash",v));if(T==null||![0,1,2,3].includes(T))throw new Error("recovery id invalid");const K=T===2||T===3?k+e.n:k;if(K>=t.ORDER)throw new Error("recovery id 2 or 3 invalid");const $=T&1?"03":"02",X=l.fromHex($+b(K)),fe=c(K),Me=a(-L*fe),qe=a(M*fe),pe=l.BASE.multiplyAndAddUnsafe(X,Me,qe);if(!pe)throw new Error("point at infinify");return pe.assertValidity(),pe}hasHighS(){return g(this.s)}normalizeS(){return this.hasHighS()?new y(this.r,a(-this.s),this.recovery):this}toDERRawBytes(){return Ke(this.toDERHex())}toDERHex(){return Te.hexFromSig({r:this.r,s:this.s})}toCompactRawBytes(){return Ke(this.toCompactHex())}toCompactHex(){return b(this.r)+b(this.s)}}const E={isValidPrivateKey(m){try{return h(m),!0}catch{return!1}},normPrivateKeyToScalar:h,randomPrivateKey:()=>{const m=on(e.n);return Vo(e.randomBytes(m),e.n)},precompute(m=8,v=l.BASE){return v._setWindowSize(m),v.multiply(BigInt(3)),v}};function R(m,v=!0){return l.fromPrivateKey(m).toRawBytes(v)}function C(m){const v=m instanceof Uint8Array,k=typeof m=="string",M=(v||k)&&m.length;return v?M===s||M===o:k?M===2*s||M===2*o:m instanceof l}function I(m,v,k=!0){if(C(m))throw new Error("first arg must be private key");if(!C(v))throw new Error("second arg must be public key");return l.fromHex(v).multiply(h(m)).toRawBytes(k)}const w=e.bits2int||function(m){const v=W(m),k=m.length*8-e.nBitLength;return k>0?v>>BigInt(k):v},S=e.bits2int_modN||function(m){return a(w(m))},x=Xt(e.nBitLength);function O(m){if(typeof m!="bigint")throw new Error("bigint expected");if(!(ie<=m&&m<x))throw new Error(`bigint expected < 2^${e.nBitLength}`);return Se(m,e.nByteLength)}function A(m,v,k=N){if(["recovered","canonical"].some(Re=>Re in k))throw new Error("sign() legacy options not supported");const{hash:M,randomBytes:T}=e;let{lowS:L,prehash:K,extraEntropy:$}=k;L==null&&(L=!0),m=j("msgHash",m),K&&(m=j("prehashed msgHash",M(m)));const X=S(m),fe=h(v),Me=[O(fe),O(X)];if($!=null){const Re=$===!0?T(t.BYTES):$;Me.push(j("extraEntropy",Re))}const qe=Ie(...Me),pe=X;function xt(Re){const Ae=w(Re);if(!p(Ae))return;const Pr=c(Ae),ee=l.BASE.multiply(Ae).toAffine(),Ce=a(ee.x);if(Ce===ie)return;const Xe=a(Pr*a(pe+Ce*fe));if(Xe===ie)return;let Nr=(ee.x===Ce?0:2)|Number(ee.y&Y),Tr=Xe;return L&&g(Xe)&&(Tr=d(Xe),Nr^=1),new y(Ce,Tr,Nr)}return{seed:qe,k2sig:xt}}const N={lowS:e.lowS,prehash:!1},D={lowS:e.lowS,prehash:!1};function B(m,v,k=N){const{seed:M,k2sig:T}=A(m,v,k),L=e;return rn(L.hash.outputLen,L.nByteLength,L.hmac)(M,T)}l.BASE._setWindowSize(8);function H(m,v,k,M=D){const T=m;if(v=j("msgHash",v),k=j("publicKey",k),"strict"in M)throw new Error("options.strict was renamed to lowS");const{lowS:L,prehash:K}=M;let $,X;try{if(typeof T=="string"||T instanceof Uint8Array)try{$=y.fromDER(T)}catch(ee){if(!(ee instanceof Te.Err))throw ee;$=y.fromCompact(T)}else if(typeof T=="object"&&typeof T.r=="bigint"&&typeof T.s=="bigint"){const{r:ee,s:Ce}=T;$=new y(ee,Ce)}else throw new Error("PARSE");X=l.fromHex(k)}catch(ee){if(ee.message==="PARSE")throw new Error("signature must be Signature instance, Uint8Array or hex string");return!1}if(L&&$.hasHighS())return!1;K&&(v=e.hash(v));const{r:fe,s:Me}=$,qe=S(v),pe=c(Me),xt=a(qe*pe),Re=a(fe*pe),Ae=l.BASE.multiplyAndAddUnsafe(X,xt,Re)?.toAffine();return Ae?a(Ae.x)===fe:!1}return{CURVE:e,getPublicKey:R,getSharedSecret:I,sign:B,verify:H,ProjectivePoint:l,Signature:y,utils:E}}let cn=class extends Xr{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,po(e);const n=Wt(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),o.fill(0)}update(e){return rt(this),this.iHash.update(e),this}digestInto(e){rt(this),Zr(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}};const ln=(r,e,t)=>new cn(r,e).update(t).digest();ln.create=(r,e)=>new cn(r,e);/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */function ei(r){return{hash:r,hmac:(e,...t)=>ln(r,e,bo(...t)),randomBytes:Qr}}function ti(r,e){const t=n=>Qo({...r,...ei(n)});return Object.freeze({...t(e),create:t})}/*! noble-curves - MIT License (c) 2022 Paul Miller (paulmillr.com) */const ht=BigInt("0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffefffffc2f"),nt=BigInt("0xfffffffffffffffffffffffffffffffebaaedce6af48a03bbfd25e8cd0364141"),hn=BigInt(1),st=BigInt(2),_r=(r,e)=>(r+e/st)/e;function un(r){const e=ht,t=BigInt(3),n=BigInt(6),s=BigInt(11),o=BigInt(22),i=BigInt(23),a=BigInt(44),c=BigInt(88),l=r*r*r%e,h=l*l*r%e,u=Z(h,t,e)*h%e,p=Z(u,t,e)*h%e,b=Z(p,st,e)*l%e,g=Z(b,s,e)*b%e,d=Z(g,o,e)*g%e,f=Z(d,a,e)*d%e,y=Z(f,c,e)*f%e,E=Z(y,a,e)*d%e,R=Z(E,t,e)*h%e,C=Z(R,i,e)*g%e,I=Z(C,n,e)*l%e,w=Z(I,st,e);if(!Ot.eql(Ot.sqr(w),r))throw new Error("Cannot find square root");return w}const Ot=qo(ht,void 0,void 0,{sqrt:un}),Ue=ti({a:BigInt(0),b:BigInt(7),Fp:Ot,n:nt,Gx:BigInt("55066263022277343669578718895168534326250603453777594175500187360389116729240"),Gy:BigInt("32670510020758816978083085130507043184471273380659243275938904335757337482424"),h:BigInt(1),lowS:!0,endo:{beta:BigInt("0x7ae96a2b657c07106e64479eac3434e99cf0497512f58995c1396c28719501ee"),splitScalar:r=>{const e=nt,t=BigInt("0x3086d221a7d46bcde86c90e49284eb15"),n=-hn*BigInt("0xe4437ed6010e88286f547fa90abfe4c3"),s=BigInt("0x114ca50f7a8e2f3f657c1108d9d44cfd8"),o=t,i=BigInt("0x100000000000000000000000000000000"),a=_r(o*r,e),c=_r(-n*r,e);let l=V(r-a*t-c*s,e),h=V(-a*n-c*o,e);const u=l>i,p=h>i;if(u&&(l=e-l),p&&(h=e-h),l>i||h>i)throw new Error("splitScalar: Endomorphism failed, k="+r);return{k1neg:u,k1:l,k2neg:p,k2:h}}}},Dt),ut=BigInt(0),dn=r=>typeof r=="bigint"&&ut<r&&r<ht,ri=r=>typeof r=="bigint"&&ut<r&&r<nt,$r={};function ot(r,...e){let t=$r[r];if(t===void 0){const n=Dt(Uint8Array.from(r,s=>s.charCodeAt(0)));t=Ie(n,n),$r[r]=t}return Dt(Ie(t,...e))}const Qt=r=>r.toRawBytes(!0).slice(1),Ut=r=>Se(r,32),Tt=r=>V(r,ht),We=r=>V(r,nt),er=Ue.ProjectivePoint,ni=(r,e,t)=>er.BASE.multiplyAndAddUnsafe(r,e,t);function Gt(r){let e=Ue.utils.normPrivateKeyToScalar(r),t=er.fromPrivateKey(e);return{scalar:t.hasEvenY()?e:We(-e),bytes:Qt(t)}}function fn(r){if(!dn(r))throw new Error("bad x: need 0 < x < p");const e=Tt(r*r),t=Tt(e*r+BigInt(7));let n=un(t);n%st!==ut&&(n=Tt(-n));const s=new er(r,n,hn);return s.assertValidity(),s}function pn(...r){return We(W(ot("BIP0340/challenge",...r)))}function si(r){return Gt(r).bytes}function oi(r,e,t=Qr(32)){const n=j("message",r),{bytes:s,scalar:o}=Gt(e),i=j("auxRand",t,32),a=Ut(o^W(ot("BIP0340/aux",i))),c=ot("BIP0340/nonce",a,s,n),l=We(W(c));if(l===ut)throw new Error("sign failed: k is zero");const{bytes:h,scalar:u}=Gt(l),p=pn(h,s,n),b=new Uint8Array(64);if(b.set(h,0),b.set(Ut(We(u+p*o)),32),!yn(b,n,s))throw new Error("sign: Invalid signature produced");return b}function yn(r,e,t){const n=j("signature",r,64),s=j("message",e),o=j("publicKey",t,32);try{const i=fn(W(o)),a=W(n.subarray(0,32));if(!dn(a))return!1;const c=W(n.subarray(32,64));if(!ri(c))return!1;const l=pn(Ut(a),Qt(i),s),h=ni(i,c,We(-l));return!(!h||!h.hasEvenY()||h.toAffine().x!==a)}catch{return!1}}const Ve=(()=>({getPublicKey:si,sign:oi,verify:yn,utils:{randomPrivateKey:Ue.utils.randomPrivateKey,lift_x:fn,pointToBytes:Qt,numberToBytesBE:Se,bytesToNumberBE:W,taggedHash:ot,mod:V}}))(),It=typeof globalThis=="object"&&"crypto"in globalThis?globalThis.crypto:void 0;/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */const tr=r=>r instanceof Uint8Array,Mt=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),re=(r,e)=>r<<32-e|r>>>e,ii=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!ii)throw new Error("Non little-endian hardware is not supported");const ai=Array.from({length:256},(r,e)=>e.toString(16).padStart(2,"0"));function G(r){if(!tr(r))throw new Error("Uint8Array expected");let e="";for(let t=0;t<r.length;t++)e+=ai[r[t]];return e}function xe(r){if(typeof r!="string")throw new Error("hex string expected, got "+typeof r);const e=r.length;if(e%2)throw new Error("padded hex string expected, got unpadded hex of length "+e);const t=new Uint8Array(e/2);for(let n=0;n<t.length;n++){const s=n*2,o=r.slice(s,s+2),i=Number.parseInt(o,16);if(Number.isNaN(i)||i<0)throw new Error("Invalid byte sequence");t[n]=i}return t}function ci(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Je(r){if(typeof r=="string"&&(r=ci(r)),!tr(r))throw new Error(`expected Uint8Array, got ${typeof r}`);return r}function dt(...r){const e=new Uint8Array(r.reduce((n,s)=>n+s.length,0));let t=0;return r.forEach(n=>{if(!tr(n))throw new Error("Uint8Array expected");e.set(n,t),t+=n.length}),e}class gn{clone(){return this._cloneInto()}}function mn(r){const e=n=>r().update(Je(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function bn(r=32){if(It&&typeof It.getRandomValues=="function")return It.getRandomValues(new Uint8Array(r));throw new Error("crypto.getRandomValues must be defined")}function Ht(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`Wrong positive integer: ${r}`)}function li(r){if(typeof r!="boolean")throw new Error(`Expected boolean, not ${r}`)}function vn(r,...e){if(!(r instanceof Uint8Array))throw new Error("Expected Uint8Array");if(e.length>0&&!e.includes(r.length))throw new Error(`Expected Uint8Array of length ${e}, not of length=${r.length}`)}function hi(r){if(typeof r!="function"||typeof r.create!="function")throw new Error("Hash should be wrapped by utils.wrapConstructor");Ht(r.outputLen),Ht(r.blockLen)}function ui(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function di(r,e){vn(r);const t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}const ne={number:Ht,bool:li,bytes:vn,hash:hi,exists:ui,output:di};function fi(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);const s=BigInt(32),o=BigInt(4294967295),i=Number(t>>s&o),a=Number(t&o),c=n?4:0,l=n?0:4;r.setUint32(e+c,i,n),r.setUint32(e+l,a,n)}class pi extends gn{constructor(e,t,n,s){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=s,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Mt(this.buffer)}update(e){ne.exists(this);const{view:t,buffer:n,blockLen:s}=this;e=Je(e);const o=e.length;for(let i=0;i<o;){const a=Math.min(s-this.pos,o-i);if(a===s){const c=Mt(e);for(;s<=o-i;i+=s)this.process(c,i);continue}n.set(e.subarray(i,i+a),this.pos),this.pos+=a,i+=a,this.pos===s&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ne.exists(this),ne.output(e,this),this.finished=!0;const{buffer:t,view:n,blockLen:s,isLE:o}=this;let{pos:i}=this;t[i++]=128,this.buffer.subarray(i).fill(0),this.padOffset>s-i&&(this.process(n,0),i=0);for(let u=i;u<s;u++)t[u]=0;fi(n,s-8,BigInt(this.length*8),o),this.process(n,0);const a=Mt(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=c/4,h=this.get();if(l>h.length)throw new Error("_sha2: outputLen bigger than state");for(let u=0;u<l;u++)a.setUint32(4*u,h[u],o)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:n,length:s,finished:o,destroyed:i,pos:a}=this;return e.length=s,e.pos=a,e.finished=o,e.destroyed=i,s%t&&e.buffer.set(n),e}}const yi=(r,e,t)=>r&e^~r&t,gi=(r,e,t)=>r&e^r&t^e&t,mi=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),me=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),be=new Uint32Array(64);class wn extends pi{constructor(){super(64,32,8,!1),this.A=me[0]|0,this.B=me[1]|0,this.C=me[2]|0,this.D=me[3]|0,this.E=me[4]|0,this.F=me[5]|0,this.G=me[6]|0,this.H=me[7]|0}get(){const{A:e,B:t,C:n,D:s,E:o,F:i,G:a,H:c}=this;return[e,t,n,s,o,i,a,c]}set(e,t,n,s,o,i,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=s|0,this.E=o|0,this.F=i|0,this.G=a|0,this.H=c|0}process(e,t){for(let u=0;u<16;u++,t+=4)be[u]=e.getUint32(t,!1);for(let u=16;u<64;u++){const p=be[u-15],b=be[u-2],g=re(p,7)^re(p,18)^p>>>3,d=re(b,17)^re(b,19)^b>>>10;be[u]=d+be[u-7]+g+be[u-16]|0}let{A:n,B:s,C:o,D:i,E:a,F:c,G:l,H:h}=this;for(let u=0;u<64;u++){const p=re(a,6)^re(a,11)^re(a,25),b=h+p+yi(a,c,l)+mi[u]+be[u]|0,d=(re(n,2)^re(n,13)^re(n,22))+gi(n,s,o)|0;h=l,l=c,c=a,a=i+b|0,i=o,o=s,s=n,n=b+d|0}n=n+this.A|0,s=s+this.B|0,o=o+this.C|0,i=i+this.D|0,a=a+this.E|0,c=c+this.F|0,l=l+this.G|0,h=h+this.H|0,this.set(n,s,o,i,a,c,l,h)}roundClean(){be.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}}class bi extends wn{constructor(){super(),this.A=-1056596264,this.B=914150663,this.C=812702999,this.D=-150054599,this.E=-4191439,this.F=1750603025,this.G=1694076839,this.H=-1090891868,this.outputLen=28}}const Ge=mn(()=>new wn);mn(()=>new bi);/*! scure-base - MIT License (c) 2022 Paul Miller (paulmillr.com) */function He(r){if(!Number.isSafeInteger(r))throw new Error(`Wrong integer: ${r}`)}function he(...r){const e=(s,o)=>i=>s(o(i)),t=Array.from(r).reverse().reduce((s,o)=>s?e(s,o.encode):o.encode,void 0),n=r.reduce((s,o)=>s?e(s,o.decode):o.decode,void 0);return{encode:t,decode:n}}function ue(r){return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("alphabet.encode input should be an array of numbers");return e.map(t=>{if(He(t),t<0||t>=r.length)throw new Error(`Digit index outside alphabet: ${t} (alphabet: ${r.length})`);return r[t]})},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("alphabet.decode input should be array of strings");return e.map(t=>{if(typeof t!="string")throw new Error(`alphabet.decode: not string element=${t}`);const n=r.indexOf(t);if(n===-1)throw new Error(`Unknown letter: "${t}". Allowed: ${r}`);return n})}}}function de(r=""){if(typeof r!="string")throw new Error("join separator should be string");return{encode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="string")throw new Error("join.encode input should be array of strings");for(let t of e)if(typeof t!="string")throw new Error(`join.encode: non-string input=${t}`);return e.join(r)},decode:e=>{if(typeof e!="string")throw new Error("join.decode input should be string");return e.split(r)}}}function ft(r,e="="){if(He(r),typeof e!="string")throw new Error("padding chr should be string");return{encode(t){if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("padding.encode input should be array of strings");for(let n of t)if(typeof n!="string")throw new Error(`padding.encode: non-string input=${n}`);for(;t.length*r%8;)t.push(e);return t},decode(t){if(!Array.isArray(t)||t.length&&typeof t[0]!="string")throw new Error("padding.encode input should be array of strings");for(let s of t)if(typeof s!="string")throw new Error(`padding.decode: non-string input=${s}`);let n=t.length;if(n*r%8)throw new Error("Invalid padding: string should have whole number of bytes");for(;n>0&&t[n-1]===e;n--)if(!((n-1)*r%8))throw new Error("Invalid padding: string has too much padding");return t.slice(0,n)}}}function En(r){if(typeof r!="function")throw new Error("normalize fn should be function");return{encode:e=>e,decode:e=>r(e)}}function Dr(r,e,t){if(e<2)throw new Error(`convertRadix: wrong from=${e}, base cannot be less than 2`);if(t<2)throw new Error(`convertRadix: wrong to=${t}, base cannot be less than 2`);if(!Array.isArray(r))throw new Error("convertRadix: data should be array");if(!r.length)return[];let n=0;const s=[],o=Array.from(r);for(o.forEach(i=>{if(He(i),i<0||i>=e)throw new Error(`Wrong integer: ${i}`)});;){let i=0,a=!0;for(let c=n;c<o.length;c++){const l=o[c],h=e*i+l;if(!Number.isSafeInteger(h)||e*i/e!==i||h-l!==e*i)throw new Error("convertRadix: carry overflow");if(i=h%t,o[c]=Math.floor(h/t),!Number.isSafeInteger(o[c])||o[c]*t+i!==h)throw new Error("convertRadix: carry overflow");if(a)o[c]?a=!1:n=c;else continue}if(s.push(i),a)break}for(let i=0;i<r.length-1&&r[i]===0;i++)s.push(0);return s.reverse()}const Sn=(r,e)=>e?Sn(e,r%e):r,it=(r,e)=>r+(e-Sn(r,e));function Ft(r,e,t,n){if(!Array.isArray(r))throw new Error("convertRadix2: data should be array");if(e<=0||e>32)throw new Error(`convertRadix2: wrong from=${e}`);if(t<=0||t>32)throw new Error(`convertRadix2: wrong to=${t}`);if(it(e,t)>32)throw new Error(`convertRadix2: carry overflow from=${e} to=${t} carryBits=${it(e,t)}`);let s=0,o=0;const i=2**t-1,a=[];for(const c of r){if(He(c),c>=2**e)throw new Error(`convertRadix2: invalid data word=${c} from=${e}`);if(s=s<<e|c,o+e>32)throw new Error(`convertRadix2: carry overflow pos=${o} from=${e}`);for(o+=e;o>=t;o-=t)a.push((s>>o-t&i)>>>0);s&=2**o-1}if(s=s<<t-o&i,!n&&o>=e)throw new Error("Excess padding");if(!n&&s)throw new Error(`Non-zero padding: ${s}`);return n&&o>0&&a.push(s>>>0),a}function vi(r){return He(r),{encode:e=>{if(!(e instanceof Uint8Array))throw new Error("radix.encode input should be Uint8Array");return Dr(Array.from(e),2**8,r)},decode:e=>{if(!Array.isArray(e)||e.length&&typeof e[0]!="number")throw new Error("radix.decode input should be array of strings");return Uint8Array.from(Dr(e,r,2**8))}}}function ke(r,e=!1){if(He(r),r<=0||r>32)throw new Error("radix2: bits should be in (0..32]");if(it(8,r)>32||it(r,8)>32)throw new Error("radix2: carry overflow");return{encode:t=>{if(!(t instanceof Uint8Array))throw new Error("radix2.encode input should be Uint8Array");return Ft(Array.from(t),8,r,!e)},decode:t=>{if(!Array.isArray(t)||t.length&&typeof t[0]!="number")throw new Error("radix2.decode input should be array of strings");return Uint8Array.from(Ft(t,r,8,e))}}}function Br(r){if(typeof r!="function")throw new Error("unsafeWrapper fn should be function");return function(...e){try{return r.apply(null,e)}catch{}}}const wi=he(ke(4),ue("0123456789ABCDEF"),de("")),Ei=he(ke(5),ue("ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"),ft(5),de(""));he(ke(5),ue("0123456789ABCDEFGHIJKLMNOPQRSTUV"),ft(5),de(""));he(ke(5),ue("0123456789ABCDEFGHJKMNPQRSTVWXYZ"),de(""),En(r=>r.toUpperCase().replace(/O/g,"0").replace(/[IL]/g,"1")));const le=he(ke(6),ue("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"),ft(6),de("")),Si=he(ke(6),ue("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_"),ft(6),de("")),rr=r=>he(vi(58),ue(r),de("")),qt=rr("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz");rr("123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ");rr("rpshnaf39wBUDNEGHJKLM4PQRST7VWXYZ2bcdeCg65jkm8oFqi1tuvAxyz");const Kr=[0,2,3,5,6,7,9,10,11],xi={encode(r){let e="";for(let t=0;t<r.length;t+=8){const n=r.subarray(t,t+8);e+=qt.encode(n).padStart(Kr[n.length],"1")}return e},decode(r){let e=[];for(let t=0;t<r.length;t+=11){const n=r.slice(t,t+11),s=Kr.indexOf(n.length),o=qt.decode(n);for(let i=0;i<o.length-s;i++)if(o[i]!==0)throw new Error("base58xmr: wrong padding");e=e.concat(Array.from(o.slice(o.length-s)))}return Uint8Array.from(e)}},Vt=he(ue("qpzry9x8gf2tvdw0s3jn54khce6mua7l"),de("")),Or=[996825010,642813549,513874426,1027748829,705979059];function je(r){const e=r>>25;let t=(r&33554431)<<5;for(let n=0;n<Or.length;n++)(e>>n&1)===1&&(t^=Or[n]);return t}function Ur(r,e,t=1){const n=r.length;let s=1;for(let o=0;o<n;o++){const i=r.charCodeAt(o);if(i<33||i>126)throw new Error(`Invalid prefix (${r})`);s=je(s)^i>>5}s=je(s);for(let o=0;o<n;o++)s=je(s)^r.charCodeAt(o)&31;for(let o of e)s=je(s)^o;for(let o=0;o<6;o++)s=je(s);return s^=t,Vt.encode(Ft([s%2**30],30,5,!1))}function xn(r){const e=r==="bech32"?1:734539939,t=ke(5),n=t.decode,s=t.encode,o=Br(n);function i(h,u,p=90){if(typeof h!="string")throw new Error(`bech32.encode prefix should be string, not ${typeof h}`);if(!Array.isArray(u)||u.length&&typeof u[0]!="number")throw new Error(`bech32.encode words should be array of numbers, not ${typeof u}`);const b=h.length+7+u.length;if(p!==!1&&b>p)throw new TypeError(`Length ${b} exceeds limit ${p}`);return h=h.toLowerCase(),`${h}1${Vt.encode(u)}${Ur(h,u,e)}`}function a(h,u=90){if(typeof h!="string")throw new Error(`bech32.decode input should be string, not ${typeof h}`);if(h.length<8||u!==!1&&h.length>u)throw new TypeError(`Wrong string length: ${h.length} (${h}). Expected (8..${u})`);const p=h.toLowerCase();if(h!==p&&h!==h.toUpperCase())throw new Error("String must be lowercase or uppercase");h=p;const b=h.lastIndexOf("1");if(b===0||b===-1)throw new Error('Letter "1" must be present between prefix and data only');const g=h.slice(0,b),d=h.slice(b+1);if(d.length<6)throw new Error("Data must be at least 6 characters long");const f=Vt.decode(d).slice(0,-6),y=Ur(g,f,e);if(!d.endsWith(y))throw new Error(`Invalid checksum in ${h}: expected "${y}"`);return{prefix:g,words:f}}const c=Br(a);function l(h){const{prefix:u,words:p}=a(h,!1);return{prefix:u,words:p,bytes:n(p)}}return{encode:i,decode:a,decodeToBytes:l,decodeUnsafe:c,fromWords:n,fromWordsUnsafe:o,toWords:s}}const oe=xn("bech32");xn("bech32m");const ki={encode:r=>new TextDecoder().decode(r),decode:r=>new TextEncoder().encode(r)},Ri=he(ke(4),ue("0123456789abcdef"),de(""),En(r=>{if(typeof r!="string"||r.length%2)throw new TypeError(`hex.decode: expected string, got ${typeof r} with length ${r.length}`);return r.toLowerCase()})),Pi={utf8:ki,hex:Ri,base16:wi,base32:Ei,base64:le,base64url:Si,base58:qt,base58xmr:xi};`${Object.keys(Pi).join(", ")}`;function At(r){if(!Number.isSafeInteger(r)||r<0)throw new Error(`positive integer expected, not ${r}`)}function Gr(r){if(typeof r!="boolean")throw new Error(`boolean expected, not ${r}`)}function Ni(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function ae(r,...e){if(!Ni(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}/*! noble-ciphers - MIT License (c) 2023 Paul Miller (paulmillr.com) */const z=r=>new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)),Ti=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;if(!Ti)throw new Error("Non little-endian hardware is not supported");function Ii(r,e){if(e==null||typeof e!="object")throw new Error("options must be defined");return Object.assign(r,e)}function Mi(r,e){if(r.length!==e.length)return!1;let t=0;for(let n=0;n<r.length;n++)t|=r[n]^e[n];return t===0}const Ai=(r,e)=>(Object.assign(e,r),e),Ee=16,Ci=283;function nr(r){return r<<1^Ci&-(r>>7)}function Le(r,e){let t=0;for(;e>0;e>>=1)t^=r&-(e&1),r=nr(r);return t}const jt=(()=>{let r=new Uint8Array(256);for(let t=0,n=1;t<256;t++,n^=nr(n))r[t]=n;const e=new Uint8Array(256);e[0]=99;for(let t=0;t<255;t++){let n=r[255-t];n|=n<<8,e[r[t]]=(n^n>>4^n>>5^n>>6^n>>7^99)&255}return e})(),Li=jt.map((r,e)=>jt.indexOf(e)),_i=r=>r<<24|r>>>8,Ct=r=>r<<8|r>>>24;function kn(r,e){if(r.length!==256)throw new Error("Wrong sbox length");const t=new Uint32Array(256).map((l,h)=>e(r[h])),n=t.map(Ct),s=n.map(Ct),o=s.map(Ct),i=new Uint32Array(256*256),a=new Uint32Array(256*256),c=new Uint16Array(256*256);for(let l=0;l<256;l++)for(let h=0;h<256;h++){const u=l*256+h;i[u]=t[l]^n[h],a[u]=s[l]^o[h],c[u]=r[l]<<8|r[h]}return{sbox:r,sbox2:c,T0:t,T1:n,T2:s,T3:o,T01:i,T23:a}}const sr=kn(jt,r=>Le(r,3)<<24|r<<16|r<<8|Le(r,2)),Rn=kn(Li,r=>Le(r,11)<<24|Le(r,13)<<16|Le(r,9)<<8|Le(r,14)),$i=(()=>{const r=new Uint8Array(16);for(let e=0,t=1;e<16;e++,t=nr(t))r[e]=t;return r})();function Pn(r){ae(r);const e=r.length;if(![16,24,32].includes(e))throw new Error(`aes: wrong key size: should be 16, 24 or 32, got: ${e}`);const{sbox2:t}=sr,n=z(r),s=n.length,o=a=>se(t,a,a,a,a),i=new Uint32Array(e+28);i.set(n);for(let a=s;a<i.length;a++){let c=i[a-1];a%s===0?c=o(_i(c))^$i[a/s-1]:s>6&&a%s===4&&(c=o(c)),i[a]=i[a-s]^c}return i}function Di(r){const e=Pn(r),t=e.slice(),n=e.length,{sbox2:s}=sr,{T0:o,T1:i,T2:a,T3:c}=Rn;for(let l=0;l<n;l+=4)for(let h=0;h<4;h++)t[l+h]=e[n-l-4+h];e.fill(0);for(let l=4;l<n-4;l++){const h=t[l],u=se(s,h,h,h,h);t[l]=o[u&255]^i[u>>>8&255]^a[u>>>16&255]^c[u>>>24]}return t}function we(r,e,t,n,s,o){return r[t<<8&65280|n>>>8&255]^e[s>>>8&65280|o>>>24&255]}function se(r,e,t,n,s){return r[e&255|t&65280]|r[n>>>16&255|s>>>16&65280]<<16}function Hr(r,e,t,n,s){const{sbox2:o,T01:i,T23:a}=sr;let c=0;e^=r[c++],t^=r[c++],n^=r[c++],s^=r[c++];const l=r.length/4-2;for(let g=0;g<l;g++){const d=r[c++]^we(i,a,e,t,n,s),f=r[c++]^we(i,a,t,n,s,e),y=r[c++]^we(i,a,n,s,e,t),E=r[c++]^we(i,a,s,e,t,n);e=d,t=f,n=y,s=E}const h=r[c++]^se(o,e,t,n,s),u=r[c++]^se(o,t,n,s,e),p=r[c++]^se(o,n,s,e,t),b=r[c++]^se(o,s,e,t,n);return{s0:h,s1:u,s2:p,s3:b}}function Bi(r,e,t,n,s){const{sbox2:o,T01:i,T23:a}=Rn;let c=0;e^=r[c++],t^=r[c++],n^=r[c++],s^=r[c++];const l=r.length/4-2;for(let g=0;g<l;g++){const d=r[c++]^we(i,a,e,s,n,t),f=r[c++]^we(i,a,t,e,s,n),y=r[c++]^we(i,a,n,t,e,s),E=r[c++]^we(i,a,s,n,t,e);e=d,t=f,n=y,s=E}const h=r[c++]^se(o,e,s,n,t),u=r[c++]^se(o,t,e,s,n),p=r[c++]^se(o,n,t,e,s),b=r[c++]^se(o,s,n,t,e);return{s0:h,s1:u,s2:p,s3:b}}function Nn(r,e){if(!e)return new Uint8Array(r);if(ae(e),e.length<r)throw new Error(`aes: wrong destination length, expected at least ${r}, got: ${e.length}`);return e}function Ki(r){if(ae(r),r.length%Ee!==0)throw new Error(`aes/(cbc-ecb).decrypt ciphertext should consist of blocks with size ${Ee}`)}function Oi(r,e,t){let n=r.length;const s=n%Ee;if(!e&&s!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");const o=z(r);if(e){let c=Ee-s;c||(c=Ee),n=n+c}const i=Nn(n,t),a=z(i);return{b:o,o:a,out:i}}function Ui(r,e){if(!e)return r;const t=r.length;if(!t)throw new Error("aes/pcks5: empty ciphertext not allowed");const n=r[t-1];if(n<=0||n>16)throw new Error(`aes/pcks5: wrong padding byte: ${n}`);const s=r.subarray(0,-n);for(let o=0;o<n;o++)if(r[t-o-1]!==n)throw new Error("aes/pcks5: wrong padding");return s}function Gi(r){const e=new Uint8Array(16),t=z(e);e.set(r);const n=Ee-r.length;for(let s=Ee-n;s<Ee;s++)e[s]=n;return t}const Tn=Ai({blockSize:16,nonceLength:16},function(e,t,n={}){ae(e),ae(t,16);const s=!n.disablePadding;return{encrypt:(o,i)=>{const a=Pn(e),{b:c,o:l,out:h}=Oi(o,s,i),u=z(t);let p=u[0],b=u[1],g=u[2],d=u[3],f=0;for(;f+4<=c.length;)p^=c[f+0],b^=c[f+1],g^=c[f+2],d^=c[f+3],{s0:p,s1:b,s2:g,s3:d}=Hr(a,p,b,g,d),l[f++]=p,l[f++]=b,l[f++]=g,l[f++]=d;if(s){const y=Gi(o.subarray(f*4));p^=y[0],b^=y[1],g^=y[2],d^=y[3],{s0:p,s1:b,s2:g,s3:d}=Hr(a,p,b,g,d),l[f++]=p,l[f++]=b,l[f++]=g,l[f++]=d}return a.fill(0),h},decrypt:(o,i)=>{Ki(o);const a=Di(e),c=z(t),l=Nn(o.length,i),h=z(o),u=z(l);let p=c[0],b=c[1],g=c[2],d=c[3];for(let f=0;f+4<=h.length;){const y=p,E=b,R=g,C=d;p=h[f+0],b=h[f+1],g=h[f+2],d=h[f+3];const{s0:I,s1:w,s2:S,s3:x}=Bi(a,p,b,g,d);u[f++]=I^y,u[f++]=w^E,u[f++]=S^R,u[f++]=x^C}return a.fill(0),Ui(l,s)}}}),In=r=>Uint8Array.from(r.split("").map(e=>e.charCodeAt(0))),Hi=In("expand 16-byte k"),Fi=In("expand 32-byte k"),qi=z(Hi),Mn=z(Fi);Mn.slice();function _(r,e){return r<<e|r>>>32-e}function zt(r){return r.byteOffset%4===0}const Qe=64,Vi=16,An=2**32-1,Fr=new Uint32Array;function ji(r,e,t,n,s,o,i,a){const c=s.length,l=new Uint8Array(Qe),h=z(l),u=zt(s)&&zt(o),p=u?z(s):Fr,b=u?z(o):Fr;for(let g=0;g<c;i++){if(r(e,t,n,h,i,a),i>=An)throw new Error("arx: counter overflow");const d=Math.min(Qe,c-g);if(u&&d===Qe){const f=g/4;if(g%4!==0)throw new Error("arx: invalid block position");for(let y=0,E;y<Vi;y++)E=f+y,b[E]=p[E]^h[y];g+=Qe;continue}for(let f=0,y;f<d;f++)y=g+f,o[y]=s[y]^l[f];g+=d}}function zi(r,e){const{allowShortKeys:t,extendNonceFn:n,counterLength:s,counterRight:o,rounds:i}=Ii({allowShortKeys:!1,counterLength:8,counterRight:!1,rounds:20},e);if(typeof r!="function")throw new Error("core must be a function");return At(s),At(i),Gr(o),Gr(t),(a,c,l,h,u=0)=>{ae(a),ae(c),ae(l);const p=l.length;if(h||(h=new Uint8Array(p)),ae(h),At(u),u<0||u>=An)throw new Error("arx: counter overflow");if(h.length<p)throw new Error(`arx: output (${h.length}) is shorter than data (${p})`);const b=[];let g=a.length,d,f;if(g===32)d=a.slice(),b.push(d),f=Mn;else if(g===16&&t)d=new Uint8Array(32),d.set(a),d.set(a,16),f=qi,b.push(d);else throw new Error(`arx: invalid 32-byte key, got length=${g}`);zt(c)||(c=c.slice(),b.push(c));const y=z(d);if(n){if(c.length!==24)throw new Error("arx: extended nonce must be 24 bytes");n(f,y,z(c.subarray(0,16)),y),c=c.subarray(16)}const E=16-s;if(E!==c.length)throw new Error(`arx: nonce must be ${E} or 16 bytes`);if(E!==12){const C=new Uint8Array(12);C.set(c,o?0:12-c.length),c=C,b.push(c)}const R=z(c);for(ji(r,f,y,R,l,h,u,i);b.length>0;)b.pop().fill(0);return h}}function Wi(r,e,t,n,s,o=20){let i=r[0],a=r[1],c=r[2],l=r[3],h=e[0],u=e[1],p=e[2],b=e[3],g=e[4],d=e[5],f=e[6],y=e[7],E=s,R=t[0],C=t[1],I=t[2],w=i,S=a,x=c,O=l,A=h,N=u,D=p,B=b,H=g,m=d,v=f,k=y,M=E,T=R,L=C,K=I;for(let X=0;X<o;X+=2)w=w+A|0,M=_(M^w,16),H=H+M|0,A=_(A^H,12),w=w+A|0,M=_(M^w,8),H=H+M|0,A=_(A^H,7),S=S+N|0,T=_(T^S,16),m=m+T|0,N=_(N^m,12),S=S+N|0,T=_(T^S,8),m=m+T|0,N=_(N^m,7),x=x+D|0,L=_(L^x,16),v=v+L|0,D=_(D^v,12),x=x+D|0,L=_(L^x,8),v=v+L|0,D=_(D^v,7),O=O+B|0,K=_(K^O,16),k=k+K|0,B=_(B^k,12),O=O+B|0,K=_(K^O,8),k=k+K|0,B=_(B^k,7),w=w+N|0,K=_(K^w,16),v=v+K|0,N=_(N^v,12),w=w+N|0,K=_(K^w,8),v=v+K|0,N=_(N^v,7),S=S+D|0,M=_(M^S,16),k=k+M|0,D=_(D^k,12),S=S+D|0,M=_(M^S,8),k=k+M|0,D=_(D^k,7),x=x+B|0,T=_(T^x,16),H=H+T|0,B=_(B^H,12),x=x+B|0,T=_(T^x,8),H=H+T|0,B=_(B^H,7),O=O+A|0,L=_(L^O,16),m=m+L|0,A=_(A^m,12),O=O+A|0,L=_(L^O,8),m=m+L|0,A=_(A^m,7);let $=0;n[$++]=i+w|0,n[$++]=a+S|0,n[$++]=c+x|0,n[$++]=l+O|0,n[$++]=h+A|0,n[$++]=u+N|0,n[$++]=p+D|0,n[$++]=b+B|0,n[$++]=g+H|0,n[$++]=d+m|0,n[$++]=f+v|0,n[$++]=y+k|0,n[$++]=E+M|0,n[$++]=R+T|0,n[$++]=C+L|0,n[$++]=I+K|0}const Cn=zi(Wi,{counterRight:!1,counterLength:4,allowShortKeys:!1});class Ln extends gn{constructor(e,t){super(),this.finished=!1,this.destroyed=!1,ne.hash(e);const n=Je(t);if(this.iHash=e.create(),typeof this.iHash.update!="function")throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const s=this.blockLen,o=new Uint8Array(s);o.set(n.length>s?e.create().update(n).digest():n);for(let i=0;i<o.length;i++)o[i]^=54;this.iHash.update(o),this.oHash=e.create();for(let i=0;i<o.length;i++)o[i]^=106;this.oHash.update(o),o.fill(0)}update(e){return ne.exists(this),this.iHash.update(e),this}digestInto(e){ne.exists(this),ne.bytes(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:n,finished:s,destroyed:o,blockLen:i,outputLen:a}=this;return e=e,e.finished=s,e.destroyed=o,e.blockLen=i,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=n._cloneInto(e.iHash),e}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}}const pt=(r,e,t)=>new Ln(r,e).update(t).digest();pt.create=(r,e)=>new Ln(r,e);function Ji(r,e,t){return ne.hash(r),t===void 0&&(t=new Uint8Array(r.outputLen)),pt(r,Je(t),Je(e))}const Lt=new Uint8Array([0]),qr=new Uint8Array;function Zi(r,e,t,n=32){if(ne.hash(r),ne.number(n),n>255*r.outputLen)throw new Error("Length should be <= 255*HashLen");const s=Math.ceil(n/r.outputLen);t===void 0&&(t=qr);const o=new Uint8Array(s*r.outputLen),i=pt.create(r,e),a=i._cloneInto(),c=new Uint8Array(i.outputLen);for(let l=0;l<s;l++)Lt[0]=l+1,a.update(l===0?qr:c).update(t).update(Lt).digestInto(c),o.set(c,r.outputLen*l),i._cloneInto(a);return i.destroy(),a.destroy(),c.fill(0),Lt.fill(0),o.slice(0,n)}var Yi=Object.defineProperty,U=(r,e)=>{for(var t in e)Yi(r,t,{get:e[t],enumerable:!0})},ve=Symbol("verified"),Xi=r=>r instanceof Object;function yt(r){if(!Xi(r)||typeof r.kind!="number"||typeof r.content!="string"||typeof r.created_at!="number"||typeof r.pubkey!="string"||!r.pubkey.match(/^[a-f0-9]{64}$/)||!Array.isArray(r.tags))return!1;for(let e=0;e<r.tags.length;e++){let t=r.tags[e];if(!Array.isArray(t))return!1;for(let n=0;n<t.length;n++)if(typeof t[n]!="string")return!1}return!0}function Qi(r){return r.sort((e,t)=>e.created_at!==t.created_at?t.created_at-e.created_at:e.id.localeCompare(t.id))}var _n={};U(_n,{Queue:()=>Dn,QueueNode:()=>$n,binarySearch:()=>or,bytesToHex:()=>G,hexToBytes:()=>xe,insertEventIntoAscendingList:()=>ta,insertEventIntoDescendingList:()=>ea,normalizeURL:()=>_e,utf8Decoder:()=>ce,utf8Encoder:()=>Q});var ce=new TextDecoder("utf-8"),Q=new TextEncoder;function _e(r){try{r.indexOf("://")===-1&&(r="wss://"+r);let e=new URL(r);return e.pathname=e.pathname.replace(/\/+/g,"/"),e.pathname.endsWith("/")&&(e.pathname=e.pathname.slice(0,-1)),(e.port==="80"&&e.protocol==="ws:"||e.port==="443"&&e.protocol==="wss:")&&(e.port=""),e.searchParams.sort(),e.hash="",e.toString()}catch{throw new Error(`Invalid URL: ${r}`)}}function ea(r,e){const[t,n]=or(r,s=>e.id===s.id?0:e.created_at===s.created_at?-1:s.created_at-e.created_at);return n||r.splice(t,0,e),r}function ta(r,e){const[t,n]=or(r,s=>e.id===s.id?0:e.created_at===s.created_at?-1:e.created_at-s.created_at);return n||r.splice(t,0,e),r}function or(r,e){let t=0,n=r.length-1;for(;t<=n;){const s=Math.floor((t+n)/2),o=e(r[s]);if(o===0)return[s,!0];o<0?n=s-1:t=s+1}return[t,!1]}var $n=class{constructor(r){P(this,"value");P(this,"next",null);P(this,"prev",null);this.value=r}},Dn=class{constructor(){P(this,"first");P(this,"last");this.first=null,this.last=null}enqueue(r){const e=new $n(r);return this.last?this.last===this.first?(this.last=e,this.last.prev=this.first,this.first.next=e):(e.prev=this.last,this.last.next=e,this.last=e):(this.first=e,this.last=e),!0}dequeue(){if(!this.first)return null;if(this.first===this.last){const e=this.first;return this.first=null,this.last=null,e.value}const r=this.first;return this.first=r.next,this.first&&(this.first.prev=null),r.value}},ra=class{generateSecretKey(){return Ve.utils.randomPrivateKey()}getPublicKey(r){return G(Ve.getPublicKey(r))}finalizeEvent(r,e){const t=r;return t.pubkey=G(Ve.getPublicKey(e)),t.id=$e(t),t.sig=G(Ve.sign($e(t),e)),t[ve]=!0,t}verifyEvent(r){if(typeof r[ve]=="boolean")return r[ve];const e=$e(r);if(e!==r.id)return r[ve]=!1,!1;try{const t=Ve.verify(r.sig,e,r.pubkey);return r[ve]=t,t}catch{return r[ve]=!1,!1}}};function Bn(r){if(!yt(r))throw new Error("can't serialize event with wrong or missing properties");return JSON.stringify([0,r.pubkey,r.created_at,r.kind,r.tags,r.content])}function $e(r){let e=Ge(Q.encode(Bn(r)));return G(e)}var gt=new ra,ir=gt.generateSecretKey,Oe=gt.getPublicKey,J=gt.finalizeEvent,Fe=gt.verifyEvent,Kn={};U(Kn,{Application:()=>tc,BadgeAward:()=>ha,BadgeDefinition:()=>Wa,BlockedRelaysList:()=>Ca,BookmarkList:()=>Ia,Bookmarksets:()=>Va,Calendar:()=>cc,CalendarEventRSVP:()=>lc,ChannelCreation:()=>qn,ChannelHideMessage:()=>zn,ChannelMessage:()=>jn,ChannelMetadata:()=>Vn,ChannelMuteUser:()=>Wn,ClassifiedListing:()=>sc,ClientAuth:()=>Zn,CommunitiesList:()=>Ma,CommunityDefinition:()=>dc,CommunityPostApproval:()=>ba,Contacts:()=>aa,CreateOrUpdateProduct:()=>Ya,CreateOrUpdateStall:()=>Za,Curationsets:()=>ja,Date:()=>ic,DirectMessageRelaysList:()=>Da,DraftClassifiedListing:()=>oc,DraftLong:()=>Qa,Emojisets:()=>ec,EncryptedDirectMessage:()=>ca,EventDeletion:()=>la,FileMetadata:()=>da,FileServerPreference:()=>Ba,Followsets:()=>Ha,GenericRepost:()=>lr,Genericlists:()=>Fa,GiftWrap:()=>Jn,HTTPAuth:()=>hr,Handlerinformation:()=>uc,Handlerrecommendation:()=>hc,Highlights:()=>Ra,InterestsList:()=>_a,Interestsets:()=>Ja,JobFeedback:()=>Ea,JobRequest:()=>va,JobResult:()=>wa,Label:()=>ma,LightningPubRPC:()=>Oa,LiveChatMessage:()=>fa,LiveEvent:()=>rc,LongFormArticle:()=>Xa,Metadata:()=>oa,Mutelist:()=>Pa,NWCWalletInfo:()=>Ka,NWCWalletRequest:()=>Yn,NWCWalletResponse:()=>Ua,NostrConnect:()=>Ga,OpenTimestamps:()=>ua,Pinlist:()=>Na,PrivateDirectMessage:()=>Fn,ProblemTracker:()=>pa,ProfileBadges:()=>za,PublicChatsList:()=>Aa,Reaction:()=>cr,RecommendRelay:()=>ia,RelayList:()=>Ta,Relaysets:()=>qa,Report:()=>ya,Reporting:()=>ga,Repost:()=>ar,Seal:()=>Hn,SearchRelaysList:()=>La,ShortTextNote:()=>Gn,Time:()=>ac,UserEmojiList:()=>$a,UserStatuses:()=>nc,Zap:()=>ka,ZapGoal:()=>Sa,ZapRequest:()=>xa,classifyKind:()=>na,isAddressableKind:()=>bt,isEphemeralKind:()=>Un,isKind:()=>sa,isRegularKind:()=>On,isReplaceableKind:()=>mt});function On(r){return 1e3<=r&&r<1e4||[1,2,4,5,6,7,8,16,40,41,42,43,44].includes(r)}function mt(r){return[0,3].includes(r)||1e4<=r&&r<2e4}function Un(r){return 2e4<=r&&r<3e4}function bt(r){return 3e4<=r&&r<4e4}function na(r){return On(r)?"regular":mt(r)?"replaceable":Un(r)?"ephemeral":bt(r)?"parameterized":"unknown"}function sa(r,e){const t=e instanceof Array?e:[e];return yt(r)&&t.includes(r.kind)||!1}var oa=0,Gn=1,ia=2,aa=3,ca=4,la=5,ar=6,cr=7,ha=8,Hn=13,Fn=14,lr=16,qn=40,Vn=41,jn=42,zn=43,Wn=44,ua=1040,Jn=1059,da=1063,fa=1311,pa=1971,ya=1984,ga=1984,ma=1985,ba=4550,va=5999,wa=6999,Ea=7e3,Sa=9041,xa=9734,ka=9735,Ra=9802,Pa=1e4,Na=10001,Ta=10002,Ia=10003,Ma=10004,Aa=10005,Ca=10006,La=10007,_a=10015,$a=10030,Da=10050,Ba=10096,Ka=13194,Oa=21e3,Zn=22242,Yn=23194,Ua=23195,Ga=24133,hr=27235,Ha=3e4,Fa=30001,qa=30002,Va=30003,ja=30004,za=30008,Wa=30009,Ja=30015,Za=30017,Ya=30018,Xa=30023,Qa=30024,ec=30030,tc=30078,rc=30311,nc=30315,sc=30402,oc=30403,ic=31922,ac=31923,cc=31924,lc=31925,hc=31989,uc=31990,dc=34550;function Xn(r,e){if(r.ids&&r.ids.indexOf(e.id)===-1||r.kinds&&r.kinds.indexOf(e.kind)===-1||r.authors&&r.authors.indexOf(e.pubkey)===-1)return!1;for(let t in r)if(t[0]==="#"){let n=t.slice(1),s=r[`#${n}`];if(s&&!e.tags.find(([o,i])=>o===t.slice(1)&&s.indexOf(i)!==-1))return!1}return!(r.since&&e.created_at<r.since||r.until&&e.created_at>r.until)}function Qn(r,e){for(let t=0;t<r.length;t++)if(Xn(r[t],e))return!0;return!1}function fc(...r){let e={};for(let t=0;t<r.length;t++){let n=r[t];Object.entries(n).forEach(([s,o])=>{if(s==="kinds"||s==="ids"||s==="authors"||s[0]==="#"){e[s]=e[s]||[];for(let i=0;i<o.length;i++){let a=o[i];e[s].includes(a)||e[s].push(a)}}}),n.limit&&(!e.limit||n.limit>e.limit)&&(e.limit=n.limit),n.until&&(!e.until||n.until>e.until)&&(e.until=n.until),n.since&&(!e.since||n.since<e.since)&&(e.since=n.since)}return e}function pc(r){if(r.ids&&!r.ids.length||r.kinds&&!r.kinds.length||r.authors&&!r.authors.length)return 0;for(const[e,t]of Object.entries(r))if(e[0]==="#"&&Array.isArray(t)&&!t.length)return 0;return Math.min(Math.max(0,r.limit??1/0),r.ids?.length??1/0,r.authors?.length&&r.kinds?.every(e=>mt(e))?r.authors.length*r.kinds.length:1/0,r.authors?.length&&r.kinds?.every(e=>bt(e))&&r["#d"]?.length?r.authors.length*r.kinds.length*r["#d"].length:1/0)}var es={};U(es,{getHex64:()=>vt,getInt:()=>ts,getSubscriptionId:()=>rs,matchEventId:()=>yc,matchEventKind:()=>mc,matchEventPubkey:()=>gc});function vt(r,e){let t=e.length+3,n=r.indexOf(`"${e}":`)+t,s=r.slice(n).indexOf('"')+n+1;return r.slice(s,s+64)}function ts(r,e){let t=e.length,n=r.indexOf(`"${e}":`)+t+3,s=r.slice(n),o=Math.min(s.indexOf(","),s.indexOf("}"));return parseInt(s.slice(0,o),10)}function rs(r){let e=r.slice(0,22).indexOf('"EVENT"');if(e===-1)return null;let t=r.slice(e+7+1).indexOf('"');if(t===-1)return null;let n=e+7+1+t,s=r.slice(n+1,80).indexOf('"');if(s===-1)return null;let o=n+1+s;return r.slice(n+1,o)}function yc(r,e){return e===vt(r,"id")}function gc(r,e){return e===vt(r,"pubkey")}function mc(r,e){return e===ts(r,"kind")}var ns={};U(ns,{makeAuthEvent:()=>ss});function ss(r,e){return{kind:Zn,created_at:Math.floor(Date.now()/1e3),tags:[["relay",r],["challenge",e]],content:""}}async function bc(){return new Promise(r=>{const e=new MessageChannel,t=()=>{e.port1.removeEventListener("message",t),r()};e.port1.addEventListener("message",t),e.port2.postMessage(0),e.port1.start()})}var vc=r=>(r[ve]=!0,!0),os=class extends Error{constructor(r,e){super(`Tried to send message '${r} on a closed connection to ${e}.`),this.name="SendingOnClosedConnection"}},ur=class{constructor(r,e){P(this,"url");P(this,"_connected",!1);P(this,"onclose",null);P(this,"onnotice",r=>console.debug(`NOTICE from ${this.url}: ${r}`));P(this,"baseEoseTimeout",4400);P(this,"connectionTimeout",4400);P(this,"publishTimeout",4400);P(this,"openSubs",new Map);P(this,"connectionTimeoutHandle");P(this,"connectionPromise");P(this,"openCountRequests",new Map);P(this,"openEventPublishes",new Map);P(this,"ws");P(this,"incomingMessageQueue",new Dn);P(this,"queueRunning",!1);P(this,"challenge");P(this,"authPromise");P(this,"serial",0);P(this,"verifyEvent");P(this,"_WebSocket");this.url=_e(r),this.verifyEvent=e.verifyEvent,this._WebSocket=e.websocketImplementation||WebSocket}static async connect(r,e){const t=new ur(r,e);return await t.connect(),t}closeAllSubscriptions(r){for(let[e,t]of this.openSubs)t.close(r);this.openSubs.clear();for(let[e,t]of this.openEventPublishes)t.reject(new Error(r));this.openEventPublishes.clear();for(let[e,t]of this.openCountRequests)t.reject(new Error(r));this.openCountRequests.clear()}get connected(){return this._connected}async connect(){return this.connectionPromise?this.connectionPromise:(this.challenge=void 0,this.authPromise=void 0,this.connectionPromise=new Promise((r,e)=>{this.connectionTimeoutHandle=setTimeout(()=>{e("connection timed out"),this.connectionPromise=void 0,this.onclose?.(),this.closeAllSubscriptions("relay connection timed out")},this.connectionTimeout);try{this.ws=new this._WebSocket(this.url)}catch(t){clearTimeout(this.connectionTimeoutHandle),e(t);return}this.ws.onopen=()=>{clearTimeout(this.connectionTimeoutHandle),this._connected=!0,r()},this.ws.onerror=t=>{clearTimeout(this.connectionTimeoutHandle),e(t.message||"websocket error"),this._connected&&(this._connected=!1,this.connectionPromise=void 0,this.onclose?.(),this.closeAllSubscriptions("relay connection errored"))},this.ws.onclose=t=>{clearTimeout(this.connectionTimeoutHandle),e(t.message||"websocket closed"),this._connected&&(this._connected=!1,this.connectionPromise=void 0,this.onclose?.(),this.closeAllSubscriptions("relay connection closed"))},this.ws.onmessage=this._onmessage.bind(this)}),this.connectionPromise)}async runQueue(){for(this.queueRunning=!0;this.handleNext()!==!1;)await bc();this.queueRunning=!1}handleNext(){const r=this.incomingMessageQueue.dequeue();if(!r)return!1;const e=rs(r);if(e){const t=this.openSubs.get(e);if(!t)return;const n=vt(r,"id"),s=t.alreadyHaveEvent?.(n);if(t.receivedEvent?.(this,n),s)return}try{let t=JSON.parse(r);switch(t[0]){case"EVENT":{const n=this.openSubs.get(t[1]),s=t[2];this.verifyEvent(s)&&Qn(n.filters,s)&&n.onevent(s);return}case"COUNT":{const n=t[1],s=t[2],o=this.openCountRequests.get(n);o&&(o.resolve(s.count),this.openCountRequests.delete(n));return}case"EOSE":{const n=this.openSubs.get(t[1]);if(!n)return;n.receivedEose();return}case"OK":{const n=t[1],s=t[2],o=t[3],i=this.openEventPublishes.get(n);i&&(clearTimeout(i.timeout),s?i.resolve(o):i.reject(new Error(o)),this.openEventPublishes.delete(n));return}case"CLOSED":{const n=t[1],s=this.openSubs.get(n);if(!s)return;s.closed=!0,s.close(t[2]);return}case"NOTICE":this.onnotice(t[1]);return;case"AUTH":{this.challenge=t[1];return}}}catch{return}}async send(r){if(!this.connectionPromise)throw new os(r,this.url);this.connectionPromise.then(()=>{this.ws?.send(r)})}async auth(r){const e=this.challenge;if(!e)throw new Error("can't perform auth, no challenge was received");return this.authPromise?this.authPromise:(this.authPromise=new Promise(async(t,n)=>{try{let s=await r(ss(this.url,e)),o=setTimeout(()=>{let i=this.openEventPublishes.get(s.id);i&&(i.reject(new Error("auth timed out")),this.openEventPublishes.delete(s.id))},this.publishTimeout);this.openEventPublishes.set(s.id,{resolve:t,reject:n,timeout:o}),this.send('["AUTH",'+JSON.stringify(s)+"]")}catch(s){console.warn("subscribe auth function failed:",s)}}),this.authPromise)}async publish(r){const e=new Promise((t,n)=>{const s=setTimeout(()=>{const o=this.openEventPublishes.get(r.id);o&&(o.reject(new Error("publish timed out")),this.openEventPublishes.delete(r.id))},this.publishTimeout);this.openEventPublishes.set(r.id,{resolve:t,reject:n,timeout:s})});return this.send('["EVENT",'+JSON.stringify(r)+"]"),e}async count(r,e){this.serial++;const t=e?.id||"count:"+this.serial,n=new Promise((s,o)=>{this.openCountRequests.set(t,{resolve:s,reject:o})});return this.send('["COUNT","'+t+'",'+JSON.stringify(r).substring(1)),n}subscribe(r,e){const t=this.prepareSubscription(r,e);return t.fire(),t}prepareSubscription(r,e){this.serial++;const t=e.id||(e.label?e.label+":":"sub:")+this.serial,n=new wc(this,t,r,e);return this.openSubs.set(t,n),n}close(){this.closeAllSubscriptions("relay connection closed by us"),this._connected=!1,this.ws?.close()}_onmessage(r){this.incomingMessageQueue.enqueue(r.data),this.queueRunning||this.runQueue()}},wc=class{constructor(r,e,t,n){P(this,"relay");P(this,"id");P(this,"closed",!1);P(this,"eosed",!1);P(this,"filters");P(this,"alreadyHaveEvent");P(this,"receivedEvent");P(this,"onevent");P(this,"oneose");P(this,"onclose");P(this,"eoseTimeout");P(this,"eoseTimeoutHandle");this.relay=r,this.filters=t,this.id=e,this.alreadyHaveEvent=n.alreadyHaveEvent,this.receivedEvent=n.receivedEvent,this.eoseTimeout=n.eoseTimeout||r.baseEoseTimeout,this.oneose=n.oneose,this.onclose=n.onclose,this.onevent=n.onevent||(s=>{console.warn(`onevent() callback not defined for subscription '${this.id}' in relay ${this.relay.url}. event received:`,s)})}fire(){this.relay.send('["REQ","'+this.id+'",'+JSON.stringify(this.filters).substring(1)),this.eoseTimeoutHandle=setTimeout(this.receivedEose.bind(this),this.eoseTimeout)}receivedEose(){this.eosed||(clearTimeout(this.eoseTimeoutHandle),this.eosed=!0,this.oneose?.())}close(r="closed by caller"){if(!this.closed&&this.relay.connected){try{this.relay.send('["CLOSE",'+JSON.stringify(this.id)+"]")}catch(e){if(!(e instanceof os))throw e}this.closed=!0}this.relay.openSubs.delete(this.id),this.onclose?.(r)}},is;try{is=WebSocket}catch{}var as=class extends ur{constructor(r){super(r,{verifyEvent:Fe,websocketImplementation:is})}static async connect(r){const e=new as(r);return await e.connect(),e}},Ec=class{constructor(r){P(this,"relays",new Map);P(this,"seenOn",new Map);P(this,"trackRelays",!1);P(this,"verifyEvent");P(this,"trustedRelayURLs",new Set);P(this,"_WebSocket");this.verifyEvent=r.verifyEvent,this._WebSocket=r.websocketImplementation}async ensureRelay(r,e){r=_e(r);let t=this.relays.get(r);return t||(t=new ur(r,{verifyEvent:this.trustedRelayURLs.has(r)?vc:this.verifyEvent,websocketImplementation:this._WebSocket}),e?.connectionTimeout&&(t.connectionTimeout=e.connectionTimeout),this.relays.set(r,t)),await t.connect(),t}close(r){r.map(_e).forEach(e=>{this.relays.get(e)?.close()})}subscribe(r,e,t){return t.onauth=t.onauth||t.doauth,this.subscribeMap(r.map(n=>({url:n,filter:e})),t)}subscribeMany(r,e,t){return t.onauth=t.onauth||t.doauth,this.subscribeMap(r.flatMap(n=>e.map(s=>({url:n,filter:s}))),t)}subscribeMap(r,e){e.onauth=e.onauth||e.doauth,this.trackRelays&&(e.receivedEvent=(h,u)=>{let p=this.seenOn.get(u);p||(p=new Set,this.seenOn.set(u,p)),p.add(h)});const t=new Set,n=[],s=[];let o=h=>{s[h]||(s[h]=!0,s.filter(u=>u).length===r.length&&(e.oneose?.(),o=()=>{}))};const i=[];let a=(h,u)=>{i[h]||(o(h),i[h]=u,i.filter(p=>p).length===r.length&&(e.onclose?.(i),a=()=>{}))};const c=h=>{if(e.alreadyHaveEvent?.(h))return!0;const u=t.has(h);return t.add(h),u},l=Promise.all(r.map(async({url:h,filter:u},p)=>{h=_e(h);let b;try{b=await this.ensureRelay(h,{connectionTimeout:e.maxWait?Math.max(e.maxWait*.8,e.maxWait-1e3):void 0})}catch(d){a(p,d?.message||String(d));return}let g=b.subscribe([u],{...e,oneose:()=>o(p),onclose:d=>{d.startsWith("auth-required: ")&&e.onauth?b.auth(e.onauth).then(()=>{b.subscribe([u],{...e,oneose:()=>o(p),onclose:f=>{a(p,f)},alreadyHaveEvent:c,eoseTimeout:e.maxWait})}).catch(f=>{a(p,`auth was required and attempted, but failed with: ${f}`)}):a(p,d)},alreadyHaveEvent:c,eoseTimeout:e.maxWait});n.push(g)}));return{async close(h){await l,n.forEach(u=>{u.close(h)})}}}subscribeEose(r,e,t){t.onauth=t.onauth||t.doauth;const n=this.subscribe(r,e,{...t,oneose(){n.close("closed automatically on eose")}});return n}subscribeManyEose(r,e,t){t.onauth=t.onauth||t.doauth;const n=this.subscribeMany(r,e,{...t,oneose(){n.close("closed automatically on eose")}});return n}async querySync(r,e,t){return new Promise(async n=>{const s=[];this.subscribeEose(r,e,{...t,onevent(o){s.push(o)},onclose(o){n(s)}})})}async get(r,e,t){e.limit=1;const n=await this.querySync(r,e,t);return n.sort((s,o)=>o.created_at-s.created_at),n[0]||null}publish(r,e,t){return r.map(_e).map(async(n,s,o)=>{if(o.indexOf(n)!==s)return Promise.reject("duplicate url");let i=await this.ensureRelay(n);return i.publish(e).catch(async a=>{if(a instanceof Error&&a.message.startsWith("auth-required: ")&&t?.onauth)return await i.auth(t.onauth),i.publish(e);throw a}).then(a=>{if(this.trackRelays){let c=this.seenOn.get(e.id);c||(c=new Set,this.seenOn.set(e.id,c)),c.add(i)}return a})})}listConnectionStatus(){const r=new Map;return this.relays.forEach((e,t)=>r.set(t,e.connected)),r}destroy(){this.relays.forEach(r=>r.close()),this.relays=new Map}},cs;try{cs=WebSocket}catch{}var ls=class extends Ec{constructor(){super({verifyEvent:Fe,websocketImplementation:cs})}},Ne={};U(Ne,{BECH32_REGEX:()=>hs,Bech32MaxSize:()=>dr,NostrTypeGuard:()=>Sc,decode:()=>Ye,decodeNostrURI:()=>kc,encodeBytes:()=>Et,naddrEncode:()=>Mc,neventEncode:()=>Ic,noteEncode:()=>Nc,nprofileEncode:()=>Tc,npubEncode:()=>Pc,nsecEncode:()=>Rc});var Sc={isNProfile:r=>/^nprofile1[a-z\d]+$/.test(r||""),isNEvent:r=>/^nevent1[a-z\d]+$/.test(r||""),isNAddr:r=>/^naddr1[a-z\d]+$/.test(r||""),isNSec:r=>/^nsec1[a-z\d]{58}$/.test(r||""),isNPub:r=>/^npub1[a-z\d]{58}$/.test(r||""),isNote:r=>/^note1[a-z\d]+$/.test(r||""),isNcryptsec:r=>/^ncryptsec1[a-z\d]+$/.test(r||"")},dr=5e3,hs=/[\x21-\x7E]{1,83}1[023456789acdefghjklmnpqrstuvwxyz]{6,}/;function xc(r){const e=new Uint8Array(4);return e[0]=r>>24&255,e[1]=r>>16&255,e[2]=r>>8&255,e[3]=r&255,e}function kc(r){try{return r.startsWith("nostr:")&&(r=r.substring(6)),Ye(r)}catch{return{type:"invalid",data:null}}}function Ye(r){let{prefix:e,words:t}=oe.decode(r,dr),n=new Uint8Array(oe.fromWords(t));switch(e){case"nprofile":{let s=_t(n);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:G(s[0][0]),relays:s[1]?s[1].map(o=>ce.decode(o)):[]}}}case"nevent":{let s=_t(n);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:G(s[0][0]),relays:s[1]?s[1].map(o=>ce.decode(o)):[],author:s[2]?.[0]?G(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(G(s[3][0]),16):void 0}}}case"naddr":{let s=_t(n);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:ce.decode(s[0][0]),pubkey:G(s[2][0]),kind:parseInt(G(s[3][0]),16),relays:s[1]?s[1].map(o=>ce.decode(o)):[]}}}case"nsec":return{type:e,data:n};case"npub":case"note":return{type:e,data:G(n)};default:throw new Error(`unknown prefix ${e}`)}}function _t(r){let e={},t=r;for(;t.length>0;){let n=t[0],s=t[1],o=t.slice(2,2+s);if(t=t.slice(2+s),o.length<s)throw new Error(`not enough data to read on TLV ${n}`);e[n]=e[n]||[],e[n].push(o)}return e}function Rc(r){return Et("nsec",r)}function Pc(r){return Et("npub",xe(r))}function Nc(r){return Et("note",xe(r))}function wt(r,e){let t=oe.toWords(e);return oe.encode(r,t,dr)}function Et(r,e){return wt(r,e)}function Tc(r){let e=fr({0:[xe(r.pubkey)],1:(r.relays||[]).map(t=>Q.encode(t))});return wt("nprofile",e)}function Ic(r){let e;r.kind!==void 0&&(e=xc(r.kind));let t=fr({0:[xe(r.id)],1:(r.relays||[]).map(n=>Q.encode(n)),2:r.author?[xe(r.author)]:[],3:e?[new Uint8Array(e)]:[]});return wt("nevent",t)}function Mc(r){let e=new ArrayBuffer(4);new DataView(e).setUint32(0,r.kind,!1);let t=fr({0:[Q.encode(r.identifier)],1:(r.relays||[]).map(n=>Q.encode(n)),2:[xe(r.pubkey)],3:[new Uint8Array(e)]});return wt("naddr",t)}function fr(r){let e=[];return Object.entries(r).reverse().forEach(([t,n])=>{n.forEach(s=>{let o=new Uint8Array(s.length+2);o.set([parseInt(t)],0),o.set([s.length],1),o.set(s,2),e.push(o)})}),dt(...e)}var Ac=/\bnostr:((note|npub|naddr|nevent|nprofile)1\w+)\b|#\[(\d+)\]/g;function Cc(r){let e=[];for(let t of r.content.matchAll(Ac))if(t[2])try{let{type:n,data:s}=Ye(t[1]);switch(n){case"npub":{e.push({text:t[0],profile:{pubkey:s,relays:[]}});break}case"nprofile":{e.push({text:t[0],profile:s});break}case"note":{e.push({text:t[0],event:{id:s,relays:[]}});break}case"nevent":{e.push({text:t[0],event:s});break}case"naddr":{e.push({text:t[0],address:s});break}}}catch{}else if(t[3]){let n=parseInt(t[3],10),s=r.tags[n];if(!s)continue;switch(s[0]){case"p":{e.push({text:t[0],profile:{pubkey:s[1],relays:s[2]?[s[2]]:[]}});break}case"e":{e.push({text:t[0],event:{id:s[1],relays:s[2]?[s[2]]:[]}});break}case"a":{try{let[o,i,a]=s[1].split(":");e.push({text:t[0],address:{identifier:a,pubkey:i,kind:parseInt(o,10),relays:s[2]?[s[2]]:[]}})}catch{}break}}}return e}var ze={};U(ze,{decrypt:()=>Lc,encrypt:()=>us});function us(r,e,t){const n=r instanceof Uint8Array?G(r):r,s=Ue.getSharedSecret(n,"02"+e),o=ds(s);let i=Uint8Array.from(bn(16)),a=Q.encode(t),c=Tn(o,i).encrypt(a),l=le.encode(new Uint8Array(c)),h=le.encode(new Uint8Array(i.buffer));return`${l}?iv=${h}`}function Lc(r,e,t){const n=r instanceof Uint8Array?G(r):r;let[s,o]=t.split("?iv="),i=Ue.getSharedSecret(n,"02"+e),a=ds(i),c=le.decode(o),l=le.decode(s),h=Tn(a,c).decrypt(l);return ce.decode(h)}function ds(r){return r.slice(1,33)}var fs={};U(fs,{NIP05_REGEX:()=>pr,isNip05:()=>_c,isValid:()=>Bc,queryProfile:()=>ps,searchDomain:()=>Dc,useFetchImplementation:()=>$c});var pr=/^(?:([\w.+-]+)@)?([\w_-]+(\.[\w_-]+)+)$/,_c=r=>pr.test(r||""),St;try{St=fetch}catch{}function $c(r){St=r}async function Dc(r,e=""){try{const t=`https://${r}/.well-known/nostr.json?name=${e}`,n=await St(t,{redirect:"manual"});if(n.status!==200)throw Error("Wrong response code");return(await n.json()).names}catch{return{}}}async function ps(r){const e=r.match(pr);if(!e)return null;const[,t="_",n]=e;try{const s=`https://${n}/.well-known/nostr.json?name=${t}`,o=await St(s,{redirect:"manual"});if(o.status!==200)throw Error("Wrong response code");const i=await o.json(),a=i.names[t];return a?{pubkey:a,relays:i.relays?.[a]}:null}catch{return null}}async function Bc(r,e){const t=await ps(e);return t?t.pubkey===r:!1}var ys={};U(ys,{parse:()=>Kc});function Kc(r){const e={reply:void 0,root:void 0,mentions:[],profiles:[],quotes:[]};let t,n;for(let s=r.tags.length-1;s>=0;s--){const o=r.tags[s];if(o[0]==="e"&&o[1]){const[i,a,c,l,h]=o,u={id:a,relays:c?[c]:[],author:h};if(l==="root"){e.root=u;continue}if(l==="reply"){e.reply=u;continue}if(l==="mention"){e.mentions.push(u);continue}t?n=u:t=u,e.mentions.push(u);continue}if(o[0]==="q"&&o[1]){const[i,a,c]=o;e.quotes.push({id:a,relays:c?[c]:[]})}if(o[0]==="p"&&o[1]){e.profiles.push({pubkey:o[1],relays:o[2]?[o[2]]:[]});continue}}return e.root||(e.root=n||t||e.reply),e.reply||(e.reply=t||e.root),[e.reply,e.root].forEach(s=>{if(!s)return;let o=e.mentions.indexOf(s);if(o!==-1&&e.mentions.splice(o,1),s.author){let i=e.profiles.find(a=>a.pubkey===s.author);i&&i.relays&&(s.relays||(s.relays=[]),i.relays.forEach(a=>{s.relays?.indexOf(a)===-1&&s.relays.push(a)}),i.relays=s.relays)}}),e.mentions.forEach(s=>{if(s.author){let o=e.profiles.find(i=>i.pubkey===s.author);o&&o.relays&&(s.relays||(s.relays=[]),o.relays.forEach(i=>{s.relays.indexOf(i)===-1&&s.relays.push(i)}),o.relays=s.relays)}}),e}var gs={};U(gs,{fetchRelayInformation:()=>Uc,useFetchImplementation:()=>Oc});var ms;try{ms=fetch}catch{}function Oc(r){ms=r}async function Uc(r){return await(await fetch(r.replace("ws://","http://").replace("wss://","https://"),{headers:{Accept:"application/nostr+json"}})).json()}var bs={};U(bs,{fastEventHash:()=>ws,getPow:()=>vs,minePow:()=>Gc});function vs(r){let e=0;for(let t=0;t<64;t+=8){const n=parseInt(r.substring(t,t+8),16);if(n===0)e+=32;else{e+=Math.clz32(n);break}}return e}function Gc(r,e){let t=0;const n=r,s=["nonce",t.toString(),e.toString()];for(n.tags.push(s);;){const o=Math.floor(new Date().getTime()/1e3);if(o!==n.created_at&&(t=0,n.created_at=o),s[1]=(++t).toString(),n.id=ws(n),vs(n.id)>=e)break}return n}function ws(r){return G(Ge(Q.encode(JSON.stringify([0,r.pubkey,r.created_at,r.kind,r.tags,r.content]))))}var Es={};U(Es,{unwrapEvent:()=>Yc,unwrapManyEvents:()=>Xc,wrapEvent:()=>Ds,wrapManyEvents:()=>Zc});var Ss={};U(Ss,{createRumor:()=>Cs,createSeal:()=>Ls,createWrap:()=>_s,unwrapEvent:()=>vr,unwrapManyEvents:()=>$s,wrapEvent:()=>at,wrapManyEvents:()=>Wc});var xs={};U(xs,{decrypt:()=>br,encrypt:()=>mr,getConversationKey:()=>yr,v2:()=>jc});var ks=1,Rs=65535;function yr(r,e){const t=Ue.getSharedSecret(r,"02"+e).subarray(1,33);return Ji(Ge,t,"nip44-v2")}function Ps(r,e){const t=Zi(Ge,r,e,76);return{chacha_key:t.subarray(0,32),chacha_nonce:t.subarray(32,44),hmac_key:t.subarray(44,76)}}function gr(r){if(!Number.isSafeInteger(r)||r<1)throw new Error("expected positive integer");if(r<=32)return 32;const e=1<<Math.floor(Math.log2(r-1))+1,t=e<=256?32:e/8;return t*(Math.floor((r-1)/t)+1)}function Hc(r){if(!Number.isSafeInteger(r)||r<ks||r>Rs)throw new Error("invalid plaintext size: must be between 1 and 65535 bytes");const e=new Uint8Array(2);return new DataView(e.buffer).setUint16(0,r,!1),e}function Fc(r){const e=Q.encode(r),t=e.length,n=Hc(t),s=new Uint8Array(gr(t)-t);return dt(n,e,s)}function qc(r){const e=new DataView(r.buffer).getUint16(0),t=r.subarray(2,2+e);if(e<ks||e>Rs||t.length!==e||r.length!==2+gr(e))throw new Error("invalid padding");return ce.decode(t)}function Ns(r,e,t){if(t.length!==32)throw new Error("AAD associated data must be 32 bytes");const n=dt(t,e);return pt(Ge,r,n)}function Vc(r){if(typeof r!="string")throw new Error("payload must be a valid string");const e=r.length;if(e<132||e>87472)throw new Error("invalid payload length: "+e);if(r[0]==="#")throw new Error("unknown encryption version");let t;try{t=le.decode(r)}catch(o){throw new Error("invalid base64: "+o.message)}const n=t.length;if(n<99||n>65603)throw new Error("invalid data length: "+n);const s=t[0];if(s!==2)throw new Error("unknown encryption version "+s);return{nonce:t.subarray(1,33),ciphertext:t.subarray(33,-32),mac:t.subarray(-32)}}function mr(r,e,t=bn(32)){const{chacha_key:n,chacha_nonce:s,hmac_key:o}=Ps(e,t),i=Fc(r),a=Cn(n,s,i),c=Ns(o,a,t);return le.encode(dt(new Uint8Array([2]),t,a,c))}function br(r,e){const{nonce:t,ciphertext:n,mac:s}=Vc(r),{chacha_key:o,chacha_nonce:i,hmac_key:a}=Ps(e,t),c=Ns(a,n,t);if(!Mi(c,s))throw new Error("invalid MAC");const l=Cn(o,i,n);return qc(l)}var jc={utils:{getConversationKey:yr,calcPaddedLen:gr},encrypt:mr,decrypt:br},zc=2*24*60*60,Ts=()=>Math.round(Date.now()/1e3),Is=()=>Math.round(Ts()-Math.random()*zc),Ms=(r,e)=>yr(r,e),As=(r,e,t)=>mr(JSON.stringify(r),Ms(e,t)),Vr=(r,e)=>JSON.parse(br(r.content,Ms(e,r.pubkey)));function Cs(r,e){const t={created_at:Ts(),content:"",tags:[],...r,pubkey:Oe(e)};return t.id=$e(t),t}function Ls(r,e,t){return J({kind:Hn,content:As(r,e,t),created_at:Is(),tags:[]},e)}function _s(r,e){const t=ir();return J({kind:Jn,content:As(r,t,e),created_at:Is(),tags:[["p",e]]},t)}function at(r,e,t){const n=Cs(r,e),s=Ls(n,e,t);return _s(s,t)}function Wc(r,e,t){if(!t||t.length===0)throw new Error("At least one recipient is required.");const n=Oe(e),s=[at(r,e,n)];return t.forEach(o=>{s.push(at(r,e,o))}),s}function vr(r,e){const t=Vr(r,e);return Vr(t,e)}function $s(r,e){let t=[];return r.forEach(n=>{t.push(vr(n,e))}),t.sort((n,s)=>n.created_at-s.created_at),t}function Jc(r,e,t,n){const s={created_at:Math.ceil(Date.now()/1e3),kind:Fn,tags:[],content:e};return(Array.isArray(r)?r:[r]).forEach(({publicKey:i,relayUrl:a})=>{s.tags.push(a?["p",i,a]:["p",i])}),n&&s.tags.push(["e",n.eventId,n.relayUrl||"","reply"]),t&&s.tags.push(["subject",t]),s}function Ds(r,e,t,n,s){const o=Jc(e,t,n,s);return at(o,r,e.publicKey)}function Zc(r,e,t,n,s){if(!e||e.length===0)throw new Error("At least one recipient is required.");return[{publicKey:Oe(r)},...e].map(i=>Ds(r,i,t,n,s))}var Yc=vr,Xc=$s,Bs={};U(Bs,{finishRepostEvent:()=>Qc,getRepostedEvent:()=>el,getRepostedEventPointer:()=>Ks});function Qc(r,e,t,n){let s;const o=[...r.tags??[],["e",e.id,t],["p",e.pubkey]];return e.kind===Gn?s=ar:(s=lr,o.push(["k",String(e.kind)])),J({kind:s,tags:o,content:r.content===""||e.tags?.find(i=>i[0]==="-")?"":JSON.stringify(e),created_at:r.created_at},n)}function Ks(r){if(![ar,lr].includes(r.kind))return;let e,t;for(let n=r.tags.length-1;n>=0&&(e===void 0||t===void 0);n--){const s=r.tags[n];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&t===void 0&&(t=s))}if(e!==void 0)return{id:e[1],relays:[e[2],t?.[2]].filter(n=>typeof n=="string"),author:t?.[1]}}function el(r,{skipVerification:e}={}){const t=Ks(r);if(t===void 0||r.content==="")return;let n;try{n=JSON.parse(r.content)}catch{return}if(n.id===t.id&&!(!e&&!Fe(n)))return n}var Os={};U(Os,{NOSTR_URI_REGEX:()=>wr,parse:()=>rl,test:()=>tl});var wr=new RegExp(`nostr:(${hs.source})`);function tl(r){return typeof r=="string"&&new RegExp(`^${wr.source}$`).test(r)}function rl(r){const e=r.match(new RegExp(`^${wr.source}$`));if(!e)throw new Error(`Invalid Nostr URI: ${r}`);return{uri:e[0],value:e[1],decoded:Ye(e[1])}}var Us={};U(Us,{finishReactionEvent:()=>nl,getReactedEventPointer:()=>sl});function nl(r,e,t){const n=e.tags.filter(s=>s.length>=2&&(s[0]==="e"||s[0]==="p"));return J({...r,kind:cr,tags:[...r.tags??[],...n,["e",e.id],["p",e.pubkey]],content:r.content??"+"},t)}function sl(r){if(r.kind!==cr)return;let e,t;for(let n=r.tags.length-1;n>=0&&(e===void 0||t===void 0);n--){const s=r.tags[n];s.length>=2&&(s[0]==="e"&&e===void 0?e=s:s[0]==="p"&&t===void 0&&(t=s))}if(!(e===void 0||t===void 0))return{id:e[1],relays:[e[2],t[2]].filter(n=>n!==void 0),author:t[1]}}var Gs={};U(Gs,{parse:()=>il});var ol=/\W/m,jr=/\W |\W$|$|,| /m;function*il(r){const e=r.length;let t=0,n=0;for(;n<e;){let s=r.indexOf(":",n);if(s===-1)break;if(r.substring(s-5,s)==="nostr"){const o=r.substring(s+60).match(ol),i=o?s+60+o.index:e;try{let a,{data:c,type:l}=Ye(r.substring(s+1,i));switch(l){case"npub":a={pubkey:c};break;case"nsec":case"note":n=i+1;continue;default:a=c}t!==s-5&&(yield{type:"text",text:r.substring(t,s-5)}),yield{type:"reference",pointer:a},n=i,t=n;continue}catch{n=s+1;continue}}else if(r.substring(s-5,s)==="https"||r.substring(s-4,s)==="http"){const o=r.substring(s+4).match(jr),i=o?s+4+o.index:e,a=r[s-1]==="s"?5:4;try{let c=new URL(r.substring(s-a,i));if(c.hostname.indexOf(".")===-1)throw new Error("invalid url");if(t!==s-a&&(yield{type:"text",text:r.substring(t,s-a)}),c.pathname.endsWith(".png")||c.pathname.endsWith(".jpg")||c.pathname.endsWith(".jpeg")||c.pathname.endsWith(".gif")||c.pathname.endsWith(".webp")){yield{type:"image",url:c.toString()},n=i,t=n;continue}if(c.pathname.endsWith(".mp4")||c.pathname.endsWith(".avi")||c.pathname.endsWith(".webm")||c.pathname.endsWith(".mkv")){yield{type:"video",url:c.toString()},n=i,t=n;continue}if(c.pathname.endsWith(".mp3")||c.pathname.endsWith(".aac")||c.pathname.endsWith(".ogg")||c.pathname.endsWith(".opus")){yield{type:"audio",url:c.toString()},n=i,t=n;continue}yield{type:"url",url:c.toString()},n=i,t=n;continue}catch{n=i+1;continue}}else if(r.substring(s-3,s)==="wss"||r.substring(s-2,s)==="ws"){const o=r.substring(s+4).match(jr),i=o?s+4+o.index:e,a=r[s-1]==="s"?3:2;try{let c=new URL(r.substring(s-a,i));if(c.hostname.indexOf(".")===-1)throw new Error("invalid ws url");t!==s-a&&(yield{type:"text",text:r.substring(t,s-a)}),yield{type:"relay",url:c.toString()},n=i,t=n;continue}catch{n=i+1;continue}}else{n=s+1;continue}}t!==e&&(yield{type:"text",text:r.substring(t)})}var Hs={};U(Hs,{channelCreateEvent:()=>al,channelHideMessageEvent:()=>hl,channelMessageEvent:()=>ll,channelMetadataEvent:()=>cl,channelMuteUserEvent:()=>ul});var al=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return J({kind:qn,tags:[...r.tags??[]],content:t,created_at:r.created_at},e)},cl=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return J({kind:Vn,tags:[["e",r.channel_create_event_id],...r.tags??[]],content:t,created_at:r.created_at},e)},ll=(r,e)=>{const t=[["e",r.channel_create_event_id,r.relay_url,"root"]];return r.reply_to_channel_message_event_id&&t.push(["e",r.reply_to_channel_message_event_id,r.relay_url,"reply"]),J({kind:jn,tags:[...t,...r.tags??[]],content:r.content,created_at:r.created_at},e)},hl=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return J({kind:zn,tags:[["e",r.channel_message_event_id],...r.tags??[]],content:t,created_at:r.created_at},e)},ul=(r,e)=>{let t;if(typeof r.content=="object")t=JSON.stringify(r.content);else if(typeof r.content=="string")t=r.content;else return;return J({kind:Wn,tags:[["p",r.pubkey_to_mute],...r.tags??[]],content:t,created_at:r.created_at},e)},Fs={};U(Fs,{EMOJI_SHORTCODE_REGEX:()=>qs,matchAll:()=>dl,regex:()=>Er,replaceAll:()=>fl});var qs=/:(\w+):/,Er=()=>new RegExp(`\\B${qs.source}\\B`,"g");function*dl(r){const e=r.matchAll(Er());for(const t of e)try{const[n,s]=t;yield{shortcode:n,name:s,start:t.index,end:t.index+n.length}}catch{}}function fl(r,e){return r.replaceAll(Er(),(t,n)=>e({shortcode:t,name:n}))}var Vs={};U(Vs,{useFetchImplementation:()=>pl,validateGithub:()=>yl});var Sr;try{Sr=fetch}catch{}function pl(r){Sr=r}async function yl(r,e,t){try{return await(await Sr(`https://gist.github.com/${e}/${t}/raw`)).text()===`Verifying that I control the following Nostr public key: ${r}`}catch{return!1}}var js={};U(js,{makeNwcRequestEvent:()=>ml,parseConnectionString:()=>gl});function gl(r){const{pathname:e,searchParams:t}=new URL(r),n=e,s=t.get("relay"),o=t.get("secret");if(!n||!s||!o)throw new Error("invalid connection string");return{pubkey:n,relay:s,secret:o}}async function ml(r,e,t){const s=us(e,r,JSON.stringify({method:"pay_invoice",params:{invoice:t}})),o={kind:Yn,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",r]]};return J(o,e)}var zs={};U(zs,{normalizeIdentifier:()=>bl});function bl(r){return r=r.trim().toLowerCase(),r=r.normalize("NFKC"),Array.from(r).map(e=>/\p{Letter}/u.test(e)||/\p{Number}/u.test(e)?e:"-").join("")}var Ws={};U(Ws,{getSatoshisAmountFromBolt11:()=>kl,getZapEndpoint:()=>wl,makeZapReceipt:()=>xl,makeZapRequest:()=>El,useFetchImplementation:()=>vl,validateZapRequest:()=>Sl});var xr;try{xr=fetch}catch{}function vl(r){xr=r}async function wl(r){try{let e="",{lud06:t,lud16:n}=JSON.parse(r.content);if(t){let{words:i}=oe.decode(t,1e3),a=oe.fromWords(i);e=ce.decode(a)}else if(n){let[i,a]=n.split("@");e=new URL(`/.well-known/lnurlp/${i}`,`https://${a}`).toString()}else return null;let o=await(await xr(e)).json();if(o.allowsNostr&&o.nostrPubkey)return o.callback}catch{}return null}function El({profile:r,event:e,amount:t,relays:n,comment:s=""}){if(!t)throw new Error("amount not given");if(!r)throw new Error("profile not given");let o={kind:9734,created_at:Math.round(Date.now()/1e3),content:s,tags:[["p",r],["amount",t.toString()],["relays",...n]]};if(e&&typeof e=="string"&&o.tags.push(["e",e]),e&&typeof e=="object"){if(mt(e.kind)){const i=["a",`${e.kind}:${e.pubkey}:`];o.tags.push(i)}else if(bt(e.kind)){let i=e.tags.find(([c,l])=>c==="d"&&l);if(!i)throw new Error("d tag not found or is empty");const a=["a",`${e.kind}:${e.pubkey}:${i[1]}`];o.tags.push(a)}}return o}function Sl(r){let e;try{e=JSON.parse(r)}catch{return"Invalid zap request JSON."}if(!yt(e))return"Zap request is not a valid Nostr event.";if(!Fe(e))return"Invalid signature on zap request.";let t=e.tags.find(([o,i])=>o==="p"&&i);if(!t)return"Zap request doesn't have a 'p' tag.";if(!t[1].match(/^[a-f0-9]{64}$/))return"Zap request 'p' tag is not valid hex.";let n=e.tags.find(([o,i])=>o==="e"&&i);return n&&!n[1].match(/^[a-f0-9]{64}$/)?"Zap request 'e' tag is not valid hex.":e.tags.find(([o,i])=>o==="relays"&&i)?null:"Zap request doesn't have a 'relays' tag."}function xl({zapRequest:r,preimage:e,bolt11:t,paidAt:n}){let s=JSON.parse(r),o=s.tags.filter(([a])=>a==="e"||a==="p"||a==="a"),i={kind:9735,created_at:Math.round(n.getTime()/1e3),content:"",tags:[...o,["P",s.pubkey],["bolt11",t],["description",r]]};return e&&i.tags.push(["preimage",e]),i}function kl(r){if(r.length<50)return 0;r=r.substring(0,50);const e=r.lastIndexOf("1");if(e===-1)return 0;const t=r.substring(0,e);if(!t.startsWith("lnbc"))return 0;const n=t.substring(4);if(n.length<1)return 0;const s=n[n.length-1],o=s.charCodeAt(0)-"0".charCodeAt(0),i=o>=0&&o<=9;let a=n.length-1;if(i&&a++,a<1)return 0;const c=parseInt(n.substring(0,a));switch(s){case"m":return c*1e5;case"u":return c*100;case"n":return c/10;case"p":return c/1e4;default:return c*1e8}}var Js={};U(Js,{getToken:()=>Rl,hashPayload:()=>kr,unpackEventFromToken:()=>Ys,validateEvent:()=>no,validateEventKind:()=>Qs,validateEventMethodTag:()=>to,validateEventPayloadTag:()=>ro,validateEventTimestamp:()=>Xs,validateEventUrlTag:()=>eo,validateToken:()=>Pl});var Zs="Nostr ";async function Rl(r,e,t,n=!1,s){const o={kind:hr,tags:[["u",r],["method",e]],created_at:Math.round(new Date().getTime()/1e3),content:""};s&&o.tags.push(["payload",kr(s)]);const i=await t(o);return(n?Zs:"")+le.encode(Q.encode(JSON.stringify(i)))}async function Pl(r,e,t){const n=await Ys(r).catch(o=>{throw o});return await no(n,e,t).catch(o=>{throw o})}async function Ys(r){if(!r)throw new Error("Missing token");r=r.replace(Zs,"");const e=ce.decode(le.decode(r));if(!e||e.length===0||!e.startsWith("{"))throw new Error("Invalid token");return JSON.parse(e)}function Xs(r){return r.created_at?Math.round(new Date().getTime()/1e3)-r.created_at<60:!1}function Qs(r){return r.kind===hr}function eo(r,e){const t=r.tags.find(n=>n[0]==="u");return t?t.length>0&&t[1]===e:!1}function to(r,e){const t=r.tags.find(n=>n[0]==="method");return t?t.length>0&&t[1].toLowerCase()===e.toLowerCase():!1}function kr(r){const e=Ge(Q.encode(JSON.stringify(r)));return G(e)}function ro(r,e){const t=r.tags.find(s=>s[0]==="payload");if(!t)return!1;const n=kr(e);return t.length>0&&t[1]===n}async function no(r,e,t,n){if(!Fe(r))throw new Error("Invalid nostr event, signature invalid");if(!Qs(r))throw new Error("Invalid nostr event, kind invalid");if(!Xs(r))throw new Error("Invalid nostr event, created_at timestamp invalid");if(!eo(r,e))throw new Error("Invalid nostr event, url tag invalid");if(!to(r,t))throw new Error("Invalid nostr event, method tag invalid");if(n&&typeof n=="object"&&Object.keys(n).length>0&&!ro(r,n))throw new Error("Invalid nostr event, payload tag does not match request body hash");return!0}const Nl=Object.freeze(Object.defineProperty({__proto__:null,Relay:as,SimplePool:ls,finalizeEvent:J,fj:es,generateSecretKey:ir,getEventHash:$e,getFilterLimit:pc,getPublicKey:Oe,kinds:Kn,matchFilter:Xn,matchFilters:Qn,mergeFilters:fc,nip04:ze,nip05:fs,nip10:ys,nip11:gs,nip13:bs,nip17:Es,nip18:Bs,nip19:Ne,nip21:Os,nip25:Us,nip27:Gs,nip28:Hs,nip30:Fs,nip39:Vs,nip42:ns,nip44:xs,nip47:js,nip54:zs,nip57:Ws,nip59:Ss,nip98:Js,parseReferences:Cc,serializeEvent:Bn,sortEvents:Qi,utils:_n,validateEvent:yt,verifiedSymbol:ve,verifyEvent:Fe},Symbol.toStringTag,{value:"Module"}));class Tl{constructor(){this.keyPair=null,this.profile=null,this.eventHandlers=new Map,this.storageKey="nostr_keys_v2",this.profileKey="nostr_profile_v2"}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}emit(e,t){(this.eventHandlers.get(e)||[]).forEach(s=>{try{s(t)}catch(o){console.error(`Error in KeyService event handler for ${e}:`,o)}})}off(e,t){const n=this.eventHandlers.get(e)||[],s=n.indexOf(t);s>-1&&n.splice(s,1)}async init(){return console.log("🔑 Initialisiere erweiterten KeyService..."),await this.loadKeys(),await this.loadProfile(),this.emit("initialized",{hasKeys:!!this.keyPair}),!0}async loadKeys(){try{const e=localStorage.getItem(this.storageKey);if(e){const t=JSON.parse(e);return this.keyPair=t,console.log("🔑 Schlüssel aus Storage geladen"),!0}return!1}catch(e){return console.error("❌ Fehler beim Laden der Schlüssel:",e),!1}}async loadProfile(){try{const e=localStorage.getItem(this.profileKey);return e?(this.profile=JSON.parse(e),console.log("👤 Profil aus Storage geladen"),!0):!1}catch(e){return console.error("❌ Fehler beim Laden des Profils:",e),!1}}async hasKeys(){try{return localStorage.getItem(this.storageKey)!==null}catch(e){return console.error("❌ Fehler beim Prüfen der Schlüssel:",e),!1}}async getKeyPair(){return this.keyPair?this.keyPair:(await this.loadKeys(),this.keyPair)}async getProfile(){return this.profile?this.profile:(await this.loadProfile(),this.profile)}async updateProfile(e){try{return this.profile={...this.profile,...e,updated:Date.now()},localStorage.setItem(this.profileKey,JSON.stringify(this.profile)),this.emit("profileUpdated",this.profile),console.log("👤 Profil aktualisiert:",this.profile),!0}catch(t){return console.error("❌ Fehler beim Aktualisieren des Profils:",t),!1}}async generateKeyPair(){try{console.log("🔑 Generiere neue Schlüssel...");const e=ir(),t=Oe(e),n=Ne.npubEncode(t),s=Ne.nsecEncode(e);return this.keyPair={secretKey:Array.from(e),publicKey:t,npub:n,nsec:s,created:Date.now()},localStorage.setItem(this.storageKey,JSON.stringify(this.keyPair)),await this.updateProfile({name:"NOSTR User",about:"New NOSTR user",created:Date.now()}),this.emit("keysGenerated",this.keyPair),console.log("✅ Neue Schlüssel generiert und gespeichert"),this.keyPair}catch(e){throw console.error("❌ Fehler beim Generieren der Schlüssel:",e),e}}async importKeys(e){try{if(console.log("🔑 Importiere Schlüssel..."),console.log("📝 Eingabe:",e),!e||typeof e!="string")throw new Error("Invalid nsec format: must be a string");if(e=e.trim().replace(/"/g,""),console.log("🧹 Bereinigt:",e),!e.startsWith("nsec1"))throw new Error("Invalid nsec format: must start with nsec1");if(e.length!==63)throw new Error(`Invalid nsec format: expected 63 characters, got ${e.length}`);const{type:t,data:n}=Ne.decode(e);if(t!=="nsec")throw new Error("Invalid nsec format: decoding failed");const s=n,o=Oe(s),i=Ne.npubEncode(o);return console.log("✅ Schlüssel erfolgreich dekodiert"),console.log("🔑 Public Key:",o),console.log("🔑 NPUB:",i),this.keyPair={secretKey:Array.from(s),publicKey:o,npub:i,nsec:e,imported:Date.now()},localStorage.setItem(this.storageKey,JSON.stringify(this.keyPair)),this.emit("keysImported",this.keyPair),console.log("✅ Schlüssel importiert und gespeichert"),this.keyPair}catch(t){throw console.error("❌ Fehler beim Importieren der Schlüssel:",t),t}}async exportKeys(){try{const e=await this.getKeyPair();if(!e)throw new Error("No keys available to export");return{nsec:e.nsec,npub:e.npub,created:e.created||e.imported}}catch(e){throw console.error("❌ Fehler beim Exportieren der Schlüssel:",e),e}}async deleteKeys(){try{return localStorage.removeItem(this.storageKey),localStorage.removeItem(this.profileKey),this.keyPair=null,this.profile=null,this.emit("keysDeleted"),console.log("🗑️ Schlüssel und Profil gelöscht"),!0}catch(e){return console.error("❌ Fehler beim Löschen der Schlüssel:",e),!1}}getFormattedPublicKey(){if(!this.keyPair)return null;const e=this.keyPair.npub;return e.slice(0,12)+"..."+e.slice(-8)}validateNsec(e){try{const{type:t}=Ne.decode(e);return t==="nsec"}catch{return!1}}getKeyStatus(){return{hasKeys:!!this.keyPair,hasProfile:!!this.profile,publicKey:this.keyPair?.npub,profileName:this.profile?.name}}async getPublicKey(){return(await this.getKeyPair())?.publicKey}async getNpub(){return(await this.getKeyPair())?.npub}async getNsec(){return(await this.getKeyPair())?.nsec}async getSecretKey(){const e=await this.getKeyPair();return e?.secretKey?new Uint8Array(e.secretKey):null}getCurrentUser(){return this.keyPair?{publicKey:this.keyPair.publicKey,secretKey:this.keyPair.secretKey,npub:this.keyPair.npub,nsec:this.keyPair.nsec,profile:this.profile}:null}async getDecryptedKeys(e=null){try{if(this.keyPair||await this.loadKeys(),!this.keyPair)throw new Error("Keine Schlüssel vorhanden");if(this.keyPair.created&&!this.keyPair.encrypted)return{privateKey:this.keyPair.nsec,publicKey:this.keyPair.publicKey,npub:this.keyPair.npub};if(this.keyPair.encrypted)throw e?new Error("Passwort-basierte Entschlüsselung noch nicht implementiert"):new Error("Passwort erforderlich für verschlüsselte Schlüssel");return{privateKey:this.keyPair.nsec,publicKey:this.keyPair.publicKey,npub:this.keyPair.npub}}catch(t){throw console.error("❌ Fehler beim Entschlüsseln der Schlüssel:",t),t}}}const Il="modulepreload",Ml=function(r){return"/dreammall-nostr-client/"+r},zr={},tt=function(e,t,n){if(!t||t.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(t.map(o=>{if(o=Ml(o),o in zr)return;zr[o]=!0;const i=o.endsWith(".css"),a=i?'[rel="stylesheet"]':"";if(!!n)for(let h=s.length-1;h>=0;h--){const u=s[h];if(u.href===o&&(!i||u.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${o}"]${a}`))return;const l=document.createElement("link");if(l.rel=i?"stylesheet":Il,i||(l.as="script",l.crossOrigin=""),l.href=o,document.head.appendChild(l),i)return new Promise((h,u)=>{l.addEventListener("load",h),l.addEventListener("error",()=>u(new Error(`Unable to preload CSS for ${o}`)))})})).then(()=>e()).catch(o=>{const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=o,window.dispatchEvent(i),!i.defaultPrevented)throw o})};var et=new TextDecoder("utf-8");new TextEncoder;var so=5e3;function Wr(r){let{prefix:e,words:t}=oe.decode(r,so),n=new Uint8Array(oe.fromWords(t));switch(e){case"nprofile":{let s=$t(n);if(!s[0]?.[0])throw new Error("missing TLV 0 for nprofile");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");return{type:"nprofile",data:{pubkey:G(s[0][0]),relays:s[1]?s[1].map(o=>et.decode(o)):[]}}}case"nevent":{let s=$t(n);if(!s[0]?.[0])throw new Error("missing TLV 0 for nevent");if(s[0][0].length!==32)throw new Error("TLV 0 should be 32 bytes");if(s[2]&&s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(s[3]&&s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"nevent",data:{id:G(s[0][0]),relays:s[1]?s[1].map(o=>et.decode(o)):[],author:s[2]?.[0]?G(s[2][0]):void 0,kind:s[3]?.[0]?parseInt(G(s[3][0]),16):void 0}}}case"naddr":{let s=$t(n);if(!s[0]?.[0])throw new Error("missing TLV 0 for naddr");if(!s[2]?.[0])throw new Error("missing TLV 2 for naddr");if(s[2][0].length!==32)throw new Error("TLV 2 should be 32 bytes");if(!s[3]?.[0])throw new Error("missing TLV 3 for naddr");if(s[3][0].length!==4)throw new Error("TLV 3 should be 4 bytes");return{type:"naddr",data:{identifier:et.decode(s[0][0]),pubkey:G(s[2][0]),kind:parseInt(G(s[3][0]),16),relays:s[1]?s[1].map(o=>et.decode(o)):[]}}}case"nsec":return{type:e,data:n};case"npub":case"note":return{type:e,data:G(n)};default:throw new Error(`unknown prefix ${e}`)}}function $t(r){let e={},t=r;for(;t.length>0;){let n=t[0],s=t[1],o=t.slice(2,2+s);if(t=t.slice(2+s),o.length<s)throw new Error(`not enough data to read on TLV ${n}`);e[n]=e[n]||[],e[n].push(o)}return e}function Jr(r){return Cl("npub",xe(r))}function Al(r,e){let t=oe.toWords(e);return oe.encode(r,t,so)}function Cl(r,e){return Al(r,e)}class Ll{constructor(){this.pool=null,this.relayService=null,this.keyPair=null,this.subscriptions=new Map,this.userProfile=null}setRelayService(e){this.relayService=e}setServices(e){this.services=e,this.relayService=e.relay}async init(e=null){console.log("🔧 Initialisiere NOSTR Service mit:",e),e&&(this.keyPair={pubkey:e.publicKey,privkey:e.nsec?new Uint8Array(e.secretKey||[]):new Uint8Array(e.privateKey||[]),npub:e.npub,nsec:e.nsec},e.secretKey&&Array.isArray(e.secretKey)&&(this.keyPair.privkey=new Uint8Array(e.secretKey)),console.log("🔑 KeyPair erstellt:",{pubkey:this.keyPair.pubkey,privkeyLength:this.keyPair.privkey?.length,npub:this.keyPair.npub})),this.pool=new ls,this.keyPair&&await this.loadUserProfile(),console.log("✅ NOSTR Service initialisiert",this.keyPair?"mit Schlüsseln":"ohne Schlüssel")}async loadUserProfile(){try{this.userProfile={pubkey:this.keyPair.pubkey,npub:this.keyPair.npub,name:"DreamMall User",displayName:"DreamMall User",picture:"",about:"DreamMall NOSTR User"},console.log("📝 Default-Profil erstellt:",this.userProfile)}catch(e){console.error("❌ Fehler beim Laden des Profils:",e),this.userProfile={pubkey:this.keyPair.pubkey,npub:this.keyPair.npub,name:"DreamMall User",displayName:"DreamMall User",picture:"",about:"DreamMall NOSTR User"}}}getUserProfile(){return this.userProfile}getPublicKey(){return this.keyPair?.pubkey}getKeyPair(){return this.keyPair}hexToNpub(e){try{return e?Jr(e):"Nicht verfügbar"}catch(t){return console.error("❌ hexToNpub conversion failed:",t),`npub_${e.slice(0,16)}...`}}npubToPubkey(e){try{if(!e||!e.startsWith("npub"))throw new Error("Invalid npub format");if(Wr){const t=Wr(e);if(t.type==="npub")return t.data}throw new Error("Failed to decode npub")}catch(t){throw console.error("❌ npubToPubkey conversion failed:",t),new Error("Ungültiger npub: "+t.message)}}async sendMessage(e,t,n=!1){if(!this.keyPair)throw new Error("NOSTR Service nicht initialisiert - keine Schlüssel");try{const s=this.relayService?.getConnectedRelays()||this.relayService?.defaultRelays||["wss://relay.damus.io"];if(console.log("📡 Sende Nachricht an Relays:",s),s.length===0)throw new Error("Keine Relay-Verbindungen verfügbar");const o={kind:1,created_at:Math.floor(Date.now()/1e3),tags:[["t",t],["client","dreammall-nostr"]],content:e,pubkey:this.keyPair.pubkey},i=J(o,this.keyPair.privkey);return console.log("📤 Publiziere NIP-28 Public Chat Event:",i),await this.pool.publish(s,i),{id:i.id,content:e,author:this.userProfile?.name||"DreamMall User",authorPubkey:this.keyPair.pubkey,timestamp:i.created_at*1e3,roomId:t,encrypted:!1,isOwn:!0}}catch(s){throw console.error("❌ Fehler beim Senden der Nachricht:",s),s}}async sendDirectMessage(e,t,n=!0){if(!this.keyPair)throw new Error("NOSTR Service nicht initialisiert - keine Schlüssel");try{const s=this.relayService?.getConnectedRelays()||this.relayService?.defaultRelays||["wss://relay.damus.io"];if(s.length===0)throw new Error("Keine Relay-Verbindungen verfügbar");let o=e;n&&(o=await ze.encrypt(this.keyPair.privkey,t,e));const i={kind:4,created_at:Math.floor(Date.now()/1e3),tags:[["p",t],["client","dreammall-nostr"]],content:o,pubkey:this.keyPair.pubkey},a=J(i,this.keyPair.privkey);return await this.pool.publish(s,a),{id:a.id,content:e,author:this.userProfile?.name||"DreamMall User",authorPubkey:this.keyPair.pubkey,timestamp:i.created_at*1e3,recipientPubkey:t,encrypted:n,isOwn:!0,isDirect:!0}}catch(s){throw console.error("❌ Fehler beim Senden der direkten Nachricht:",s),s}}subscribeToRoom(e,t=null){if(!this.pool){console.warn("NOSTR Service nicht bereit für Subscriptions");return}const n=this.relayService?.getConnectedRelays()||this.relayService?.defaultRelays||["wss://relay.damus.io"];if(n.length===0){console.warn("Keine Relay-Verbindungen für Subscription");return}if(console.log(`📡 Abonniere Raum: ${e} mit ${n.length} Relays:`,n),this.subscriptions.has("room")){const o=this.subscriptions.get("room");o&&typeof o.unsub=="function"&&(o.unsub(),console.log("📡 Vorherige Subscription beendet")),this.subscriptions.delete("room")}const s=this.pool.subscribeMany(n,[{kinds:[1],"#t":[e],since:Math.floor(Date.now()/1e3)-24*60*60,limit:100}],{onevent:o=>{console.log(`📨 NIP-28 Event erhalten für Raum ${e}:`,o),t?t(o):this.handleRoomMessage(o,e)},oneose:()=>{console.log(`📡 NIP-28 Subscription für Raum ${e} beendet`)},onclose:()=>{console.log(`📡 NIP-28 Subscription für Raum ${e} geschlossen`)}});return this.subscriptions.set("room",s),console.log(`✅ Erfolgreich Raum abonniert: ${e}`),s}subscribeToDirectMessages(){if(!this.pool||!this.keyPair){console.warn("NOSTR Service oder Schlüssel nicht bereit für DM Subscriptions");return}const e=this.relayService?.getConnectedRelays()||this.relayService?.defaultRelays||["wss://relay.damus.io"];if(e.length===0){console.warn("Keine Relay-Verbindungen für DM Subscription");return}if(console.log(`📡 Abonniere verschlüsselte DMs mit ${e.length} Relays:`,e),this.subscriptions.has("dm")){const n=this.subscriptions.get("dm");n&&typeof n.unsub=="function"&&(n.unsub(),console.log("📡 Vorherige DM Subscription beendet")),this.subscriptions.delete("dm")}const t=this.pool.subscribeMany(e,[{kinds:[4],"#p":[this.keyPair.pubkey],since:Math.floor(Date.now()/1e3)-24*60*60,limit:50}],{onevent:n=>{console.log("📨 Verschlüsselte DM erhalten:",n),this.handleDirectMessage(n)},oneose:()=>{console.log("📡 DM Subscription beendet")},onclose:()=>{console.log("📡 DM Subscription geschlossen")}});return this.subscriptions.set("dm",t),console.log("✅ Erfolgreich verschlüsselte DMs abonniert"),t}async handleRoomMessage(e,t){try{if(e.pubkey===this.keyPair.pubkey)return;if(e.kind!==1){console.log("Ignoriere Event - nicht NIP-28 Text Note (kind 1)");return}if(e.tags.filter(i=>i[0]==="t"&&i[1]===t).length===0){console.log("Ignoriere Event - kein matching room tag für:",t);return}const s=await this.getAuthorName(e.pubkey),o={id:e.id,content:e.content,author:s,authorPubkey:e.pubkey,timestamp:e.created_at*1e3,roomId:t,encrypted:!1,isOwn:!1};console.log("📨 NIP-28 Public Chat Message verarbeitet:",o),document.dispatchEvent(new CustomEvent("newMessage",{detail:o}))}catch(n){console.error("❌ Fehler beim Verarbeiten der NIP-28 Raum-Nachricht:",n)}}async handleDirectMessage(e){try{if(e.pubkey===this.keyPair.pubkey)return;let t=e.content,n=!1;try{const{decrypt:i}=await tt(()=>import("./nip04-eb7ad8ec.js"),[]);t=await i(this.keyPair.privkey,e.pubkey,e.content),n=!0,console.log("🔓 NIP-04 Nachricht entschlüsselt")}catch(i){console.log("Nachricht war nicht verschlüsselt oder Entschlüsselung fehlgeschlagen:",i)}const s=await this.getAuthorName(e.pubkey),o={id:e.id,content:t,author:s,authorPubkey:e.pubkey,timestamp:e.created_at*1e3,encrypted:n,isOwn:!1,isDirect:!0};document.dispatchEvent(new CustomEvent("newDirectMessage",{detail:o}))}catch(t){console.error("❌ Fehler beim Verarbeiten der direkten Nachricht:",t)}}async getAuthorName(e){try{return`User ${e.slice(0,8)}`}catch(t){return console.error("❌ Fehler beim Abrufen des Autornamens:",t),`User ${e.slice(0,8)}...`}}handleRelayEvent(e,t){console.log(`📨 Event von Relay ${e.url}:`,t)}destroy(){this.subscriptions.forEach(e=>{e&&typeof e.unsub=="function"&&e.unsub()}),this.subscriptions.clear(),this.pool&&this.pool.close(),console.log("🧹 NOSTR Service bereinigt")}async encodeNpub(e){try{return Jr(e)}catch(t){return console.error("❌ NostrService.encodeNpub failed:",t),null}}async encrypt(e,t){try{if(!this.keyPair||!this.keyPair.privkey)throw new Error("No private key available for encryption");console.log("🔐 Verschlüssele Nachricht für:",e);const n=await ze.encrypt(this.keyPair.privkey,e,t);return console.log("✅ Nachricht verschlüsselt"),n}catch(n){throw console.error("❌ Verschlüsselung fehlgeschlagen:",n),n}}async decrypt(e,t){try{if(!this.keyPair||!this.keyPair.privkey)throw new Error("No private key available for decryption");console.log("🔓 Entschlüssele Nachricht von:",e);const n=await ze.decrypt(this.keyPair.privkey,e,t);return console.log("✅ Nachricht entschlüsselt"),n}catch(n){throw console.error("❌ Entschlüsselung fehlgeschlagen:",n),n}}getEventHash(e){return $e(e)}async signEvent(e){try{if(!this.keyPair||!this.keyPair.privkey)throw new Error("No private key available for signing");return J(e,this.keyPair.privkey).sig}catch(t){throw console.error("❌ Event signing failed:",t),t}}async getDirectMessages(e){if(!this.keyPair)throw new Error("Kein Schlüsselpaar verfügbar");const t=[];try{const n={kinds:[4],authors:[e],"#p":[this.keyPair.pubkey],limit:100},s={kinds:[4],authors:[this.keyPair.pubkey],"#p":[e],limit:100};if(console.log("📥 Lade DM-History mit:",e),console.log("📥 Empfangene Filter:",n),console.log("📤 Gesendete Filter:",s),this.relayService.getConnectedRelays().length===0)return console.warn("⚠️ Keine verbundenen Relays für DM-History"),t;const[i,a]=await Promise.all([this.queryRelays(n),this.queryRelays(s)]);console.log("📥 Empfangene Events:",i.length),console.log("📤 Gesendete Events:",a.length);for(const c of i)try{let l=c.content,h=!1;try{const{decrypt:p}=await tt(()=>import("./nip04-eb7ad8ec.js"),[]);l=await p(this.keyPair.privkey,c.pubkey,c.content),h=!0}catch(p){console.log("Nachricht war nicht verschlüsselt:",p)}const u=await this.getAuthorName(c.pubkey);t.push({id:c.id,content:l,author:u,authorPubkey:c.pubkey,timestamp:c.created_at*1e3,encrypted:h,isOwn:!1,isDirect:!0})}catch(l){console.error("❌ Fehler beim Verarbeiten empfangener DM:",l)}for(const c of a)try{let l=c.content,h=!1;try{const{decrypt:p}=await tt(()=>import("./nip04-eb7ad8ec.js"),[]);l=await p(this.keyPair.privkey,e,c.content),h=!0}catch(p){console.log("Gesendete Nachricht war nicht verschlüsselt:",p)}const u=await this.getAuthorName(this.keyPair.pubkey);t.push({id:c.id,content:l,author:u,authorPubkey:this.keyPair.pubkey,timestamp:c.created_at*1e3,encrypted:h,isOwn:!0,isDirect:!0})}catch(l){console.error("❌ Fehler beim Verarbeiten gesendeter DM:",l)}return t.sort((c,l)=>c.timestamp-l.timestamp),console.log("✅ DM-History geladen:",t.length,"Nachrichten"),t}catch(n){throw console.error("❌ Fehler beim Laden der DM-History:",n),n}}async queryRelays(e){const t=this.relayService.getConnectedRelays();if(t.length===0)return console.warn("⚠️ Keine Relays für Query verfügbar"),[];const n=t.map(i=>new Promise(a=>{const c=[];let l=null;try{l=i.subscribe([e],{onevent:h=>{c.push(h)},oneose:()=>{a(c)},onclose:()=>{a(c)}})}catch(h){console.error("❌ Fehler beim Erstellen der Subscription:",h),a(c)}setTimeout(()=>{if(l)try{typeof l.unsub=="function"?l.unsub():typeof l.close=="function"?l.close():typeof l.unsubscribe=="function"&&l.unsubscribe()}catch(h){console.warn("⚠️ Fehler beim Beenden der Subscription:",h)}a(c)},5e3)})),s=await Promise.all(n),o=new Map;return s.forEach(i=>{i.forEach(a=>{o.set(a.id,a)})}),Array.from(o.values())}}const De={name:"DreamMall NOSTR Client",version:"1.0.1",testMode:!0,clearStorageOnStart:!0,defaultRelays:["wss://relay.damus.io"],rooms:{"dreamtest-public-v2":{name:"Offener Test Raum",description:"Öffentlicher Raum für alle - V2",type:"public",tag:"dreamtest-public-v2",icon:"🌍"},"dreamtest-private-v2":{name:"Geschlossener Test Raum",description:"Privater Raum mit Einladung - V2",type:"private",tag:"dreamtest-private-v2",icon:"🔐"}},settings:{defaultRoom:"dreamtest-public-v2",messageHistoryLimit:100,maxPrivateGroups:50,autoConnect:!0,darkMode:!0},testAccount:{publicKey:"e3f3e3f6a562c3f4382f5c23eaf557c915bb15abdfb784c2f5ee03a96debb76e",npub:"npub1u0e78a49vtplgwp0ts374a2hey2mk9dtm7mcfsh4acp6jm0tkahqsw397q"}},{rooms:_l,settings:$l}=De;class Dl{constructor(){this.relays=new Map,this.eventHandlers=new Map,this.nostrService=null,this.connectionState="disconnected",this.defaultRelays=De.defaultRelays}on(e,t){this.eventHandlers.has(e)||this.eventHandlers.set(e,[]),this.eventHandlers.get(e).push(t)}emit(e,t){(this.eventHandlers.get(e)||[]).forEach(s=>{try{s(t)}catch(o){console.error(`Error in event handler for ${e}:`,o)}})}off(e,t){const n=this.eventHandlers.get(e)||[],s=n.indexOf(t);s>-1&&n.splice(s,1)}async init(){return console.log("🌐 Initialisiere Relay Service..."),this.connectionState="initialized",!0}setNostrService(e){this.nostrService=e}setServices(e){this.services=e}async connect(){if(console.log("🌐 Verbinde zu NOSTR Relays..."),this.connectionState="connecting",this.emit("connecting"),De.testMode){console.log("🧪 Test-Modus aktiv - verwende nur Haupt-Relay");const o=De.defaultRelays[0];try{if(await this.connectToRelay(o))console.log("✅ Test-Relay verbunden:",o),this.connectionState="connected",this.emit("connected",{relayCount:1});else throw new Error("Test-Relay-Verbindung fehlgeschlagen")}catch(i){console.error("❌ Test-Relay-Verbindung fehlgeschlagen:",i),this.connectionState="failed",this.emit("disconnected")}return}const e=this.getSavedRelays(),t=e.length>0?e:this.defaultRelays;let n=0;const s=t.map(o=>this.connectToRelay(o));try{(await Promise.allSettled(s)).forEach((i,a)=>{i.status==="fulfilled"&&i.value&&n++}),n>0?(this.connectionState="connected",this.emit("connected",{relayCount:n}),console.log(`✅ Verbunden mit ${n}/${t.length} Relays`)):(this.connectionState="offline",this.emit("disconnected"),console.warn("⚠️ Keine Relay-Verbindungen verfügbar - App läuft im Offline-Modus"))}catch(o){console.error("❌ Fehler beim Verbinden zu Relays:",o),this.connectionState="failed",this.emit("disconnected")}}getConnectedRelays(){const e=[];for(const[t,n]of this.relays)n.connected&&e.push(t);return e}getRelays(){const e=[];for(const[t,n]of this.relays)e.push({url:t,connected:n.connected,lastPing:n.lastPing,latency:n.latency||0});return e}getSavedRelays(){try{const e=localStorage.getItem("nostr_relays");return e?JSON.parse(e):[]}catch(e){return console.error("Error loading saved relays:",e),[]}}async connectToRelay(e){return new Promise(t=>{try{console.log(`🔌 Verbinde zu Relay: ${e}`);const n=new WebSocket(e),s={url:e,ws:n,connected:!1,lastPing:Date.now(),messageQueue:[]};n.onopen=()=>{s.connected=!0,this.relays.set(e,s),console.log(`✅ Verbunden mit Relay: ${e}`),this.startHeartbeat(s),t(!0)},n.onclose=o=>{s.connected=!1,console.log(`🔌 Relay getrennt: ${e} (Code: ${o.code})`),setTimeout(()=>{this.connectionState==="connected"&&this.connectToRelay(e)},5e3)},n.onerror=o=>{console.warn(`⚠️ Relay-Fehler (${e}):`,o),s.connected=!1,t(!1)},n.onmessage=o=>{try{const i=JSON.parse(o.data);this.handleRelayMessage(s,i)}catch(i){console.error("❌ Fehler beim Parsen der Relay-Nachricht:",i)}},setTimeout(()=>{s.connected||(console.warn(`⚠️ Verbindung zu ${e} timeout`),n.close(),t(!1))},1e4)}catch(n){console.error(`❌ Fehler beim Verbinden zu ${e}:`,n),t(!1)}})}startHeartbeat(e){const t=setInterval(()=>{if(!e.connected){clearInterval(t);return}try{e.ws.send(JSON.stringify(["PING"])),e.lastPing=Date.now()}catch(n){console.error("❌ Heartbeat-Fehler:",n),clearInterval(t)}},3e4)}handleRelayMessage(e,t){if(Array.isArray(t)){const[n,...s]=t;switch(n){case"EVENT":this.handleEvent(e,s[1]);break;case"NOTICE":console.log(`📢 Relay-Nachricht von ${e.url}: ${s[0]}`);break;case"EOSE":console.log(`✅ End of stored events für ${e.url}`);break;case"OK":console.log(`✅ Event published to ${e.url}`);break;default:console.log(`📩 Unbekannter Nachrichtentyp von ${e.url}:`,n)}}}handleEvent(e,t){this.nostrService&&this.nostrService.handleRelayEvent(e,t)}publish(e){const t=this.getConnectedRelays(),n=[];return t.forEach(s=>{const o=this.relays.get(s);if(o&&o.connected){const i=["EVENT",e];try{o.ws.send(JSON.stringify(i)),n.push(Promise.resolve(`Published to ${s}`))}catch(a){console.error(`❌ Fehler beim Publizieren zu ${s}:`,a),n.push(Promise.reject(a))}}}),Promise.allSettled(n)}subscribe(e,t){const n=this.generateSubscriptionId();return this.getConnectedRelays().forEach(o=>{const i=this.relays.get(o);if(i&&i.connected){const a=["REQ",n,...e];try{i.ws.send(JSON.stringify(a))}catch(c){console.error(`❌ Fehler beim Abonnieren zu ${o}:`,c)}}}),n}unsubscribe(e){this.getConnectedRelays().forEach(n=>{const s=this.relays.get(n);if(s&&s.connected){const o=["CLOSE",e];try{s.ws.send(JSON.stringify(o))}catch(i){console.error(`❌ Fehler beim Abbestellen zu ${n}:`,i)}}})}generateSubscriptionId(){return"sub_"+Math.random().toString(36).substr(2,9)}getStatus(){return{state:this.connectionState,connectedRelays:this.getConnectedRelays().length,totalRelays:this.relays.size}}async addRelay(e){try{if(this.relays.has(e))throw new Error("Relay bereits vorhanden");const t=await this.connectToRelay(e);return toastService.success(`Relay ${e} erfolgreich hinzugefügt`),t}catch(t){throw console.error(`❌ Relay hinzufügen fehlgeschlagen: ${e}`,t),t}}async removeRelay(e){try{if(!this.relays.has(e))throw new Error("Relay nicht gefunden");const t=this.relays.get(e);t&&t.connected&&await t.close(),this.relays.delete(e);const n=this.getRelayUrls().filter(s=>s!==e);return this.storage.setItem("relays",JSON.stringify(n)),console.log(`✅ Relay entfernt: ${e}`),!0}catch(t){throw console.error(`❌ Relay entfernen fehlgeschlagen: ${e}`,t),t}}async testRelay(e){try{console.log(`🔗 Teste Relay: ${e}`);const t=new WebSocket(e);return new Promise(n=>{const s=setTimeout(()=>{t.close(),n(!1)},5e3);t.onopen=()=>{clearTimeout(s),console.log(`✅ Relay Test erfolgreich: ${e}`),t.close(),n(!0)},t.onerror=o=>{clearTimeout(s),console.error(`❌ Relay Test fehlgeschlagen: ${e}`,o),n(!1)}})}catch(t){return console.error(`❌ Relay Test fehlgeschlagen: ${e}`,t),!1}}getRelayStats(){const e={};for(const[t,n]of this.relays)e[t]={connected:n.connected,url:n.url,status:n.connected?"connected":"disconnected"};return e}getRelayUrls(){try{const e=this.storage.getItem("relays");return e?JSON.parse(e):this.defaultRelays}catch(e){return console.error("❌ Fehler beim Laden der Relays:",e),this.defaultRelays}}async disconnect(){try{for(const[e,t]of this.relays)t.connected&&await t.close();this.relays.clear(),console.log("🔌 Alle Relays getrennt")}catch(e){console.error("❌ Fehler beim Trennen der Relays:",e)}}}class Bl{constructor(){this.dbName="DreamMallNostrDB",this.dbVersion=1,this.db=null}async init(){return new Promise((e,t)=>{const n=indexedDB.open(this.dbName,this.dbVersion);n.onerror=()=>{console.error("❌ Fehler beim Öffnen der IndexedDB"),t(n.error)},n.onsuccess=()=>{this.db=n.result,console.log("✅ IndexedDB initialisiert"),e()},n.onupgradeneeded=s=>{const o=s.target.result;if(!o.objectStoreNames.contains("messages")){const i=o.createObjectStore("messages",{keyPath:"id"});i.createIndex("roomId","roomId",{unique:!1}),i.createIndex("timestamp","timestamp",{unique:!1}),i.createIndex("authorPubkey","authorPubkey",{unique:!1})}if(!o.objectStoreNames.contains("rooms")){const i=o.createObjectStore("rooms",{keyPath:"id"});i.createIndex("name","name",{unique:!1}),i.createIndex("type","type",{unique:!1})}if(!o.objectStoreNames.contains("contacts")){const i=o.createObjectStore("contacts",{keyPath:"pubkey"});i.createIndex("name","name",{unique:!1}),i.createIndex("lastContact","lastContact",{unique:!1})}o.objectStoreNames.contains("settings")||o.createObjectStore("settings",{keyPath:"key"}),o.objectStoreNames.contains("keys")||o.createObjectStore("keys",{keyPath:"id"}),console.log("✅ IndexedDB Schema erstellt")}})}async saveMessage(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["messages"],"readwrite").objectStore("messages").put(e);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async getMessages(e,t=100){return this.db||await this.init(),new Promise((n,s)=>{const c=this.db.transaction(["messages"],"readonly").objectStore("messages").index("roomId").getAll(e);c.onsuccess=()=>{const l=c.result.sort((h,u)=>u.timestamp-h.timestamp).slice(0,t);n(l)},c.onerror=()=>s(c.error)})}async deleteMessage(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["messages"],"readwrite").objectStore("messages").delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(i.error)})}async saveRoom(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["rooms"],"readwrite").objectStore("rooms").put(e);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async getRooms(){return this.db||await this.init(),new Promise((e,t)=>{const o=this.db.transaction(["rooms"],"readonly").objectStore("rooms").getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})}async deleteRoom(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["rooms"],"readwrite").objectStore("rooms").delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(i.error)})}async saveContact(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["contacts"],"readwrite").objectStore("contacts").put(e);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async getContacts(){return this.db||await this.init(),new Promise((e,t)=>{const o=this.db.transaction(["contacts"],"readonly").objectStore("contacts").getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})}async deleteContact(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["contacts"],"readwrite").objectStore("contacts").delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(i.error)})}async saveSetting(e,t){return this.db||await this.init(),new Promise((n,s)=>{const a=this.db.transaction(["settings"],"readwrite").objectStore("settings").put({key:e,value:t});a.onsuccess=()=>n(a.result),a.onerror=()=>s(a.error)})}async getSetting(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);i.onsuccess=()=>{const a=i.result;t(a?a.value:null)},i.onerror=()=>n(i.error)})}async deleteSetting(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["settings"],"readwrite").objectStore("settings").delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(i.error)})}async saveKey(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["keys"],"readwrite").objectStore("keys").put(e);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async getKey(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["keys"],"readonly").objectStore("keys").get(e);i.onsuccess=()=>t(i.result),i.onerror=()=>n(i.error)})}async getAllKeys(){return this.db||await this.init(),new Promise((e,t)=>{const o=this.db.transaction(["keys"],"readonly").objectStore("keys").getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>t(o.error)})}async deleteKey(e){return this.db||await this.init(),new Promise((t,n)=>{const i=this.db.transaction(["keys"],"readwrite").objectStore("keys").delete(e);i.onsuccess=()=>t(),i.onerror=()=>n(i.error)})}async saveDMContact(e,t){try{const s=this.db.transaction(["contacts"],"readwrite").objectStore("contacts"),o={pubkey:e,displayName:t.displayName,lastMessage:t.lastMessage||"",lastMessageTime:t.lastMessageTime||Date.now(),unreadCount:t.unreadCount||0,type:"dm",createdAt:Date.now()};return await s.put(o),console.log("💾 DM-Kontakt gespeichert:",o),o}catch(n){throw console.error("❌ Fehler beim Speichern des DM-Kontakts:",n),n}}async getDMContacts(){try{const n=this.db.transaction(["contacts"],"readonly").objectStore("contacts").getAll();return new Promise((s,o)=>{n.onsuccess=()=>{const i=n.result.filter(a=>a.type==="dm");console.log("📖 DM-Kontakte geladen:",i.length),s(i)},n.onerror=()=>o(n.error)})}catch(e){return console.error("❌ Fehler beim Laden der DM-Kontakte:",e),[]}}async removeDMContact(e){try{await this.db.transaction(["contacts"],"readwrite").objectStore("contacts").delete(e),console.log("🗑️ DM-Kontakt entfernt:",e)}catch(t){throw console.error("❌ Fehler beim Entfernen des DM-Kontakts:",t),t}}async saveDMMessage(e){try{const n=this.db.transaction(["messages"],"readwrite").objectStore("messages"),s={id:e.id,content:e.content,author:e.author,authorPubkey:e.authorPubkey,timestamp:e.timestamp,roomId:`dm_${e.senderPubkey||e.recipientPubkey}`,encrypted:e.encrypted,isDirect:!0,isOwn:e.isOwn,recipientPubkey:e.recipientPubkey,senderPubkey:e.senderPubkey};return await n.put(s),console.log("💾 DM-Nachricht gespeichert:",s),s}catch(t){throw console.error("❌ Fehler beim Speichern der DM-Nachricht:",t),t}}async getDMMessages(e){try{const n=this.db.transaction(["messages"],"readonly").objectStore("messages"),s=`dm_${e}`,i=n.index("roomId").getAll(s);return new Promise((a,c)=>{i.onsuccess=()=>{const l=i.result.sort((h,u)=>h.timestamp-u.timestamp);console.log("📖 DM-Nachrichten geladen:",l.length,"für",e),a(l)},i.onerror=()=>c(i.error)})}catch(t){return console.error("❌ Fehler beim Laden der DM-Nachrichten:",t),[]}}async clearAll(){this.db||await this.init();const e=["messages","rooms","contacts","settings","keys"];return Promise.all(e.map(t=>new Promise((n,s)=>{const a=this.db.transaction([t],"readwrite").objectStore(t).clear();a.onsuccess=()=>n(),a.onerror=()=>s(a.error)})))}async getStorageStats(){this.db||await this.init();const e=["messages","rooms","contacts","settings","keys"],t={};for(const n of e)t[n]=await new Promise((s,o)=>{const c=this.db.transaction([n],"readonly").objectStore(n).count();c.onsuccess=()=>s(c.result),c.onerror=()=>o(c.error)});return t}setLocalStorage(e,t){try{localStorage.setItem(`dm-nostr-${e}`,JSON.stringify(t))}catch(n){console.error("❌ LocalStorage Fehler:",n)}}getLocalStorage(e){try{const t=localStorage.getItem(`dm-nostr-${e}`);return t?JSON.parse(t):null}catch(t){return console.error("❌ LocalStorage Fehler:",t),null}}removeLocalStorage(e){try{localStorage.removeItem(`dm-nostr-${e}`)}catch(t){console.error("❌ LocalStorage Fehler:",t)}}async destroy(){this.db&&(this.db.close(),this.db=null)}}class Kl{constructor(){this.container=null,this.toasts=new Map,this.defaultDuration=5e3,this.maxToasts=5,this.init()}init(){this.createContainer(),console.log("✅ Toast Service initialisiert")}createContainer(){const e=document.getElementById("toast-container");e&&e.remove(),this.container=document.createElement("div"),this.container.id="toast-container",this.container.className="toast-container",document.getElementById("toast-styles")||this.addStyles(),document.body.appendChild(this.container)}addStyles(){const e=document.createElement("style");e.id="toast-styles",e.textContent=`
            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                pointer-events: none;
                max-width: 400px;
            }

            .toast {
                background: var(--background-color, white);
                border: 1px solid var(--border-color, #e1e5e9);
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                margin-bottom: 10px;
                overflow: hidden;
                transform: translateX(100%);
                transition: all 0.3s ease;
                pointer-events: auto;
                max-width: 100%;
                word-wrap: break-word;
            }

            .toast.show {
                transform: translateX(0);
            }

            .toast-content {
                display: flex;
                align-items: flex-start;
                padding: 16px;
                gap: 12px;
            }

            .toast-icon {
                flex-shrink: 0;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 16px;
            }

            .toast-message {
                flex: 1;
                font-size: 14px;
                line-height: 1.4;
                color: var(--text-color, #333);
            }

            .toast-close {
                flex-shrink: 0;
                background: none;
                border: none;
                cursor: pointer;
                padding: 4px;
                border-radius: 4px;
                color: var(--text-color-secondary, #666);
                transition: background-color 0.2s;
            }

            .toast-close:hover {
                background-color: var(--hover-color, rgba(0, 0, 0, 0.1));
            }

            /* Toast Types */
            .toast-success {
                border-left: 4px solid #10b981;
            }
            .toast-success .toast-icon {
                color: #10b981;
            }

            .toast-error {
                border-left: 4px solid #ef4444;
            }
            .toast-error .toast-icon {
                color: #ef4444;
            }

            .toast-warning {
                border-left: 4px solid #f59e0b;
            }
            .toast-warning .toast-icon {
                color: #f59e0b;
            }

            .toast-info {
                border-left: 4px solid #3b82f6;
            }
            .toast-info .toast-icon {
                color: #3b82f6;
            }

            /* Progress bar */
            .toast-progress {
                position: absolute;
                bottom: 0;
                left: 0;
                height: 3px;
                background-color: currentColor;
                opacity: 0.3;
                transition: width linear;
            }

            .toast-success .toast-progress { background-color: #10b981; }
            .toast-error .toast-progress { background-color: #ef4444; }
            .toast-warning .toast-progress { background-color: #f59e0b; }
            .toast-info .toast-progress { background-color: #3b82f6; }

            /* Dark theme support */
            [data-theme="dark"] .toast {
                background: var(--background-dark, #1f2937);
                border-color: var(--border-dark, #374151);
                color: var(--text-dark, #f9fafb);
            }

            [data-theme="dark"] .toast-message {
                color: var(--text-dark, #f9fafb);
            }

            [data-theme="dark"] .toast-close {
                color: var(--text-secondary-dark, #9ca3af);
            }

            [data-theme="dark"] .toast-close:hover {
                background-color: var(--hover-dark, rgba(255, 255, 255, 0.1));
            }

            /* Mobile responsiveness */
            @media (max-width: 480px) {
                .toast-container {
                    top: 10px;
                    right: 10px;
                    left: 10px;
                    max-width: none;
                }

                .toast {
                    margin-bottom: 8px;
                }

                .toast-content {
                    padding: 12px;
                }
            }
        `,document.head.appendChild(e)}success(e,t={}){return this.show(e,"success",t)}error(e,t={}){return this.show(e,"error",{...t,duration:t.duration||8e3})}warning(e,t={}){return this.show(e,"warning",t)}info(e,t={}){return this.show(e,"info",t)}show(e,t="info",n={}){const s={duration:n.duration??this.defaultDuration,closable:n.closable??!0,progress:n.progress??!0,id:n.id||this.generateId(),...n};if(this.toasts.has(s.id)&&this.remove(s.id),this.toasts.size>=this.maxToasts){const i=this.toasts.keys().next().value;this.remove(i)}const o=this.createToast(e,t,s);if(this.toasts.set(s.id,o),this.container.appendChild(o.element),requestAnimationFrame(()=>{o.element.classList.add("show")}),s.duration>0&&(o.timer=setTimeout(()=>{this.remove(s.id)},s.duration),s.progress)){const i=o.element.querySelector(".toast-progress");i&&(i.style.width="0%",i.style.transitionDuration=`${s.duration}ms`,requestAnimationFrame(()=>{i.style.width="100%"}))}return s.id}remove(e){const t=this.toasts.get(e);return t?(clearTimeout(t.timer),t.element.classList.remove("show"),setTimeout(()=>{t.element.parentNode&&t.element.parentNode.removeChild(t.element),this.toasts.delete(e)},300),!0):!1}removeAll(){for(const e of this.toasts.keys())this.remove(e)}update(e,t,n=null){const s=this.toasts.get(e);if(!s)return!1;const o=s.element.querySelector(".toast-message");return o&&(o.textContent=t),n&&n!==s.type&&(s.element.className=`toast toast-${n}`,s.type=n),!0}createToast(e,t,n){const s=document.createElement("div");s.className=`toast toast-${t}`,s.dataset.toastId=n.id;const o=this.getIcon(t);return s.innerHTML=`
            <div class="toast-content">
                <div class="toast-icon">
                    <i class="${o}"></i>
                </div>
                <div class="toast-message">${this.escapeHtml(e)}</div>
                ${n.closable?`
                    <button class="toast-close" type="button" aria-label="Schließen">
                        <i class="fas fa-times"></i>
                    </button>
                `:""}
            </div>
            ${n.progress&&n.duration>0?'<div class="toast-progress"></div>':""}
        `,n.closable&&s.querySelector(".toast-close").addEventListener("click",()=>{this.remove(n.id)}),n.clickToDismiss!==!1&&s.addEventListener("click",i=>{i.target.closest(".toast-close")||this.remove(n.id)}),{element:s,type:t,timer:null}}getIcon(e){const t={success:"fas fa-check-circle",error:"fas fa-exclamation-circle",warning:"fas fa-exclamation-triangle",info:"fas fa-info-circle"};return t[e]||t.info}generateId(){return`toast_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}setDefaultDuration(e){this.defaultDuration=e}setMaxToasts(e){for(this.maxToasts=e;this.toasts.size>e;){const t=this.toasts.keys().next().value;this.remove(t)}}promise(e,t={}){const n={loading:"Lädt...",success:"Erfolgreich!",error:"Fehler aufgetreten",...t},s=this.info(n.loading,{duration:0,progress:!1});return e.then(o=>(this.remove(s),this.success(n.success),o)).catch(o=>{throw this.remove(s),this.error(n.error),o})}async(e,t={}){return this.promise(e(),t)}notifyConnection(e,t=""){const n={connected:`✅ Verbunden${t?` mit ${t}`:""}`,disconnected:`❌ Verbindung getrennt${t?` von ${t}`:""}`,reconnecting:`🔄 Verbinde neu${t?` mit ${t}`:""}...`,error:`⚠️ Verbindungsfehler${t?` bei ${t}`:""}`},s={connected:"success",disconnected:"warning",reconnecting:"info",error:"error"};this.show(n[e]||n.error,s[e]||"info")}notifyMessage(e,t=""){const n={sent:"📤 Nachricht gesendet",received:`📥 Neue Nachricht${t?` von ${t}`:""}`,encrypted:"🔒 Verschlüsselte Nachricht erhalten",failed:"❌ Nachricht konnte nicht gesendet werden"},s={sent:"success",received:"info",encrypted:"info",failed:"error"};this.show(n[e]||n.failed,s[e]||"info")}notifyKey(e){const t={generated:"🔑 Neuer Schlüssel generiert",imported:"📥 Schlüssel importiert",exported:"📤 Schlüssel exportiert",saved:"💾 Schlüssel gespeichert",error:"❌ Schlüssel-Fehler"},n={generated:"success",imported:"success",exported:"success",saved:"success",error:"error"};this.show(t[e]||t.error,n[e]||"info")}destroy(){this.removeAll(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.toasts.clear(),this.container=null}showSuccess(e,t={}){return this.success(e,t)}showError(e,t={}){return this.error(e,t)}showWarning(e,t={}){return this.warning(e,t)}showInfo(e,t={}){return this.info(e,t)}}function Ol(r,e){console.log("👤 Öffne Benutzer-Profil...");try{const t=r.getCurrentUser();if(!t){e.showError("Kein Benutzer gefunden");return}const n=document.createElement("div");n.className="modal-overlay",n.innerHTML=`
            <div class="modal">
                <div class="modal-header">
                    <h3>👤 Benutzer-Profil</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                </div>
                <div class="modal-body">
                    <div class="profile-info">
                        <p><strong>Öffentlicher Schlüssel:</strong></p>
                        <p class="key-display">${t.publicKey}</p>
                        <p><strong>NPUB:</strong></p>
                        <p class="key-display">${t.npub||"Nicht verfügbar"}</p>
                        <p><strong>Erstellt:</strong></p>
                        <p>${new Date().toLocaleDateString()}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Schließen</button>
                </div>
            </div>
        `,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),n.querySelectorAll(".key-display").forEach(s=>{s.style.cursor="pointer",s.title="Klicken zum Kopieren",s.addEventListener("click",()=>{navigator.clipboard.writeText(s.textContent),e.showSuccess("In Zwischenablage kopiert")})})}catch(t){console.error("❌ Fehler beim Laden des Profils:",t),e.showError("Fehler beim Laden des Profils")}}function Ul(r,e){console.log("🔑 Öffne Schlüssel-Einstellungen...");try{const t=r.getCurrentUser();if(!t){e.showError("Kein Benutzer gefunden");return}const n=document.createElement("div");n.className="modal-overlay",n.innerHTML=`
            <div class="modal">
                <div class="modal-header">
                    <h3>🔑 Schlüssel-Einstellungen</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Öffentlicher Schlüssel (Hex):</label>
                        <input type="text" id="publicKeyHex" value="${t.publicKey}" readonly>
                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('publicKeyHex')">Kopieren</button>
                    </div>
                    <div class="form-group">
                        <label>NPUB:</label>
                        <input type="text" id="npubKey" value="${t.npub||"Nicht verfügbar"}" readonly>
                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('npubKey')">Kopieren</button>
                    </div>
                    <div class="form-group">
                        <label>Privater Schlüssel (Hex):</label>
                        <input type="password" id="privateKeyHex" value="${t.privateKey||"Nicht verfügbar"}" readonly>
                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('privateKeyHex')">Kopieren</button>
                    </div>
                    <div class="form-group">
                        <label>NSEC:</label>
                        <input type="password" id="nsecKey" value="${t.nsec||"Nicht verfügbar"}" readonly>
                        <button class="btn btn-sm btn-secondary" onclick="copyToClipboard('nsecKey')">Kopieren</button>
                    </div>
                    <div class="warning-box">
                        <p>⚠️ <strong>Warnung:</strong> Teilen Sie niemals Ihren privaten Schlüssel mit anderen!</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-danger" onclick="generateNewKeys()">🔄 Neue Schlüssel generieren</button>
                    <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Schließen</button>
                </div>
            </div>
        `,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),window.copyToClipboard=s=>{const o=document.getElementById(s);o&&(navigator.clipboard.writeText(o.value),e.showSuccess("In Zwischenablage kopiert"))},window.generateNewKeys=()=>{confirm("Sind Sie sicher, dass Sie neue Schlüssel generieren möchten? Dies wird alle bestehenden Verbindungen trennen.")&&(r.generateNewKeys(),n.remove(),e.showSuccess("Neue Schlüssel generiert"),setTimeout(()=>location.reload(),1e3))}}catch(t){console.error("❌ Fehler beim Laden der Schlüssel-Einstellungen:",t),e.showError("Fehler beim Laden der Schlüssel-Einstellungen")}}function Gl(r,e){console.log("📡 Öffne Relay-Einstellungen...");try{let n=function(){const s=document.getElementById("relayItems"),o=document.getElementById("statsContent");if(!s||!o)return;const i=r.getRelays(),a=r.getRelayStats(),c={total:i.length,connected:i.filter(l=>l.connected).length,disconnected:i.filter(l=>!l.connected).length};s.innerHTML=i.map(l=>`
                <div class="relay-item">
                    <div class="relay-url">${l.url}</div>
                    <div class="relay-status ${l.connected?"connected":"disconnected"}">
                        ${l.connected?"🟢 Verbunden":"🔴 Getrennt"}
                    </div>
                    <div class="relay-actions">
                        <button class="btn btn-sm btn-danger" onclick="removeRelay('${l.url}')">
                            Entfernen
                        </button>
                    </div>
                </div>
            `).join(""),o.innerHTML=`
                <div class="stat-item">
                    <span>Gesamte Relays:</span>
                    <span>${c.total}</span>
                </div>
                <div class="stat-item">
                    <span>Verbundene Relays:</span>
                    <span>${c.connected}</span>
                </div>
                <div class="stat-item">
                    <span>Getrennte Relays:</span>
                    <span>${c.disconnected}</span>
                </div>
            `};const t=document.createElement("div");t.className="modal-overlay",t.innerHTML=`
            <div class="modal">
                <div class="modal-header">
                    <h3>📡 Relay-Einstellungen</h3>
                    <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Neues Relay hinzufügen:</label>
                        <div class="input-group">
                            <input type="text" id="newRelayUrl" placeholder="wss://relay.example.com" />
                            <button class="btn btn-primary" onclick="addNewRelay()">Hinzufügen</button>
                        </div>
                    </div>
                    
                    <div class="relay-list" id="relayList">
                        <h4>Aktuelle Relays:</h4>
                        <div id="relayItems">
                            <!-- Wird dynamisch gefüllt -->
                        </div>
                    </div>
                    
                    <div class="relay-stats" id="relayStats">
                        <h4>Statistiken:</h4>
                        <div id="statsContent">
                            <!-- Wird dynamisch gefüllt -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="resetToDefaults()">🔄 Standard wiederherstellen</button>
                    <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">Schließen</button>
                </div>
            </div>
        `,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),10),n(),window.addNewRelay=()=>{const s=document.getElementById("newRelayUrl"),o=s.value.trim();if(!o){e.showError("Bitte geben Sie eine Relay-URL ein");return}if(!o.startsWith("wss://")&&!o.startsWith("ws://")){e.showError("Relay-URL muss mit ws:// oder wss:// beginnen");return}try{r.addRelay(o),s.value="",n(),e.showSuccess("Relay hinzugefügt")}catch(i){console.error("Fehler beim Hinzufügen des Relays:",i),e.showError("Fehler beim Hinzufügen des Relays")}},window.removeRelay=s=>{if(confirm(`Relay "${s}" wirklich entfernen?`))try{r.removeRelay(s),n(),e.showSuccess("Relay entfernt")}catch(o){console.error("Fehler beim Entfernen des Relays:",o),e.showError("Fehler beim Entfernen des Relays")}},window.resetToDefaults=()=>{if(confirm("Alle Relays auf Standardwerte zurücksetzen?"))try{r.resetToDefaults(),n(),e.showSuccess("Relays auf Standard zurückgesetzt")}catch(s){console.error("Fehler beim Zurücksetzen der Relays:",s),e.showError("Fehler beim Zurücksetzen der Relays")}}}catch(t){console.error("❌ Fehler beim Laden der Relay-Einstellungen:",t),e.showError("Fehler beim Laden der Relay-Einstellungen")}}class Hl{constructor(e="DreamMall NOSTR Client"){this.title=e,this.element=null,this.isConnected=!1,this.services=null}render(){return this.element=document.createElement("div"),this.element.className="header",this.element.innerHTML=`
            <h1>🌟 ${this.title}</h1>
            <div class="status">
                <span class="status-dot offline" id="statusDot"></span>
                <span id="statusText">Nicht verbunden</span>
            </div>
            <div class="chat-controls" id="controls" style="display: none;">
                                    <button class="btn btn-sm" id="userBtn" title="Dein Profil">👤</button>

                <button class="btn btn-sm" id="settingsBtn">⚙️</button>
                <button class="btn btn-sm" id="relaysBtn">🔗</button>
            </div>
        `,this.setupEventListeners(),this.element}setupEventListeners(){const e=this.element.querySelector("#userBtn"),t=this.element.querySelector("#settingsBtn"),n=this.element.querySelector("#relaysBtn");e.addEventListener("click",()=>{this.services?Ol(this.services.keyService,this.services.toastService):console.error("Services not set for HeaderComponent")}),t?.addEventListener("click",()=>{this.services?Ul(this.services.keyService,this.services.toastService):console.error("Services not set for HeaderComponent")}),n?.addEventListener("click",()=>{this.services?Gl(this.services.relayService,this.services.toastService):console.error("Services not set for HeaderComponent")})}updateStatus(e){this.isConnected=e;const t=this.element.querySelector("#statusDot"),n=this.element.querySelector("#statusText");e?(t.classList.replace("offline","online"),n.textContent="Verbunden"):(t.classList.replace("online","offline"),n.textContent="Nicht verbunden")}showControls(){const e=this.element.querySelector("#controls");e.style.display="flex"}hideControls(){const e=this.element.querySelector("#controls");e.style.display="none"}setServices(e){this.services=e,console.log("📦 Services an HeaderComponent übergeben")}destroy(){this.element&&(this.element.remove(),this.element=null)}}class Fl{constructor(e,t){this.keyService=e,this.toastService=t,this.element=null}render(){return this.element=document.createElement("div"),this.element.className="setup",this.element.innerHTML=`
            <h2>🔐 Willkommen zu NOSTR</h2>
            <p>Erstelle deine NOSTR-Identität oder importiere bestehende Schlüssel</p>
            <div class="setup-buttons">
                <button class="btn btn-primary" id="generateBtn">
                    🔑 Neue Schlüssel generieren
                </button>
                <button class="btn btn-secondary" id="importBtn">
                    📥 Schlüssel importieren
                </button>
            </div>
        `,this.setupEventListeners(),this.element}setupEventListeners(){const e=this.element.querySelector("#generateBtn"),t=this.element.querySelector("#importBtn");e.addEventListener("click",()=>this.handleGenerate()),t.addEventListener("click",()=>this.handleImport())}async handleGenerate(){try{this.toastService.showInfo("Generiere Schlüssel...");const e=await this.keyService.generateKeyPair();this.toastService.showSuccess("Schlüssel erfolgreich generiert!"),this.dispatchEvent("keysGenerated",{keys:e})}catch(e){console.error("❌ Schlüsselgenerierung fehlgeschlagen:",e),this.toastService.showError("Fehler beim Generieren der Schlüssel")}}async handleImport(){try{const e=prompt("Privater Schlüssel (nsec... oder hex):");if(!e)return;this.toastService.showInfo("Importiere Schlüssel..."),await this.keyService.importKeys(e),this.toastService.showSuccess("Schlüssel erfolgreich importiert!"),this.dispatchEvent("keysImported")}catch(e){console.error("❌ Schlüsselimport fehlgeschlagen:",e),this.toastService.showError("Fehler beim Importieren der Schlüssel")}}dispatchEvent(e,t={}){const n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)}destroy(){this.element&&(this.element.remove(),this.element=null)}}class oo{constructor(e){this.nostrService=e,this.KIND_TEXT_NOTE=1,this.KIND_METADATA=0,this.KIND_CONTACTS=3,this.KIND_ENCRYPTED_DM=4,this.KIND_DELETION=5}createTextNote(e,t=[]){const n=this.nostrService.getPublicKey();if(!n)throw new Error("No public key available for creating text note");const s={kind:this.KIND_TEXT_NOTE,created_at:Math.floor(Date.now()/1e3),tags:t,content:e,pubkey:n};return console.log("📝 NIP-01 Creating text note:",s),s}createMetadata(e){return{kind:this.KIND_METADATA,created_at:Math.floor(Date.now()/1e3),tags:[],content:JSON.stringify(e),pubkey:this.nostrService.getPublicKey()}}validateEvent(e){if(!e.kind||typeof e.kind!="number")throw new Error("Event must have a valid kind number");if(!e.created_at||typeof e.created_at!="number")throw new Error("Event must have a valid created_at timestamp");if(!e.content||typeof e.content!="string")throw new Error("Event must have valid content string");if(!e.pubkey||typeof e.pubkey!="string")throw new Error("Event must have a valid pubkey");if(!Array.isArray(e.tags))throw new Error("Event tags must be an array");return!0}async publish(e){try{this.validateEvent(e);const{finalizeEvent:t}=await tt(()=>Promise.resolve().then(()=>Nl),void 0),n=t(e,this.nostrService.keyPair.privkey);if(!this.nostrService.pool)throw new Error("NostrService pool not available");let s=["wss://relay.damus.io"];if(this.nostrService.relayService&&this.nostrService.relayService.getRelayUrls){const o=this.nostrService.relayService.getRelayUrls();o.length>0&&(s=o)}console.log("📤 NIP-01 Publishing event:",n),console.log("📤 Using relays:",s);try{await Promise.race([this.nostrService.pool.publish(s,n),new Promise((o,i)=>setTimeout(()=>i(new Error("Publish timeout after 10s")),1e4))]),console.log("✅ NIP-01 Event published successfully")}catch(o){console.warn("⚠️ NIP-01 Publish warning:",o.message)}return n}catch(t){throw console.error("❌ NIP-01 Publish error:",t),t}}subscribe(e,t){try{if(!this.nostrService.pool)return console.warn("⚠️ NostrService pool not available"),null;let n=["wss://relay.damus.io"];if(this.nostrService.relayService&&this.nostrService.relayService.getRelayUrls){const o=this.nostrService.relayService.getRelayUrls();o.length>0&&(n=o)}return console.log("📡 NIP-01 Subscribing with filters:",e),console.log("📡 Using relays:",n),this.nostrService.pool.subscribeMany(n,e,{onevent:o=>{console.log("📨 NIP-01 Event received:",o),t&&t(o)},oneose:()=>{console.log("📡 NIP-01 Subscription ended")},onclose:()=>{console.log("📡 NIP-01 Subscription closed")}})}catch(n){return console.error("❌ NIP-01 Subscribe error:",n),null}}generateSubscriptionId(){return"sub_"+Math.random().toString(36).substr(2,9)}getEventHash(e){return this.nostrService.getEventHash(e)}getPublicKey(){return this.nostrService.getPublicKey()}createTags(e){const t=[];return e.reply&&t.push(["e",e.reply]),e.mention&&t.push(["p",e.mention]),e.hashtag&&t.push(["t",e.hashtag]),e.room&&t.push(["t",e.room]),e.client&&t.push(["client",e.client]),t}}class io{constructor(e,t){this.nostrService=e,this.nip01=t,this.KIND_CONTACTS=3,this.contacts=new Map,this.profiles=new Map}addContact(e,t="",n=""){return this.contacts.set(e,{pubkey:e,relay:t,petname:n,added_at:Date.now()}),console.log(`📝 NIP-02 Contact added: ${e}`),this.publishContactList()}removeContact(e){return this.contacts.delete(e)?(console.log(`🗑️ NIP-02 Contact removed: ${e}`),this.publishContactList()):Promise.resolve()}getContact(e){return this.contacts.get(e)}getAllContacts(){return Array.from(this.contacts.values())}isContact(e){return this.contacts.has(e)}getDisplayName(e){const t=this.contacts.get(e);if(t&&t.petname)return t.petname;const n=this.profiles.get(e);return n?n.display_name||n.name||this.formatPubkey(e):this.formatPubkey(e)}formatPubkey(e){return e?`${e.slice(0,8)}...${e.slice(-8)}`:"Unknown"}setProfile(e,t){this.profiles.set(e,t),console.log(`👤 NIP-02 Profile cached for: ${e}`)}getProfile(e){return this.profiles.get(e)}async publishContactList(){try{const e=[];for(const s of this.contacts.values()){const o=["p",s.pubkey];s.relay&&o.push(s.relay),s.petname&&o.push(s.petname),e.push(o)}const t={kind:this.KIND_CONTACTS,created_at:Math.floor(Date.now()/1e3),tags:e,content:"",pubkey:this.nostrService.getPublicKey()},n=await this.nip01.publish(t);return console.log("📤 NIP-02 Contact list published:",n),n}catch(e){throw console.error("❌ NIP-02 Failed to publish contact list:",e),e}}subscribeToContactLists(e){const t=[{kinds:[this.KIND_CONTACTS],authors:[this.nostrService.getPublicKey()],limit:1}];return console.log("📡 NIP-02 Subscribing to contact lists"),this.nip01.subscribe(t,n=>{this.processContactListEvent(n),e&&e(n)})}processContactListEvent(e){try{this.contacts.clear(),e.tags.forEach(t=>{if(t[0]==="p"&&t[1]){const n=t[1],s=t[2]||"",o=t[3]||"";this.contacts.set(n,{pubkey:n,relay:s,petname:o,added_at:e.created_at*1e3})}}),console.log(`📝 NIP-02 Processed contact list: ${this.contacts.size} contacts`)}catch(t){console.error("❌ NIP-02 Error processing contact list:",t)}}async loadContactProfiles(){const e=Array.from(this.contacts.keys());if(e.length===0)return;const t=[{kinds:[0],authors:e,limit:e.length}];return console.log("📡 NIP-02 Loading contact profiles"),this.nip01.subscribe(t,n=>{try{const s=JSON.parse(n.content);this.setProfile(n.pubkey,s),console.log(`👤 NIP-02 Profile loaded for: ${n.pubkey}`)}catch(s){console.error("❌ NIP-02 Error parsing profile:",s)}})}getContactsCount(){return this.contacts.size}searchContacts(e){if(!e)return this.getAllContacts();const t=e.toLowerCase();return this.getAllContacts().filter(n=>{const s=this.getDisplayName(n.pubkey).toLowerCase(),o=n.pubkey.toLowerCase();return s.includes(t)||o.includes(t)||n.petname&&n.petname.toLowerCase().includes(t)})}clearContacts(){this.contacts.clear(),this.profiles.clear(),console.log("🗑️ NIP-02 All contacts cleared")}}class ao{constructor(e,t){this.nostrService=e,this.nip01=t,this.KIND_ENCRYPTED_DM=4}async sendEncryptedDM(e,t){try{console.log("🔐 NIP-04 Verschlüssele DM für:",e);const n=await this.nostrService.encrypt(e,t),s=[["p",e]],o=await this.nip01.createTextNote(n,s);return o.kind=this.KIND_ENCRYPTED_DM,o.id=this.nostrService.getEventHash(o),o.sig=await this.nostrService.signEvent(o),await this.nip01.publish(o),console.log("✅ NIP-04 Verschlüsselte DM gesendet"),o}catch(n){throw console.error("❌ NIP-04 DM Fehler:",n),n}}async decryptDM(e){try{if(e.kind!==this.KIND_ENCRYPTED_DM)throw new Error("Not an encrypted DM event");let t=e.pubkey;const n=e.tags.filter(o=>o[0]==="p");e.pubkey===this.nostrService.getPublicKey()&&n.length>0&&(t=n[0][1]),console.log("🔓 NIP-04 Entschlüssele DM von:",t);const s=await this.nostrService.decrypt(t,e.content);return{...e,decryptedContent:s,senderPubkey:t,isDecrypted:!0}}catch(t){return console.error("❌ NIP-04 Entschlüsselung fehlgeschlagen:",t),{...e,decryptedContent:"[Entschlüsselung fehlgeschlagen]",senderPubkey:e.pubkey,isDecrypted:!1}}}subscribeToEncryptedDMs(e){const t=this.nostrService.getPublicKey(),n=[{kinds:[this.KIND_ENCRYPTED_DM],"#p":[t],since:Math.floor(Date.now()/1e3)-3600},{kinds:[this.KIND_ENCRYPTED_DM],authors:[t],since:Math.floor(Date.now()/1e3)-3600},{kinds:[1],"#p":[t],since:Math.floor(Date.now()/1e3)-24*60*60}];return console.log("📡 NIP-04 Abonniere verschlüsselte DMs und normale DMs"),this.nip01.subscribe(n,async s=>{try{if(s.kind===this.KIND_ENCRYPTED_DM){const o=await this.decryptDM(s);e(o)}else s.kind===1&&s.tags&&s.tags.some(i=>i[0]==="p"&&i[1]===t)&&(console.log("📨 NIP-04 Normale DM erhalten:",s),e({...s,isDecrypted:!0,decryptedContent:s.content,senderPubkey:s.pubkey,recipientPubkey:t,isDirectMessage:!0}))}catch(o){console.error("❌ NIP-04 DM Processing Error:",o)}})}async getConversationHistory(e,t=50){const n=this.nostrService.getPublicKey(),s=[{kinds:[this.KIND_ENCRYPTED_DM],authors:[n],"#p":[e],limit:Math.floor(t/2)},{kinds:[this.KIND_ENCRYPTED_DM],authors:[e],"#p":[n],limit:Math.floor(t/2)}];return new Promise(o=>{const i=[];let a=0;const c=this.nip01.subscribe(s,async h=>{try{const u=await this.decryptDM(h);if(i.push(u),a++,a>=t||Date.now()-l>5e3){try{typeof c.unsub=="function"?c.unsub():typeof c.close=="function"?c.close():typeof c.unsubscribe=="function"&&c.unsubscribe()}catch(p){console.warn("⚠️ Fehler beim Beenden der Subscription:",p)}o(i.sort((p,b)=>p.created_at-b.created_at))}}catch(u){console.error("❌ Error processing conversation history:",u)}}),l=Date.now();setTimeout(()=>{try{typeof c.unsub=="function"?c.unsub():typeof c.close=="function"?c.close():typeof c.unsubscribe=="function"&&c.unsubscribe()}catch(h){console.warn("⚠️ Fehler beim Beenden der Subscription (timeout):",h)}o(i.sort((h,u)=>h.created_at-u.created_at))},5e3)})}}class co{constructor(e,t){this.nostrService=e,this.nip01=t,this.KIND_CHANNEL_MESSAGE=42,this.KIND_CHANNEL_CREATE=40,this.KIND_CHANNEL_METADATA=41}async sendRoomMessage(e,t){try{console.log(`💬 NIP-28 Sende Nachricht in Raum: ${e}`);const n=[["t",e]],s=await this.nip01.createTextNote(t,n);return await this.nip01.publish(s),console.log("✅ NIP-28 Raum-Nachricht gesendet mit Tags:",n),s}catch(n){throw console.error("❌ NIP-28 Raum-Nachricht Fehler:",n),n}}async sendChannelMessage(e,t,n=null){return this.sendRoomMessage(e,t)}async createChannel(e,t,n=""){try{console.log(`🆕 NIP-28 Erstelle Kanal: ${e}`);const s={name:e,about:t,picture:n},o=await this.nip01.createTextNote(JSON.stringify(s),[]);return o.kind=this.KIND_CHANNEL_CREATE,o.id=this.nostrService.getEventHash(o),o.sig=await this.nostrService.signEvent(o),await this.nip01.publish(o),console.log("✅ NIP-28 Kanal erstellt:",o.id),{channelId:o.id,metadata:s,event:o}}catch(s){throw console.error("❌ NIP-28 Kanal-Erstellung Fehler:",s),s}}subscribeToChannel(e,t){const n=[{kinds:[this.KIND_CHANNEL_MESSAGE],"#e":[e],since:Math.floor(Date.now()/1e3)-3600}];return console.log(`📡 NIP-28 Abonniere Kanal: ${e}`),this.nip01.subscribe(n,s=>{const o=this.processChannelMessage(s,e);t(o)})}processChannelMessage(e,t){try{if(e.kind!==this.KIND_CHANNEL_MESSAGE)return console.warn("⚠️ Not a channel message event"),null;const n=e.tags.filter(a=>a[0]==="e"),s=n.find(a=>a[3]==="root"),o=n.find(a=>a[3]==="reply"),i=s?s[1]:n[0]?n[0][1]:null;return i!==t?(console.warn("⚠️ Message not for expected channel"),null):{...e,channelId:i,replyTo:o?o[1]:null,isChannelMessage:!0}}catch(n){return console.error("❌ NIP-28 Message Processing Error:",n),null}}async getChannelHistory(e,t=50){const n=[{kinds:[this.KIND_CHANNEL_MESSAGE],"#e":[e],limit:t}];return new Promise(s=>{const o=[];let i=0;const a=this.nip01.subscribe(n,l=>{const h=this.processChannelMessage(l,e);if(h&&o.push(h),i++,i>=t||Date.now()-c>5e3){try{typeof a.unsub=="function"?a.unsub():typeof a.close=="function"?a.close():typeof a.unsubscribe=="function"&&a.unsubscribe()}catch(u){console.warn("⚠️ Fehler beim Beenden der Subscription:",u)}s(o.sort((u,p)=>u.created_at-p.created_at))}}),c=Date.now();setTimeout(()=>{try{typeof a.unsub=="function"?a.unsub():typeof a.close=="function"?a.close():typeof a.unsubscribe=="function"&&a.unsubscribe()}catch(l){console.warn("⚠️ Fehler beim Beenden der Subscription (timeout):",l)}s(o.sort((l,h)=>l.created_at-h.created_at))},5e3)})}async sendRoomMessage(e,t){try{console.log(`🏠 NIP-28 Sende Raum-Nachricht: ${e}`);const n=[["t",e]],s=await this.nip01.createTextNote(t,n);return await this.nip01.publish(s),console.log("✅ NIP-28 Raum-Nachricht gesendet"),s}catch(n){throw console.error("❌ NIP-28 Raum-Nachricht Fehler:",n),n}}subscribeToRoom(e,t){console.log(`📡 NIP-28 Abonniere Raum mit strikter Filterung: ${e}`);const n=[{kinds:[1],"#t":[e],since:Math.floor(Date.now()/1e3)-24*60*60,limit:50}];return this.nip01.subscribe(n,s=>{if(s.kind!==1){console.log(`⚠️ NIP-28 Event ignoriert - falscher kind: ${s.kind}`);return}if(!s.tags||!Array.isArray(s.tags)){console.log("⚠️ NIP-28 Event ignoriert - keine Tags:",s);return}if(!s.tags.some(a=>Array.isArray(a)&&a.length>=2&&a[0]==="t"&&a[1]===e)){console.log(`⚠️ NIP-28 Event ignoriert - kein korrekter Room-Tag für ${e}:`,s.tags);return}if(s.tags.some(a=>Array.isArray(a)&&a.length>=2&&a[0]==="p")){console.log("⚠️ NIP-28 Event ignoriert - hat #p Tag (DM):",s.tags);return}console.log(`✅ NIP-28 Gültige Raum-Nachricht für ${e}:`,s),t({...s,roomName:e,isRoomMessage:!0})})}}class lo{constructor(e,t){this.nostrService=e,this.nip01=t,this.KIND_TEXT_NOTE=1}subscribeToDirectMessages(e){const t=this.nostrService.getPublicKey(),n=[{kinds:[this.KIND_TEXT_NOTE],"#p":[t],since:Math.floor(Date.now()/1e3)-24*60*60}];return console.log("📡 NIP-17 Abonniere Direct Messages (kind:1) mit strenger Filterung"),this.nip01.subscribe(n,s=>{if(s.kind!==this.KIND_TEXT_NOTE){console.log(`⚠️ NIP-17 Event ignoriert - falscher kind: ${s.kind}`);return}if(!s.tags||!Array.isArray(s.tags)){console.log("⚠️ NIP-17 Event ignoriert - keine Tags:",s);return}if(!s.tags.some(a=>Array.isArray(a)&&a.length>=2&&a[0]==="p"&&a[1]===t)){console.log("⚠️ NIP-17 Event ignoriert - kein #p Tag für uns:",s.tags);return}if(s.tags.some(a=>Array.isArray(a)&&a.length>=2&&a[0]==="t")){console.log("⚠️ NIP-17 Event ignoriert - hat #t Tag (Room-Message):",s.tags);return}console.log("✅ NIP-17 Gültige Direct Message:",s),e({...s,isDirectMessage:!0,senderPubkey:s.pubkey,recipientPubkey:t,content:s.content})})}async sendDirectMessage(e,t){try{console.log(`📤 NIP-17 Sende Direct Message an: ${e}`);const n=[["p",e]],s=await this.nip01.createTextNote(t,n);return await this.nip01.publish(s),console.log("✅ NIP-17 Direct Message gesendet mit Tags:",n),s}catch(n){throw console.error("❌ NIP-17 Direct Message Fehler:",n),n}}}class ho{constructor(e,t){this.nostrService=e,this.nip01=t,this.KIND_PRIVATE_GROUP_MESSAGE=104,this.KIND_PRIVATE_GROUP_METADATA=105,this.KIND_PRIVATE_GROUP_INVITE=106,this.privateGroups=new Map,this.memberKeys=new Map,this.initializeGroupsFromStorage()}async createPrivateGroup(e,t,n=[]){try{console.log(`🔐 NIP-104 Erstelle private Gruppe: ${e}`);const s=this.generateSharedKey(),o=this.generateGroupId(e),i={name:e,description:t,creator:this.nostrService.getPublicKey(),created_at:Math.floor(Date.now()/1e3),members:[this.nostrService.getPublicKey(),...n]},a=await this.encryptGroupData(JSON.stringify(i),s),c=await this.nip01.createTextNote(a,[["d",o],["t","private-group"]]);c.kind=this.KIND_PRIVATE_GROUP_METADATA,c.id=this.nostrService.getEventHash(c),c.sig=await this.nostrService.signEvent(c),await this.nip01.publish(c),this.privateGroups.set(o,i),this.memberKeys.set(o,s);for(const l of n)await this.inviteToGroup(o,l,s);return console.log("✅ NIP-104 Private Gruppe erstellt"),{groupId:o,metadata:i,event:c}}catch(s){throw console.error("❌ NIP-104 Gruppe erstellen Fehler:",s),s}}async sendPrivateGroupMessage(e,t){try{console.log(`💬 NIP-104 Sende Nachricht in private Gruppe: ${e}`);const n=this.memberKeys.get(e);if(!n)throw new Error("Keine Berechtigung für diese Gruppe");const s=await this.encryptGroupData(t,n),o=await this.nip01.createTextNote(s,[["d",e],["t","private-group-message"]]);return o.kind=this.KIND_PRIVATE_GROUP_MESSAGE,o.id=this.nostrService.getEventHash(o),o.sig=await this.nostrService.signEvent(o),await this.nip01.publish(o),console.log("✅ NIP-104 Private Gruppennachricht gesendet"),o}catch(n){throw console.error("❌ NIP-104 Gruppennachricht Fehler:",n),n}}async inviteToGroup(e,t,n){try{console.log(`📧 NIP-104 Lade User in Gruppe ein: ${t.slice(0,8)}...`);const s=await this.nostrService.encrypt(t,n),o=await this.nip01.createTextNote(s,[["d",e],["p",t],["t","private-group-invite"]]);return o.kind=this.KIND_PRIVATE_GROUP_INVITE,o.id=this.nostrService.getEventHash(o),o.sig=await this.nostrService.signEvent(o),await this.nip01.publish(o),console.log("✅ NIP-104 Einladung gesendet"),o}catch(s){throw console.error("❌ NIP-104 Einladung Fehler:",s),s}}subscribeToPrivateGroup(e,t){const n=[{kinds:[this.KIND_PRIVATE_GROUP_MESSAGE],"#d":[e],since:Math.floor(Date.now()/1e3)-3600}];return console.log(`📡 NIP-104 Abonniere private Gruppe: ${e}`),this.nip01.subscribe(n,async s=>{try{const o=await this.decryptGroupMessage(s,e);o&&t(o)}catch(o){console.error("❌ NIP-104 Message Processing Error:",o)}})}subscribeToGroupInvites(e){const t=this.nostrService.getPublicKey(),n=[{kinds:[this.KIND_PRIVATE_GROUP_INVITE],"#p":[t],since:Math.floor(Date.now()/1e3)-3600}];return console.log("📡 NIP-104 Abonniere Gruppeneinladungen"),this.nip01.subscribe(n,async s=>{try{const o=await this.processGroupInvite(s);o&&e(o)}catch(o){console.error("❌ NIP-104 Invite Processing Error:",o)}})}async processGroupInvite(e){try{const t=e.tags.find(s=>s[0]==="d")?.[1];if(!t)return null;const n=await this.nostrService.decrypt(e.pubkey,e.content);return this.memberKeys.set(t,n),{groupId:t,inviter:e.pubkey,sharedKey:n,timestamp:e.created_at}}catch(t){return console.error("❌ NIP-104 Invite processing failed:",t),null}}async decryptGroupMessage(e,t){try{const n=this.memberKeys.get(t);if(!n)return console.warn(`⚠️ NIP-104 Keine Berechtigung für Gruppe: ${t}`),null;const s=await this.decryptGroupData(e.content,n);return{...e,decryptedContent:s,groupId:t,isDecrypted:!0,isPrivateGroupMessage:!0}}catch(n){return console.error("❌ NIP-104 Nachricht entschlüsseln fehlgeschlagen:",n),{...e,decryptedContent:"[Entschlüsselung fehlgeschlagen]",groupId:t,isDecrypted:!1,isPrivateGroupMessage:!0}}}generateSharedKey(){return Array.from(crypto.getRandomValues(new Uint8Array(32))).map(e=>e.toString(16).padStart(2,"0")).join("")}generateGroupId(e){return`group_${e.toLowerCase().replace(/\s+/g,"_")}_${Date.now()}`}async encryptGroupData(e,t){return btoa(e+":"+t)}async decryptGroupData(e,t){try{const n=atob(e),[s,o]=n.split(":");if(o===t)return s;throw new Error("Invalid key")}catch{throw new Error("Decryption failed")}}getGroupInfo(e){return this.privateGroups.get(e)}getAllPrivateGroups(){return Array.from(this.privateGroups.entries()).map(([e,t])=>({groupId:e,...t}))}async createRealPrivateGroup(e,t,n=[]){try{console.log(`🔐 Erstelle ECHTE private Gruppe: ${e}`);const s=this.generateSecureGroupId(),o=this.generateSecureGroupKey(),i={id:s,name:e,description:t,creator:this.nostrService.getPublicKey(),created_at:Math.floor(Date.now()/1e3),type:"private_secure",memberCount:n.length+1,inviteOnly:!0},a={...i,members:Array.from(new Set([this.nostrService.getPublicKey(),...n])),key:o,isCreator:!0};this.privateGroups.set(s,{...a,members:new Set([this.nostrService.getPublicKey(),...n])}),this.saveGroupToStorage(s,a);const c=[];for(const l of n)try{const h=await this.sendSecureGroupInvitation(s,l,o,i);c.push(h)}catch(h){console.error(`❌ Fehler beim Senden der Einladung an ${l}:`,h)}return await this.publishSecureGroupCreation(s,i,o),console.log("✅ ECHTE private Gruppe erstellt:",{groupId:s,name:e,members:n.length+1,invitationsSent:c.length}),{groupId:s,groupKey:o,metadata:i,invitationResults:c}}catch(s){throw console.error("❌ Fehler beim Erstellen der privaten Gruppe:",s),s}}async sendSecureGroupInvitation(e,t,n,s){try{console.log(`📤 Sende sichere Einladung an: ${t.slice(0,16)}...`);const o={type:"group_invitation",groupId:e,groupKey:n,groupMetadata:s,invitedBy:this.nostrService.getPublicKey(),inviteCode:this.generateInviteCode(),timestamp:Date.now(),expiresAt:Date.now()+7*24*60*60*1e3},i=await this.encryptForRecipient(JSON.stringify(o),t),a=await this.nip01.createTextNote(i,[["p",t],["k",this.KIND_PRIVATE_GROUP_INVITE.toString()],["g",e],["invite","secure"]]);return a.kind=this.KIND_PRIVATE_GROUP_INVITE,a.id=this.nostrService.getEventHash(a),a.sig=await this.nostrService.signEvent(a),await this.nip01.publish(a),console.log("✅ Sichere Einladung gesendet"),{recipientPubkey:t,inviteEventId:a.id,sent:!0}}catch(o){throw console.error("❌ Fehler beim Senden der sicheren Einladung:",o),o}}generateSecureGroupId(){const e=Date.now().toString(36),t=crypto.getRandomValues(new Uint8Array(16)),n=Array.from(t).map(s=>s.toString(16).padStart(2,"0")).join("");return`secure_group_${e}_${n}`}generateSecureGroupKey(){const e=crypto.getRandomValues(new Uint8Array(32));return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}generateInviteCode(){const e=crypto.getRandomValues(new Uint8Array(8));return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}async encryptForRecipient(e,t){try{return await this.nostrService.encrypt(e,t)}catch(n){return console.error("❌ Verschlüsselung für Empfänger fehlgeschlagen:",n),btoa(e)}}async publishSecureGroupCreation(e,t,n){try{const s=await this.encryptWithGroupKey(JSON.stringify(t),n),o=await this.nip01.createTextNote(s,[["d",e],["t","secure_private_group"],["encrypted","true"]]);o.kind=this.KIND_PRIVATE_GROUP_METADATA,o.id=this.nostrService.getEventHash(o),o.sig=await this.nostrService.signEvent(o),await this.nip01.publish(o),console.log("✅ Sichere Gruppen-Erstellung veröffentlicht")}catch(s){throw console.error("❌ Fehler beim Veröffentlichen der Gruppen-Erstellung:",s),s}}async encryptWithGroupKey(e,t){try{const s=new TextEncoder().encode(e),o=new Uint8Array(32);for(let a=0;a<32;a++)o[a]=parseInt(t.substr(a*2,2),16);const i=new Uint8Array(s.length);for(let a=0;a<s.length;a++)i[a]=s[a]^o[a%32];return btoa(String.fromCharCode(...i))}catch(n){throw console.error("❌ Verschlüsselung mit Gruppenschlüssel fehlgeschlagen:",n),n}}hasGroupAccess(e){const t=this.privateGroups.get(e);if(!t)return!1;const n=this.nostrService.getPublicKey();return t.members.has(n)}getUserPrivateGroups(){const e=[],t=this.nostrService.getPublicKey();for(const[n,s]of this.privateGroups)s.members.has(t)&&e.push({groupId:n,name:s.name,description:s.description,memberCount:s.members.size,isCreator:s.isCreator||!1,created_at:s.created_at});return e}async leaveGroup(e){try{console.log(`🚪 NIP-104 Verlasse Gruppe: ${e}`),this.memberKeys.delete(e),this.privateGroups.delete(e),console.log("✅ NIP-104 Gruppe verlassen")}catch(t){throw console.error("❌ NIP-104 Gruppe verlassen Fehler:",t),t}}saveGroupToStorage(e,t){try{const n=this.loadGroupsFromStorage();n[e]=t,localStorage.setItem("privateGroups",JSON.stringify(n)),console.log("💾 Gruppe in localStorage gespeichert:",e)}catch(n){console.error("❌ Fehler beim Speichern der Gruppe:",n)}}loadGroupsFromStorage(){try{const e=localStorage.getItem("privateGroups");return e?JSON.parse(e):{}}catch(e){return console.error("❌ Fehler beim Laden der Gruppen:",e),{}}}initializeGroupsFromStorage(){try{const e=this.loadGroupsFromStorage();console.log("📂 Lade Gruppen aus localStorage:",Object.keys(e));for(const[t,n]of Object.entries(e)){const s={...n,members:new Set(n.members||[])};this.privateGroups.set(t,s)}console.log("✅ Gruppen aus localStorage geladen:",this.privateGroups.size)}catch(e){console.error("❌ Fehler beim Initialisieren der Gruppen:",e)}}}class Rr{constructor(){this.activeModals=new Set}create({title:e,body:t,buttons:n=[],closable:s=!0,className:o=""}){const i=document.createElement("div");i.className=`modal ${o}`,i.innerHTML=`
            <div class="modal-content">
                <div class="modal-header">
                    <h3>${e}</h3>
                    ${s?`<button class="modal-close" onclick="this.closest('.modal').remove()">×</button>`:""}
                </div>
                <div class="modal-body">
                    ${t}
                </div>
                ${n.length>0?`
                <div class="modal-footer">
                    ${n.map(c=>`
                        <button class="btn ${c.class||"btn-secondary"}" 
                                onclick="${c.onclick||""}"
                                ${c.disabled?"disabled":""}>
                            ${c.text}
                        </button>
                    `).join("")}
                </div>
                `:""}
            </div>
        `,document.body.appendChild(i),this.activeModals.add(i);const a=i.querySelector("input, select, textarea");if(a&&setTimeout(()=>a.focus(),100),s){const c=l=>{l.key==="Escape"&&(this.close(i),document.removeEventListener("keydown",c))};document.addEventListener("keydown",c)}return i}createForm({title:e,fields:t,onSubmit:n,submitText:s="OK",cancelText:o="Abbrechen"}){const i=`
            <form id="modalForm">
                ${t.map(c=>`
                    <div class="form-group">
                        <label>${c.label}</label>
                        ${this.renderFormField(c)}
                    </div>
                `).join("")}
            </form>
        `,a=this.create({title:e,body:i,buttons:[{text:o,class:"btn-secondary",onclick:"this.closest('.modal').remove()"},{text:s,class:"btn-primary",onclick:"this.closest('.modal').modalComponent.submitForm()"}]});return a.modalComponent={submitForm:()=>{const c=this.getFormData(a);n&&n(c)!==!1&&this.close(a)}},a}renderFormField(e){const t=`
            id="${e.id||e.name}"
            name="${e.name}"
            ${e.required?"required":""}
            ${e.placeholder?`placeholder="${e.placeholder}"`:""}
            ${e.value?`value="${e.value}"`:""}
        `;switch(e.type){case"select":return`
                    <select ${t}>
                        ${e.options.map(n=>`
                            <option value="${n.value}" ${n.selected?"selected":""}>
                                ${n.text}
                            </option>
                        `).join("")}
                    </select>
                `;case"textarea":return`<textarea ${t} rows="${e.rows||3}">${e.value||""}</textarea>`;default:return`<input type="${e.type||"text"}" ${t} />`}}getFormData(e){const t=e.querySelector("#modalForm"),n=new FormData(t),s={};for(let[o,i]of n.entries())s[o]=i;return s}close(e){e&&e.parentNode&&(e.parentNode.removeChild(e),this.activeModals.delete(e))}closeAll(){this.activeModals.forEach(e=>this.close(e))}confirm({title:e,message:t,onConfirm:n,confirmText:s="Bestätigen",cancelText:o="Abbrechen"}){return this.create({title:e,body:`<p>${t}</p>`,buttons:[{text:o,class:"btn-secondary",onclick:"this.closest('.modal').remove()"},{text:s,class:"btn-primary",onclick:`
                        ${n?"this.closest('.modal').modalComponent.confirm()":""};
                        this.closest('.modal').remove()
                    `}]})}alert({title:e,message:t,buttonText:n="OK"}){return this.create({title:e,body:`<p>${t}</p>`,buttons:[{text:n,class:"btn-primary",onclick:"this.closest('.modal').remove()"}]})}}class ql{constructor(e,t){this.nip28=e,this.toastService=t,this.modal=new Rr,this.publicRooms=[{id:"dreammall-support",name:"DreamMall Support",description:"Technischer Support und Hilfe",type:"public"},{id:"dreammall-hilfe",name:"DreamMall Hilfe",description:"Allgemeine Fragen und Diskussionen",type:"public"}],this.privateRooms=[{id:"private:dm-orga",name:"DM Orga",description:"Interne Organisation",type:"private",members:[]}]}renderRoomSections(){return`
            <div class="room-section">
                <h4 class="section-title">
                    🌍 Öffentliche Räume
                    <div class="room-actions">
                        <button class="btn btn-sm" id="joinPublicRoomBtn">🚪 Beitreten</button>
                    </div>
                </h4>
                <div class="rooms public-rooms" id="publicRoomList">
                    ${this.renderRoomList(this.publicRooms)}
                </div>
            </div>
            
            <div class="room-section">
                <h4 class="section-title">
                    🔐 Geschlossene Räume
                    <div class="room-actions">
                        <button class="btn btn-sm" id="createPrivateRoomBtn">➕ Erstellen</button>
                        <button class="btn btn-sm" id="joinPrivateRoomBtn">🚪 Beitreten</button>
                    </div>
                </h4>
                <div class="rooms private-rooms" id="privateRoomList">
                    ${this.renderRoomList(this.privateRooms)}
                </div>
            </div>
        `}renderRoomList(e){return e.map(t=>`
            <div class="room" data-room="${t.id}" data-type="${t.type}">
                <div class="room-name">${t.type==="private"?"🔐 ":""}${t.name}</div>
                <div class="room-status">${t.description}</div>
            </div>
        `).join("")}setupEventListeners(e,t){e.addEventListener("click",i=>{const a=i.target.closest(".room");if(a){const c=a.dataset.room,l=a.dataset.type;this.canAccessRoom(c,l)?(t(c),this.setActiveRoom(e,c)):this.toastService.showError("Zugriff auf diesen Raum nicht erlaubt")}});const n=e.querySelector("#createPrivateRoomBtn"),s=e.querySelector("#joinPublicRoomBtn"),o=e.querySelector("#joinPrivateRoomBtn");n&&n.addEventListener("click",()=>this.showCreateRoomModal()),s&&s.addEventListener("click",()=>this.showJoinRoomModal("public")),o&&o.addEventListener("click",()=>this.showJoinRoomModal("private"))}canAccessRoom(e,t){return t==="public"?!0:!!this.privateRooms.find(s=>s.id===e)}setActiveRoom(e,t){e.querySelectorAll(".room").forEach(s=>{s.classList.remove("active")});const n=e.querySelector(`[data-room="${t}"]`);n&&n.classList.add("active")}showCreateRoomModal(){this.modal.createForm({title:"Neuen Raum erstellen",fields:[{name:"roomName",label:"Raum-Name",type:"text",placeholder:"Mein neuer Raum",required:!0},{name:"roomDescription",label:"Beschreibung",type:"text",placeholder:"Kurze Beschreibung"},{name:"roomType",label:"Raum-Typ",type:"select",options:[{value:"public",text:"🌍 Öffentlich"},{value:"private",text:"🔐 Geschlossen"}]}],onSubmit:e=>this.createRoom(e),submitText:"Erstellen"})}showJoinRoomModal(e="public"){this.modal.createForm({title:"Raum beitreten",fields:[{name:"roomId",label:"Raum-ID oder Name",type:"text",placeholder:"Raum-ID eingeben",required:!0},{name:"inviteCode",label:"Einladungscode (optional)",type:"text",placeholder:"Für geschlossene Räume"}],onSubmit:t=>this.joinRoom(t),submitText:"Beitreten"})}async createRoom(e){try{const{roomName:t,roomDescription:n,roomType:s}=e;if(s==="public"){const i={id:(await this.nip28.createChannel(t,n)).channelId,name:t,description:n,type:"public"};this.publicRooms.push(i),this.updateRoomList("public")}else{const i={id:`private:${t.toLowerCase().replace(/\s+/g,"-")}`,name:t,description:n,type:"private",members:[]};this.privateRooms.push(i),this.updateRoomList("private")}this.toastService.showSuccess(`Raum "${t}" wurde erstellt`)}catch(t){return console.error("❌ Fehler beim Erstellen des Raums:",t),this.toastService.showError("Fehler beim Erstellen des Raums"),!1}}async joinRoom(e){try{const{roomId:t,inviteCode:n}=e,s={id:t,name:t,description:"Beigetretener Raum",type:t.startsWith("private:")?"private":"public"};s.type==="private"?(s.members=[],this.privateRooms.push(s),this.updateRoomList("private")):(this.publicRooms.push(s),this.updateRoomList("public")),this.toastService.showSuccess(`Raum "${t}" beigetreten`)}catch(t){return console.error("❌ Fehler beim Beitreten des Raums:",t),this.toastService.showError("Fehler beim Beitreten des Raums"),!1}}updateRoomList(e){const t=e==="public"?"publicRoomList":"privateRoomList",n=document.getElementById(t);if(n){const s=e==="public"?this.publicRooms:this.privateRooms;n.innerHTML=this.renderRoomList(s)}}getRoom(e){return[...this.publicRooms,...this.privateRooms].find(t=>t.id===e)}getAllRooms(){return{public:this.publicRooms,private:this.privateRooms}}}function Vl(r,e,t){console.log("🔐 Öffne Erstelle Private Gruppe Modal...");const n=document.createElement("div");n.className="modal-overlay",n.innerHTML=`
        <div class="modal">
            <div class="modal-header">
                <h3>🔐 Neue verschlüsselte Gruppe erstellen</h3>
                <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Gruppenname:</label>
                    <input type="text" id="groupName" placeholder="Mein sicherer Raum" required>
                </div>
                <div class="form-group">
                    <label>Beschreibung:</label>
                    <textarea id="groupDescription" placeholder="Beschreibung der Gruppe (optional)"></textarea>
                </div>
                <div class="form-group">
                    <label>Mitglieder einladen (optional):</label>
                    <input type="text" id="inviteMembers" placeholder="npub1... oder hex pubkey (kommagetrennt)">
                    <small>Leer lassen, um später Mitglieder einzuladen</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">
                    Abbrechen
                </button>
                <button class="btn btn-primary" onclick="createPrivateGroup()">
                    Gruppe erstellen
                </button>
            </div>
        </div>
    `,document.body.appendChild(n),setTimeout(()=>n.classList.add("show"),10),window.createPrivateGroup=async()=>{const o=document.getElementById("groupName").value.trim(),i=document.getElementById("groupDescription").value.trim(),a=document.getElementById("inviteMembers").value.trim();if(!o){e.showError("Gruppenname ist erforderlich");return}const c=a?a.split(",").map(l=>l.trim()).filter(l=>l.length>0):[];try{await s(o,i,c),n.remove()}catch(l){console.error("❌ Fehler beim Erstellen der Gruppe:",l),e.showError("Fehler beim Erstellen der Gruppe")}};async function s(o,i,a){try{console.log("🔐 Erstelle private Gruppe:",{groupName:o,description:i,invitedMembers:a});const c=await r.createRealPrivateGroup(o,i,a);e.showSuccess(`Verschlüsselte Gruppe "${o}" erstellt!`),t&&t()}catch(c){throw console.error("❌ Fehler beim Erstellen der privaten Gruppe:",c),e.showError("Fehler beim Erstellen der Gruppe"),c}}}class jl{constructor(e,t){this.nostrService=e,this.toastService=t,this.nip01=new oo(e),this.nip02=new io(e,this.nip01),this.nip04=new ao(e,this.nip01),this.nip28=new co(e,this.nip01),this.nip17=new lo(e,this.nip01),this.nip104=new ho(e,this.nip01),this.modal=new Rr,this.roomManager=new ql(this.nip28,t),this.currentRoom=$l.defaultRoom,this.currentView="room",this.currentDMUser=null,this.messages=new Map,this.dmContacts=new Map,this.roomConfig=_l,this.subscriptions=new Map,this.element=null}render(){return this.element=document.createElement("div"),this.element.className="main",this.element.innerHTML=`
            <div class="sidebar">
                <div class="sidebar-header">
                    <div class="sidebar-tabs">
                        <button class="tab-btn active" id="roomsTab">🏠 Räume</button>
                        <button class="tab-btn" id="dmsTab">💬 DMs</button>
                    </div>
                </div>
                
                <!-- Rooms Tab -->
                <div class="tab-content active" id="roomsContent">
                    ${this.renderRoomsSection()}
                </div>
                
                <!-- DMs Tab -->
                <div class="tab-content" id="dmsContent">
                    ${this.renderDMSection()}
                </div>
            </div>
            
            <div class="chat">
                <div class="chat-header">
                    <h3 id="chatTitle">Offener Test Raum</h3>
                    <div class="chat-controls">
                         
                    </div>
                </div>
                
                <div class="messages" id="messages">
                    <div class="welcome">
                        <h3>Willkommen im Offenen Test Raum! 🎉</h3>
                        <p>Saubere Test-Umgebung ohne alte Daten...</p>
                        <small>🔑 Account: e3f3e3f6a562c3f4382f5c23eaf557c915bb15abdfb784c2f5ee03a96debb76e</small>
                    </div>
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <input type="text" id="messageInput" placeholder="Test-Nachricht schreiben..." />
                        <button class="btn btn-primary" id="sendBtn">📤</button>
                    </div>
                </div>
            </div>
        `,this.setupEventListeners(),this.initializeChat(),this.element}renderRoomsSection(){return`
            <div class="room-section">
                <h4 class="section-title">🌍 Test Räume (V2)</h4>
                <div class="rooms public-rooms">
                    <div class="room active" data-room="dreamtest-public-v2">
                        <div class="room-name">Offener Test Raum</div>
                        <div class="room-status">Öffentlich - Für alle</div>
                    </div>
                    <div class="room" data-room="dreamtest-private-v2">
                        <div class="room-name">Geschlossener Test Raum</div>
                        <div class="room-status">Privat - Mit Einladung</div>
                    </div>
                </div>
                
                <div class="room-info">
                    <small>ℹ️ Neue saubere Test-Umgebung ohne alte Daten</small>
                </div>
            </div>
            
            <div class="private-groups-section">
                <h4 class="section-title">🔐 Private Gruppen</h4>
                <div class="private-groups-actions">
                    <button class="btn btn-sm btn-primary" id="createPrivateGroupBtn">
                        ➕ Neue verschlüsselte Gruppe
                    </button>
                </div>
                <div class="private-groups-list" id="privateGroupsList">
                    <div class="loading">
                        <p>Lade private Gruppen...</p>
                    </div>
                </div>
            </div>
        `}renderDMSection(){return`
            <div class="dm-actions">
                <input type="text" id="dmUserInput" placeholder="npub... oder hex pubkey" />
                <button class="btn btn-sm" id="startDMBtn">💬 Start DM</button>
            </div>
            <div class="dm-contacts" id="dmContacts">
                ${this.renderDMContactsList()}
            </div>
        `}renderDMContactsList(){return this.dmContacts.size===0?`
                <div class="no-contacts">
                    <p>Keine DM-Kontakte</p>
                    <small>Gib einen npub oder pubkey ein, um eine verschlüsselte Unterhaltung zu starten</small>
                </div>
            `:Array.from(this.dmContacts.entries()).map(([t,n])=>{const s=this.currentDMUser===t,o=n.unreadCount||0,i=n.lastMessage||"",a=n.lastMessageTime||0;return`
                <div class="dm-contact ${s?"active":""}" data-pubkey="${t}">
                    <div class="avatar">${n.displayName?n.displayName.charAt(0).toUpperCase():"?"}</div>
                    <div class="contact-info">
                        <div class="contact-name">${n.displayName||this.formatPubkey(t)}</div>
                        <div class="contact-last-message">${i.substring(0,50)}${i.length>50?"...":""}</div>
                    </div>
                    <div class="contact-meta">
                        <div class="contact-time">${this.formatTime(a)}</div>
                        ${o>0?`<div class="unread-badge">${o}</div>`:""}
                    </div>
                </div>
            `}).join("")}formatPubkey(e){return`${e.slice(0,8)}...${e.slice(-8)}`}formatTime(e){if(!e)return"";const t=new Date,n=new Date(e),s=t-n;return s<6e4?"jetzt":s<36e5?`${Math.floor(s/6e4)}m`:s<864e5?`${Math.floor(s/36e5)}h`:n.toLocaleDateString()}setupEventListeners(){const e=this.element.querySelector("#sendBtn"),t=this.element.querySelector("#messageInput");e.addEventListener("click",()=>this.handleSendMessage()),t.addEventListener("keypress",h=>{h.key==="Enter"&&this.handleSendMessage()});const n=this.element.querySelector("#roomsTab"),s=this.element.querySelector("#dmsTab");n.addEventListener("click",()=>this.switchTab("rooms")),s.addEventListener("click",()=>this.switchTab("dms")),this.element.querySelector("#roomsContent").addEventListener("click",h=>{const u=h.target.closest(".room");u&&u.dataset.room&&this.switchRoom(u.dataset.room)});const i=this.element.querySelector("#startDMBtn"),a=this.element.querySelector("#dmUserInput");i.addEventListener("click",()=>this.startDirectMessage()),a.addEventListener("keypress",h=>{h.key==="Enter"&&this.startDirectMessage()}),this.element.querySelector("#dmContacts").addEventListener("click",h=>{const u=h.target.closest(".dm-contact");if(u){const p=u.dataset.pubkey;this.openDirectMessage(p)}});const l=this.element.querySelector("#createPrivateGroupBtn");l&&l.addEventListener("click",()=>{Vl(this.nip104,this.toastService,()=>this.updatePrivateGroupsList())})}async initializeChat(){console.log("🔄 Initialisiere Chat..."),De.clearStorageOnStart&&(console.log("🗑️ Fresh Start aktiviert - lösche alte Nachrichten"),this.clearAllStoredMessages()),await this.loadRoomMessages(this.currentRoom),await this.loadDMContacts(),this.updatePrivateGroupsList(),window.enterPrivateGroup=e=>this.enterPrivateGroup(e),window.leavePrivateGroup=e=>this.leavePrivateGroup(e),window.inviteToPrivateGroup=e=>this.inviteToPrivateGroup(e),this.subscribeToRoomMessages(),this.subscribeToDirectMessages(),this.subscribeToPrivateGroupMessages()}clearAllStoredMessages(){try{console.log("🗑️ Lösche alle gespeicherten Nachrichten...");const e=[];for(let n=0;n<localStorage.length;n++)e.push(localStorage.key(n));let t=0;e.forEach(n=>{n.startsWith("messages_")&&(localStorage.removeItem(n),t++,console.log(`🗑️ Gelöscht: ${n}`))}),console.log(`✅ ${t} Nachrichten-Einträge aus localStorage gelöscht`)}catch(e){console.error("❌ Fehler beim Löschen der gespeicherten Nachrichten:",e)}}clearAllLocalStorage(){try{console.log("🗑️ Lösche kompletten localStorage..."),localStorage.clear(),console.log("✅ LocalStorage komplett gelöscht")}catch(e){console.error("❌ Fehler beim Löschen des localStorage:",e)}}async handleSendMessage(){const e=this.element.querySelector("#messageInput");if(!e)return;const t=e.value.trim();if(t)try{console.log("📤 Sende Nachricht:",t);const n={content:t,author:"You",timestamp:Date.now(),type:this.currentView};this.displayMessage(n);const s=this.currentView==="dm"?`dm_${this.currentDMUser}`:this.currentRoom;this.storeMessage(n,s),this.currentView==="dm"&&this.currentDMUser?await this.sendDirectMessage(this.currentDMUser,t):this.currentView==="private_group"?await this.sendPrivateGroupMessage(this.currentRoom,t):this.currentView==="room"&&await this.sendRoomMessage(this.currentRoom,t),e.value=""}catch(n){console.error("❌ Fehler beim Senden der Nachricht:",n),this.toastService.showError("Fehler beim Senden der Nachricht")}}async sendDirectMessage(e,t){try{if(!this.nip04)throw new Error("NIP-04 nicht verfügbar");await this.nip04.sendDirectMessage(e,t),console.log("✅ DM gesendet an:",e)}catch(n){throw console.error("❌ Fehler beim Senden der DM:",n),n}}async sendPrivateGroupMessage(e,t){try{if(!this.nip104)throw new Error("NIP-104 nicht verfügbar");await this.nip104.sendPrivateGroupMessage(e,t),console.log("✅ Gruppennachricht gesendet an:",e)}catch(n){throw console.error("❌ Fehler beim Senden der Gruppennachricht:",n),n}}async sendRoomMessage(e,t){try{if(!this.nip28)throw new Error("NIP-28 nicht verfügbar");await this.nip28.sendRoomMessage(e,t),console.log("✅ Raum-Nachricht gesendet an:",e)}catch(n){throw console.error("❌ Fehler beim Senden der Raum-Nachricht:",n),n}}async startDirectMessage(){const e=this.element.querySelector("#dmUserInput");if(!e)return;const t=e.value.trim();if(t)try{console.log("💬 Starte DM mit:",t);let n;try{if(t.startsWith("npub1"))n=this.nostrService.npubToHex(t);else if(t.length===64)n=t;else throw new Error("Invalid format")}catch{this.toastService.showError("Ungültiges Format. Verwende npub1... oder hex pubkey");return}this.nip02&&await this.nip02.addContact(n),this.dmContacts.set(n,{name:`User ${n.slice(0,8)}`,pubkey:n,lastMessage:"",unreadCount:0});const s=Object.fromEntries(this.dmContacts);localStorage.setItem("dmContacts",JSON.stringify(s)),this.nip04&&this.nip04.subscribeToDirectMessages(n,o=>{this.handleDirectMessage(o)}),this.openDirectMessage(n),e.value="",await this.loadDMContacts()}catch(n){console.error("❌ Fehler beim Starten der DM:",n),this.toastService.showError("Fehler beim Starten der DM")}}openDirectMessage(e){try{console.log("📩 Öffne DM mit:",e),this.currentDMUser=e,this.currentView="dm";const t=this.dmContacts.get(e),n=t?t.name:`User ${e.slice(0,8)}`;this.updateChatHeader(`💬 ${n}`),this.loadDMMessages(e),this.element.querySelectorAll(".dm-contact").forEach(i=>i.classList.remove("active"));const o=this.element.querySelector(`[data-pubkey="${e}"]`);o&&o.classList.add("active")}catch(t){console.error("❌ Fehler beim Öffnen der DM:",t)}}async loadDMMessages(e){try{console.log(`📜 Lade DM-Nachrichten für: ${e}`);const t=this.getStoredMessages(`dm_${e}`)||[];if(this.displayMessages(t),this.nip04){console.log("🔄 Lade DM-Nachrichten aus dem NOSTR-Netzwerk..."),this.nip04.subscribeToDirectMessages(e,s=>{this.handleDirectMessage(s)});const n=await this.nip04.getDirectMessages(e);if(n&&n.length>0){console.log(`📥 ${n.length} DM-Nachrichten aus dem Netzwerk geladen`);const s=[...t];for(const o of n)s.find(i=>i.id===o.id)||(s.push(o),this.storeMessage(o,`dm_${e}`));s.sort((o,i)=>o.created_at-i.created_at),this.displayMessages(s)}}}catch(t){console.error("❌ Fehler beim Laden der DM-Nachrichten:",t)}}handleDirectMessage(e){if(console.log("📩 Neue Direktnachricht:",e),!this.storeMessage(e,`dm_${e.from||e.pubkey}`)){console.log("⚠️ DM nicht angezeigt (Duplikat oder Fehler)");return}const n=e.from||e.pubkey;if(this.dmContacts.has(n)){const s=this.dmContacts.get(n);s.lastMessage=e.content,s.lastMessageTime=e.created_at*1e3,s.unreadCount=(s.unreadCount||0)+1;const o=Object.fromEntries(this.dmContacts);localStorage.setItem("dmContacts",JSON.stringify(o))}if(this.currentView==="dm"&&this.currentDMUser===n){this.displayMessage(e);const s=this.dmContacts.get(n);if(s){s.unreadCount=0;const o=Object.fromEntries(this.dmContacts);localStorage.setItem("dmContacts",JSON.stringify(o))}}if(this.updateDMContactsList(),this.currentView!=="dm"||this.currentDMUser!==n){const s=this.dmContacts.get(n),o=s?s.name:`User ${n.slice(0,8)}`;this.toastService.showInfo(`💬 Neue Nachricht von ${o}`)}}async loadDMContacts(){try{console.log("👥 Lade DM-Kontakte...");const e=localStorage.getItem("dmContacts");if(e){const t=JSON.parse(e);this.dmContacts=new Map(Object.entries(t))}if(this.nip02)try{const t=this.nip02.getAllContacts();if(t&&Array.isArray(t)&&t.length>0){console.log(`📇 ${t.length} Kontakte aus dem Netzwerk geladen`);for(const s of t)s.pubkey&&!this.dmContacts.has(s.pubkey)&&this.dmContacts.set(s.pubkey,{name:s.name||s.petname||`User ${s.pubkey.slice(0,8)}`,pubkey:s.pubkey,lastMessage:"",unreadCount:0});const n=Object.fromEntries(this.dmContacts);localStorage.setItem("dmContacts",JSON.stringify(n))}else console.log("📇 Keine Kontakte im Netzwerk gefunden")}catch(t){console.error("❌ Fehler beim Laden der NIP-02 Kontakte:",t)}this.updateDMContactsList()}catch(e){console.error("❌ Fehler beim Laden der DM-Kontakte:",e)}}updateDMContactsList(){const e=this.element.querySelector("#dmContacts");e&&(e.innerHTML=this.renderDMContactsList())}subscribeToDirectMessages(){try{console.log("📡 Abonniere Direktnachrichten..."),this.nip04?(this.nip04.subscribeToEncryptedDMs(e=>{this.handleDirectMessage(e)}),console.log("✅ DM-Abonnement aktiviert")):console.warn("⚠️ NIP-04 nicht verfügbar für DM-Abonnement")}catch(e){console.error("❌ Fehler beim Abonnieren von Direktnachrichten:",e)}}switchTab(e){try{console.log(`🔄 Wechsle zu Tab: ${e}`),this.element.querySelectorAll(".tab-btn").forEach(i=>i.classList.remove("active"));const n=this.element.querySelector(`#${e}Tab`);n&&n.classList.add("active"),this.element.querySelectorAll(".tab-content").forEach(i=>i.classList.remove("active"));const o=this.element.querySelector(`#${e}Content`);o&&o.classList.add("active"),this.currentView=e==="rooms"?"room":"dm"}catch(t){console.error("❌ Fehler beim Wechseln des Tabs:",t)}}switchRoom(e){try{console.log(`🏠 Wechsle zu Raum: ${e}`),this.element.querySelectorAll(".room").forEach(o=>o.classList.remove("active"));const n=this.element.querySelector(`[data-room="${e}"]`);n&&n.classList.add("active"),this.currentRoom=e,this.currentView="room";const s=this.roomConfig[e];s&&this.updateChatHeader(s.name),this.loadRoomMessages(e)}catch(t){console.error("❌ Fehler beim Wechseln des Raums:",t)}}updateChatHeader(e){const t=this.element.querySelector("#chatTitle");t&&(t.textContent=e)}getStoredMessages(e){try{const t=localStorage.getItem(`messages_${e}`);return t?JSON.parse(t):[]}catch(t){return console.error("❌ Fehler beim Laden gespeicherter Nachrichten:",t),[]}}storeMessage(e,t){try{const n=this.getStoredMessages(t),s=e.id||`${e.timestamp}_${e.content}`;return n.some(i=>i.id&&i.id===s||i.timestamp===e.timestamp&&i.content===e.content)?(console.log("⚠️ Duplikat-Nachricht ignoriert:",s),!1):(n.push(e),n.length>100&&n.splice(0,n.length-100),localStorage.setItem(`messages_${t}`,JSON.stringify(n)),console.log("💾 Nachricht gespeichert:",s),!0)}catch(n){return console.error("❌ Fehler beim Speichern der Nachricht:",n),!1}}displayMessages(e){const t=this.element.querySelector("#messages");if(t){if(t.innerHTML="",e.length===0){t.innerHTML=`
                <div class="welcome">
                    <h3>Willkommen! 🎉</h3>
                    <p>Noch keine Nachrichten...</p>
                </div>
            `;return}e.forEach(n=>{this.displayMessage(n)})}}displayMessage(e){const t=this.element.querySelector("#messages");if(!t)return;const n=document.createElement("div");n.className="message",n.innerHTML=`
            <div class="message-header">
                <span class="message-author">${e.author||"Unknown"}</span>
                <span class="message-time">${new Date(e.timestamp).toLocaleTimeString()}</span>
            </div>
            <div class="message-content">${e.content}</div>
        `,t.appendChild(n),t.scrollTop=t.scrollHeight}setServices(e){this.services=e,e.nostrService&&(this.nostrService=e.nostrService),e.toastService&&(this.toastService=e.toastService),console.log("📦 Services an ChatComponentRefactored übergeben")}async loadRoomMessages(e){try{console.log(`📜 Lade Nachrichten für Raum: ${e}`);const t=this.getStoredMessages(e)||[];this.displayMessages(t)}catch(t){console.error("❌ Fehler beim Laden der Raum-Nachrichten:",t)}}subscribeToRoomMessages(){try{if(console.log("📡 Abonniere Raum-Nachrichten..."),this.unsubscribeFromCurrentRoom(),this.nip28){const e=this.nip28.subscribeToRoom(this.currentRoom,t=>{this.handleRoomMessage(t)});this.subscriptions.set("room_"+this.currentRoom,e),console.log("✅ Raum-Abonnement aktiviert für:",this.currentRoom)}else console.warn("⚠️ NIP-28 nicht verfügbar für Raum-Abonnement")}catch(e){console.error("❌ Fehler beim Abonnieren von Raum-Nachrichten:",e)}}unsubscribeFromCurrentRoom(){try{const e="room_"+this.currentRoom,t=this.subscriptions.get(e);t&&(this.nostrService.relayService.unsubscribe(t),this.subscriptions.delete(e),console.log("🔌 Raum-Abonnement beendet für:",this.currentRoom))}catch(e){console.error("❌ Fehler beim Beenden des Raum-Abonnements:",e)}}handleRoomMessage(e){if(console.log("📩 Neue Raum-Nachricht:",e),!this.storeMessage(e,e.roomId||this.currentRoom)){console.log("⚠️ Nachricht nicht angezeigt (Duplikat oder Fehler)");return}if(this.currentView==="room"&&this.currentRoom===(e.roomId||this.currentRoom)&&this.displayMessage(e),this.currentView!=="room"||this.currentRoom!==(e.roomId||this.currentRoom)){const n=this.roomConfig[e.roomId||this.currentRoom]?.name||"Unbekannter Raum";this.toastService.showInfo(`🏠 Neue Nachricht in ${n}`)}}subscribeToPrivateGroupMessages(){try{console.log("📡 Abonniere Private Group Messages..."),this.nip104&&this.nip104.subscribeToGroupInvites(e=>{console.log("📧 Neue Gruppeneinladung:",e),this.handleGroupInvitation(e)})}catch(e){console.error("❌ Fehler beim Abonnieren von Private Group Messages:",e)}}handleGroupInvitation(e){this.toastService.showSuccess(`Einladung zu Gruppe "${e.groupName}" erhalten`),this.updatePrivateGroupsList()}updatePrivateGroupsList(){try{const e=document.getElementById("privateGroupsList");if(!e)return;const t=this.nip104.getAllPrivateGroups();if(t.length===0){e.innerHTML=`
                    <div class="no-groups">
                        <p>🔒 Keine privaten Gruppen</p>
                        <small>Erstelle eine verschlüsselte Gruppe oder warte auf Einladungen</small>
                    </div>
                `;return}const n=t.map(s=>`
                <div class="private-group" data-group-id="${s.groupId}">
                    <div class="group-icon">🔐</div>
                    <div class="group-info">
                        <div class="group-name">${s.name}</div>
                        <div class="group-description">${s.description||"Keine Beschreibung"}</div>
                        <div class="group-meta">
                            <span class="member-count">${s.memberCount} Mitglieder</span>
                            ${s.isCreator?'<span class="creator-badge">Creator</span>':""}
                        </div>
                    </div>
                    <div class="group-actions">
                        <button class="btn btn-sm btn-primary" onclick="enterPrivateGroup('${s.groupId}')">
                            Betreten
                        </button>
                        ${s.isCreator?`
                            <button class="btn btn-sm btn-secondary" onclick="inviteToPrivateGroup('${s.groupId}')">
                                Einladen
                            </button>
                        `:""}
                        <button class="btn btn-sm btn-danger" onclick="leavePrivateGroup('${s.groupId}')">
                            Verlassen
                        </button>
                    </div>
                </div>
            `).join("");e.innerHTML=n}catch(e){console.error("❌ Fehler beim Aktualisieren der Gruppen-Liste:",e)}}async enterPrivateGroup(e){try{console.log(`🚪 Betrete private Gruppe: ${e}`);const t=this.nip104.getGroupInfo(e);if(!t){this.toastService.showError("Gruppe nicht gefunden");return}this.currentView="private_group",this.currentRoom=e,this.updateChatHeader(t.name),await this.loadPrivateGroupMessages(e),this.toastService.showSuccess(`Gruppe "${t.name}" betreten`)}catch(t){console.error("❌ Fehler beim Betreten der Gruppe:",t),this.toastService.showError("Fehler beim Betreten der Gruppe")}}async leavePrivateGroup(e){try{const n=this.nip104.getAllPrivateGroups().filter(s=>s.id!==e);localStorage.setItem("privateGroups",JSON.stringify(n)),this.updatePrivateGroupsList(),this.toastService.showSuccess("Gruppe verlassen")}catch(t){console.error("❌ Fehler beim Verlassen der Gruppe:",t),this.toastService.showError("Fehler beim Verlassen der Gruppe")}}async inviteToPrivateGroup(e){if(prompt("Geben Sie die npub oder hex pubkey des Benutzers ein:"))try{this.toastService.showSuccess("Einladung gesendet")}catch(n){console.error("❌ Fehler beim Senden der Einladung:",n),this.toastService.showError("Fehler beim Senden der Einladung")}}async loadPrivateGroupMessages(e){try{console.log(`📜 Lade Nachrichten für private Gruppe: ${e}`);const t=this.getStoredMessages(`private_group_${e}`)||[];this.displayMessages(t),this.nip104.subscribeToPrivateGroup(e,n=>{this.handlePrivateGroupMessage(n)})}catch(t){console.error("❌ Fehler beim Laden der Gruppennachrichten:",t)}}handlePrivateGroupMessage(e){console.log("📩 Neue private Gruppennachricht:",e),this.currentView==="private_group"&&this.currentRoom===e.groupId&&this.displayMessage(e),this.storeMessage(e,`private_group_${e.groupId}`)}}class zl{constructor(e,t){this.keyService=e,this.toastService=t,this.element=null,this.isVisible=!1}render(){return this.element=document.createElement("div"),this.element.className="modal-overlay",this.element.style.display="none",this.element.innerHTML=`
            <div class="modal">
                <div class="modal-header">
                    <h3>⚙️ Einstellungen</h3>
                    <button class="modal-close" id="closeModal">×</button>
                </div>
                <div class="modal-body">
                    <div class="settings-section">
                        <h4>🔑 Schlüssel-Verwaltung</h4>
                        <div class="key-info-display">
                            <div class="form-group">
                                <label>Öffentlicher Schlüssel:</label>
                                <div class="key-display" id="publicKeyDisplay">Lädt...</div>
                                <button class="btn btn-sm btn-secondary" id="copyPublicBtn">📋 Kopieren</button>
                            </div>
                            <div class="form-group">
                                <label>Privater Schlüssel:</label>
                                <div class="key-display" id="privateKeyDisplay">••••••••••••••••••••••••••••••••</div>
                                <button class="btn btn-sm btn-secondary" id="showPrivateBtn">👁️ Anzeigen</button>
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-secondary" id="exportBtn">💾 Exportieren</button>
                            <button class="btn btn-secondary" id="importBtn">📥 Importieren</button>
                            <button class="btn btn-danger" id="deleteBtn">🗑️ Schlüssel löschen</button>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h4>🎨 Darstellung</h4>
                        <div class="form-group">
                            <label>Theme:</label>
                            <select id="themeSelect">
                                <option value="light">Hell</option>
                                <option value="dark">Dunkel</option>
                                <option value="auto">Automatisch</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="cancelBtn">Abbrechen</button>
                    <button class="btn btn-primary" id="saveBtn">Speichern</button>
                </div>
            </div>
        `,this.setupEventListeners(),this.element}setupEventListeners(){const e=this.element.querySelector("#closeModal"),t=this.element.querySelector("#cancelBtn"),n=this.element.querySelector("#saveBtn"),s=this.element.querySelector("#copyPublicBtn"),o=this.element.querySelector("#showPrivateBtn"),i=this.element.querySelector("#exportBtn"),a=this.element.querySelector("#importBtn"),c=this.element.querySelector("#deleteBtn");e.addEventListener("click",()=>this.hide()),t.addEventListener("click",()=>this.hide()),this.element.addEventListener("click",l=>{l.target===this.element&&this.hide()}),n.addEventListener("click",()=>{const l=this.element.querySelector("#themeSelect").value;localStorage.setItem("theme",l),this.applyTheme(l),this.toastService.showSuccess("Einstellungen gespeichert"),this.hide()}),s.addEventListener("click",()=>{const l=this.element.querySelector("#publicKeyDisplay").textContent;navigator.clipboard.writeText(l).then(()=>{this.toastService.showSuccess("Öffentlicher Schlüssel kopiert")}).catch(()=>{this.toastService.showError("Fehler beim Kopieren")})}),o.addEventListener("click",()=>{this.togglePrivateKey()}),i.addEventListener("click",()=>{this.exportKeys()}),a.addEventListener("click",()=>{this.importKeys()}),c.addEventListener("click",()=>{this.deleteKeys()})}async show(){this.element.style.display="flex",setTimeout(()=>{this.element.classList.add("show")},10),this.isVisible=!0,await this.updateDisplay()}hide(){this.element.classList.remove("show"),setTimeout(()=>{this.element.style.display="none"},300),this.isVisible=!1}async updateDisplay(){try{const e=await this.keyService.getCurrentUser();if(e){const t=this.element.querySelector("#publicKeyDisplay");t.textContent=e.publicKey}}catch(e){console.error("❌ Fehler beim Laden der Benutzerdaten:",e)}}togglePrivateKey(){const e=this.element.querySelector("#privateKeyDisplay"),t=this.element.querySelector("#showPrivateBtn");e.textContent.includes("••••")?this.keyService.getCurrentUser().then(n=>{n&&(e.textContent=n.privateKey,t.textContent="🙈 Verstecken")}):(e.textContent="••••••••••••••••••••••••••••••••",t.textContent="👁️ Anzeigen")}exportKeys(){try{this.keyService.exportKeys().then(e=>{const t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download="nostr-keys.json",s.click(),URL.revokeObjectURL(n),this.toastService.showSuccess("Schlüssel exportiert")})}catch{this.toastService.showError("Fehler beim Exportieren")}}importKeys(){const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=t=>{const n=t.target.files[0];if(n){const s=new FileReader;s.onload=o=>{try{const i=JSON.parse(o.target.result);this.keyService.importKeys(i).then(()=>{this.toastService.showSuccess("Schlüssel importiert"),this.updateDisplay()})}catch{this.toastService.showError("Fehler beim Importieren")}},s.readAsText(n)}},e.click()}deleteKeys(){confirm("Sind Sie sicher, dass Sie alle Schlüssel löschen möchten? Diese Aktion kann nicht rückgängig gemacht werden.")&&this.keyService.deleteKeys().then(()=>{this.toastService.showSuccess("Schlüssel gelöscht"),this.hide(),location.reload()})}applyTheme(e){document.documentElement.setAttribute("data-theme",e)}}class Wl{constructor(e,t){this.relayService=e,this.toastService=t,this.element=null,this.isVisible=!1}render(){return this.element=document.createElement("div"),this.element.className="modal-overlay",this.element.innerHTML=`
            <div class="modal">
                <div class="modal-header">
                    <h3>🔗 Relay-Verwaltung</h3>
                    <button class="modal-close" id="closeModal">×</button>
                </div>
                <div class="modal-body">
                    <div class="relay-section">
                        <h4>📡 Aktive Relays</h4>
                        <div class="relay-list" id="relayList">
                            <!-- Relays werden hier geladen -->
                        </div>
                    </div>
                    
                    <div class="relay-section">
                        <h4>➕ Neuen Relay hinzufügen</h4>
                        <div class="form-group">
                            <input type="url" id="newRelayUrl" placeholder="wss://relay.example.com" />
                            <button class="btn btn-primary" id="addRelayBtn">Hinzufügen</button>
                        </div>
                    </div>
                    
                    <div class="relay-section">
                        <h4>📊 Relay-Statistiken</h4>
                        <div class="relay-stats" id="relayStats">
                            <div class="stat-item">
                                <span>Verbundene Relays:</span>
                                <span id="connectedCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Gesamt Relays:</span>
                                <span id="totalCount">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Durchschnittliche Latenz:</span>
                                <span id="avgLatency">0ms</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" id="testAllBtn">🔄 Alle testen</button>
                    <button class="btn btn-primary" id="closeBtn">Schließen</button>
                </div>
            </div>
        `,this.setupEventListeners(),this.element}setupEventListeners(){const e=this.element.querySelector("#closeModal"),t=this.element.querySelector("#closeBtn"),n=this.element.querySelector("#addRelayBtn"),s=this.element.querySelector("#testAllBtn"),o=this.element.querySelector("#newRelayUrl");e.addEventListener("click",()=>this.hide()),t.addEventListener("click",()=>this.hide()),this.element.addEventListener("click",i=>{i.target===this.element&&this.hide()}),n.addEventListener("click",()=>this.addRelay()),s.addEventListener("click",()=>this.testAllRelays()),o.addEventListener("keypress",i=>{i.key==="Enter"&&this.addRelay()})}show(){this.isVisible||(this.isVisible=!0,this.element.classList.add("active"),document.body.style.overflow="hidden",this.updateRelayList(),this.updateStats(),requestAnimationFrame(()=>{this.element.querySelector(".modal").style.transform="translateY(0)",this.element.querySelector(".modal").style.opacity="1"}))}hide(){this.isVisible&&(this.isVisible=!1,this.element.classList.remove("active"),document.body.style.overflow="",this.element.querySelector(".modal").style.transform="translateY(-20px)",this.element.querySelector(".modal").style.opacity="0",setTimeout(()=>{this.element.parentNode&&this.element.parentNode.removeChild(this.element)},300))}updateRelayList(){const e=this.element.querySelector("#relayList"),t=this.relayService.getRelays();if(t.length===0){e.innerHTML='<div class="empty-state">Keine Relays konfiguriert</div>';return}e.innerHTML=t.map(n=>`
            <div class="relay-item" data-url="${n.url}">
                <div class="relay-info">
                    <div class="relay-url">${n.url}</div>
                    <div class="relay-status ${n.connected?"connected":"disconnected"}">
                        ${n.connected?"🟢 Verbunden":"🔴 Getrennt"}
                    </div>
                </div>
                <div class="relay-actions">
                    <button class="btn btn-sm btn-secondary" onclick="this.closest('.relay-item').dispatchEvent(new CustomEvent('test-relay'))">
                        🔄 Testen
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="this.closest('.relay-item').dispatchEvent(new CustomEvent('remove-relay'))">
                        🗑️ Entfernen
                    </button>
                </div>
            </div>
        `).join(""),e.querySelectorAll(".relay-item").forEach(n=>{n.addEventListener("test-relay",()=>this.testRelay(n.dataset.url)),n.addEventListener("remove-relay",()=>this.removeRelay(n.dataset.url))})}updateStats(){const e=this.relayService.getRelays(),t=e.filter(o=>o.connected).length,n=e.length,s=e.reduce((o,i)=>o+(i.latency||0),0)/n||0;this.element.querySelector("#connectedCount").textContent=t,this.element.querySelector("#totalCount").textContent=n,this.element.querySelector("#avgLatency").textContent=`${Math.round(s)}ms`}addRelay(){const e=this.element.querySelector("#newRelayUrl"),t=e.value.trim();if(!t){this.toastService.showError("Bitte geben Sie eine Relay-URL ein");return}if(!t.startsWith("wss://")&&!t.startsWith("ws://")){this.toastService.showError("Relay-URL muss mit ws:// oder wss:// beginnen");return}try{this.relayService.addRelay(t),e.value="",this.updateRelayList(),this.updateStats(),this.toastService.showSuccess("Relay hinzugefügt")}catch{this.toastService.showError("Fehler beim Hinzufügen des Relays")}}removeRelay(e){confirm(`Sind Sie sicher, dass Sie den Relay ${e} entfernen möchten?`)&&(this.relayService.removeRelay(e),this.updateRelayList(),this.updateStats(),this.toastService.showSuccess("Relay entfernt"))}testRelay(e){this.toastService.showInfo("Teste Relay..."),this.relayService.testRelay(e).then(()=>{this.updateRelayList(),this.updateStats(),this.toastService.showSuccess("Relay-Test abgeschlossen")}).catch(()=>{this.toastService.showError("Relay-Test fehlgeschlagen")})}testAllRelays(){this.toastService.showInfo("Teste alle Relays..."),this.relayService.testAllRelays().then(()=>{this.updateRelayList(),this.updateStats(),this.toastService.showSuccess("Alle Relay-Tests abgeschlossen")}).catch(()=>{this.toastService.showError("Einige Relay-Tests fehlgeschlagen")})}}console.log("🚀 DreamMall NOSTR Client startet...");class Jl{constructor(){this.services={},this.components={},this.currentScreen="setup",this.isInitialized=!1}async init(){try{console.log("🔧 Erstelle Services..."),this.createServices(),console.log("🔧 Initialisiere Services..."),await this.initializeServices(),console.log("🎨 Erstelle UI-Komponenten..."),this.createComponents(),console.log("⚡ Richte Event-Listeners ein..."),this.setupEventListeners(),console.log("📱 Bestimme initialen Zustand..."),await this.determineInitialState(),this.isInitialized=!0,console.log("✅ App erfolgreich initialisiert!")}catch(e){console.error("❌ App-Initialisierung fehlgeschlagen:",e),this.services.toastService?.showError("Fehler beim Starten der App")}}createServices(){console.log("🏗️ Erstelle Services..."),this.services.toastService=new Kl,this.services.storageService=new Bl,this.services.keyService=new Tl(this.services.storageService,this.services.toastService),this.services.nostrService=new Ll,this.services.relayService=new Dl(De),console.log("✅ Services erstellt")}async initializeServices(){console.log("🔧 Initialisiere Services..."),this.services.nostrService.setServices(this.services),this.services.relayService.setServices(this.services),await this.services.keyService.init?.(),await this.services.relayService.init?.(),await this.initializeNIPs(),console.log("✅ Services initialisiert")}async initializeNIPs(){console.log("🔧 Initialisiere NOSTR NIPs..."),this.nips={nip01:new oo(this.services.nostrService),nip02:new io(this.services.nostrService,null),nip04:new ao(this.services.nostrService,null),nip17:new lo(this.services.nostrService,null),nip28:new co(this.services.nostrService,null),nip104:new ho(this.services.nostrService,null)},this.nips.nip02.nip01=this.nips.nip01,this.nips.nip04.nip01=this.nips.nip01,this.nips.nip17.nip01=this.nips.nip01,this.nips.nip28.nip01=this.nips.nip01,this.nips.nip104.nip01=this.nips.nip01,this.services.nostrService.nips=this.nips,console.log("✅ NIPs initialisiert:",Object.keys(this.nips))}createComponents(){const e=document.getElementById("app"),t=document.createElement("div");t.className="app",e.appendChild(t),this.components.header=new Hl,t.appendChild(this.components.header.render()),this.components.header.setServices(this.services);const n=document.createElement("div");n.id="mainContent",t.appendChild(n),this.components.setup=new Fl(this.services.keyService,this.services.toastService),this.components.chat=new jl(this.services.nostrService,this.services.toastService),this.components.chat.setServices&&this.components.chat.setServices(this.services),this.components.settingsModal=new zl(this.services.keyService,this.services.toastService),this.components.relayManager=new Wl(this.services.relayService,this.services.toastService),document.body.appendChild(this.components.settingsModal.render()),document.body.appendChild(this.components.relayManager.render()),window.relayManager=this.components.relayManager,console.log("✅ Komponenten erstellt")}setupEventListeners(){document.addEventListener("keysGenerated",e=>{console.log("🔑 Schlüssel generiert"),this.showScreen("chat")}),document.addEventListener("keysImported",e=>{console.log("📥 Schlüssel importiert"),this.showScreen("chat")}),document.addEventListener("keysDeleted",e=>{console.log("🗑️ Schlüssel gelöscht"),this.showScreen("setup")}),this.setupUIButtons(),console.log("✅ Event-Listeners eingerichtet")}setupUIButtons(){const e=document.getElementById("settingsBtn");e&&e.addEventListener("click",()=>{this.components.settingsModal.show()});const t=document.getElementById("profileBtn");t&&t.addEventListener("click",()=>{this.showUserProfile()})}addRelayButton(){const e=document.querySelector(".app-controls");if(e&&!document.getElementById("relayBtn")){const t=document.createElement("button");t.id="relayBtn",t.className="btn btn-secondary",t.innerHTML="🌐 Relays",t.addEventListener("click",()=>{this.components.relayManager.show()}),e.appendChild(t)}}async determineInitialState(){try{await this.services.keyService.hasKeys()?(console.log("🔑 Bestehende Schlüssel gefunden"),this.showScreen("chat")):(console.log("🆕 Keine Schlüssel gefunden, zeige Setup"),this.showScreen("setup"))}catch(e){console.error("❌ Fehler beim Bestimmen des initialen Zustands:",e),this.showScreen("setup")}}showScreen(e){const t=document.getElementById("mainContent");if(t){switch(t.innerHTML="",e==="chat"?(this.components.header.showControls(),this.components.header.updateStatus(!0)):(this.components.header.hideControls(),this.components.header.updateStatus(!1)),e){case"setup":t.appendChild(this.components.setup.render());break;case"chat":t.appendChild(this.components.chat.render()),this.initializeChat();break;default:console.warn("⚠️ Unbekannter Screen:",e),this.showScreen("setup")}this.currentScreen=e,console.log(`📱 Screen gewechselt zu: ${e}`)}}async initializeChat(){try{console.log("🚀 Beginne Chat-Initialisierung...");const e=await this.services.keyService.getCurrentUser();if(console.log("👤 Aktueller Benutzer:",e),!e)throw new Error("Kein aktueller Benutzer gefunden");console.log("🔧 Initialisiere NOSTR Service..."),await this.services.nostrService.init(e),console.log("🌐 Verbinde zu Relays..."),await this.services.relayService.connect(),await new Promise(n=>setTimeout(n,2e3));const t=this.services.relayService.getStatus();console.log("📊 Relay-Status:",t),this.components.header.updateStatus(t.connectedRelays>0),console.log("💬 Chat erfolgreich initialisiert!"),this.services.toastService.showSuccess("Mit NOSTR-Netzwerk verbunden!")}catch(e){console.error("❌ Chat-Initialisierung fehlgeschlagen:",e),this.services.toastService.showError("Fehler beim Verbinden mit NOSTR"),console.log("⚠️ Fahre trotz Fehler fort...")}}destroy(){Object.values(this.components).forEach(e=>{e.destroy?.()}),Object.values(this.services).forEach(e=>{e.destroy?.()}),console.log("🧹 App bereinigt")}}document.addEventListener("DOMContentLoaded",async()=>{console.log("📱 DOM geladen, starte App...");try{const r=new Jl;await r.init(),window.nostrApp=r,console.log("🎉 DreamMall NOSTR Client bereit!")}catch(r){console.error("💥 Kritischer Fehler beim Starten:",r);const e=document.getElementById("app");e&&(e.innerHTML=`
                <div class="app">
                    <div class="header">
                        <h1>❌ Fehler</h1>
                    </div>
                    <div class="setup">
                        <h2>Anwendung konnte nicht gestartet werden</h2>
                        <p>Bitte laden Sie die Seite neu oder überprüfen Sie die Konsole für Details.</p>
                        <button class="btn btn-primary" onclick="location.reload()">
                            🔄 Seite neu laden
                        </button>
                    </div>
                </div>
            `)}});window.addEventListener("error",r=>{console.error("🚨 Globaler Fehler:",r.error)});window.addEventListener("unhandledrejection",r=>{console.error("🚨 Unhandled Promise Rejection:",r.reason)});console.log("📋 App-Skript geladen");document.addEventListener("DOMContentLoaded",()=>{const r=document.createElement("button");r.textContent="🧪 Test Modulare Architektur",r.className="btn btn-primary",r.style.position="fixed",r.style.bottom="10px",r.style.right="10px",r.style.zIndex="9999",r.addEventListener("click",()=>{const e=new Rr;e.createForm({title:"✅ Modulare Architektur Test",fields:[{name:"testType",label:"Test-Typ",type:"select",options:[{value:"modal",text:"🪟 Modal-Komponente"},{value:"nip01",text:"📡 NIP-01 Protokoll"},{value:"room",text:"🏠 Raum-Management"}]},{name:"testData",label:"Test-Daten",type:"text",placeholder:"Eingabe für Test..."}],onSubmit:t=>{console.log("✅ Test-Daten:",t),setTimeout(()=>{e.alert({title:"🎉 Test erfolgreich!",message:`
                            <div style="text-align: left;">
                                <h4>Modulare Architektur funktioniert!</h4>
                                <p><strong>Test-Typ:</strong> ${t.testType}</p>
                                <p><strong>Test-Daten:</strong> ${t.testData}</p>
                                <hr>
                                <p><small>✅ Modal-Komponente: Funktioniert<br>
                                ✅ NIP-Module: Bereit<br>
                                ✅ UI-Komponenten: Aktiv<br>
                                ✅ Saubere Trennung: Implementiert</small></p>
                            </div>
                        `})},100)},submitText:"Test ausführen"})}),document.body.appendChild(r)});export{le as a,G as b,Tn as c,bn as r,Ue as s};
